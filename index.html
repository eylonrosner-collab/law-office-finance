<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×›×¡×¤×™× - ××©×¨×“ ×¢×•"×“</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 20px; }
        .input-field { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; transition: border-color 0.2s; box-sizing: border-box; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .tc { padding: 9px 12px; border-bottom: 1px solid #e5e7eb; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 1000; display: flex; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-box { background: white; border-radius: 16px; width: 100%; max-width: 1000px; margin: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .th { padding: 9px 12px; text-align: right; font-weight: 600; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; }
        .btn-icon { 
            background: none; 
            border: 1px solid #e5e7eb; 
            padding: 4px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-icon:hover { 
            background: #f3f4f6; 
            border-color: #d1d5db;
        }
        #loading { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            font-size: 1.5rem; 
            color: #667eea;
        }
    </style>
</head>
<body class="bg-gray-50">
<div id="loading">â³ ×˜×•×¢×Ÿ ××¢×¨×›×ª...</div>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

const APP_VERSION = "3.9";

const HISTORICAL = {
    "2021-01":65000,"2021-02":40000,"2021-03":100000,"2021-04":60000,
    "2021-05":50000,"2021-06":97000,"2021-07":50000,"2021-08":50000,
    "2021-09":50000,"2021-10":50000,"2021-11":110000,"2021-12":60000,
    "2022-01":50000,"2022-02":70000,"2022-03":100000,"2022-04":75000,
    "2022-05":100000,"2022-06":60000,"2022-07":45000,"2022-08":55000,
    "2022-09":85000,"2022-10":70000,"2022-11":65000,"2022-12":75000,
    "2023-01":85000,"2023-02":50000,"2023-03":80000,"2023-04":85000,
    "2023-05":80000,"2023-06":55000,"2023-07":80000,"2023-08":55000,
    "2023-09":90000,"2023-10":75000,"2023-11":70000,"2023-12":32000,
    "2024-01":60000,"2024-02":60000,"2024-03":85000,"2024-04":85000,
    "2024-05":40000,"2024-06":80000,"2024-07":50000,"2024-08":90000,
    "2024-09":50000,"2024-10":103000,"2024-11":55000,"2024-12":100000,
    "2025-01":55000,"2025-02":90000,"2025-03":65000,"2025-04":50000,
    "2025-05":75000,"2025-06":70000,"2025-07":60000,"2025-08":65000,
    "2025-09":50000,"2025-10":70000,"2025-11":80000,"2025-12":63000,
    "2026-01":50000,
};

const MONTHS = [
    {v:'01',l:'×™× ×•××¨'},{v:'02',l:'×¤×‘×¨×•××¨'},{v:'03',l:'××¨×¥'},{v:'04',l:'××¤×¨×™×œ'},
    {v:'05',l:'×××™'},{v:'06',l:'×™×•× ×™'},{v:'07',l:'×™×•×œ×™'},{v:'08',l:'××•×’×•×¡×˜'},
    {v:'09',l:'×¡×¤×˜××‘×¨'},{v:'10',l:'××•×§×˜×•×‘×¨'},{v:'11',l:'× ×•×‘××‘×¨'},{v:'12',l:'×“×¦××‘×¨'}
];
const YEARS = [2021,2022,2023,2024,2025,2026];

const fmt = (n) => {
    const num = parseFloat(n);
    if (!n || isNaN(num) || num === 0) return '-';
    return 'â‚ª' + num.toLocaleString('he-IL', {maximumFractionDigits:0});
};

const EMPTY = {
    billingHours:'', totalBillings:'', billingExpenses:'', retainerFee:0, retainerHours:'', workDays:'',
    incomeWithVAT:'', expensesWithVAT:'', vatToPay:'', actualVATPaid:'',
    openInvoices:'', avgDaysOverdue:'', profitDistribution:'', notes:'', transfers:[],
    sharonBilling:0, oritBilling:0, activeClients:0
};

function Modal({ title, subtitle, onClose, children }) {
    return (
        <div className="modal-overlay">
            <div className="modal-box">
                <div style={{background:'linear-gradient(135deg,#667eea,#764ba2)',borderRadius:'16px 16px 0 0',padding:'20px 24px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <div>
                        <h2 style={{color:'white',fontSize:'1.15rem',fontWeight:700,margin:0}}>{title}</h2>
                        {subtitle && <p style={{color:'rgba(255,255,255,0.8)',fontSize:'0.8rem',margin:'4px 0 0'}}>{subtitle}</p>}
                    </div>
                    <button onClick={onClose} style={{background:'rgba(255,255,255,0.2)',border:'none',color:'white',borderRadius:'50%',width:34,height:34,cursor:'pointer',fontSize:'1rem',fontWeight:'bold'}}>âœ•</button>
                </div>
                <div style={{padding:'24px'}}>{children}</div>
            </div>
        </div>
    );
}

function TransferModal({ monthLabel, profitDistribution, existingTransfer, onSave, onClose, sharonExpenses, oritExpenses }) {
    console.log('=== TransferModal Received Props ===');
    console.log('sharonExpenses:', sharonExpenses);
    console.log('oritExpenses:', oritExpenses);
    console.log('existingTransfer:', existingTransfer);
    
    const [form, setForm] = useState({
        partner: existingTransfer?.partner || 'sharon',
        profitAmount: existingTransfer?.profitAmount ?? profitDistribution ?? '',
        expensesAmount: existingTransfer?.expensesAmount || '',
        transferDate: existingTransfer?.transferDate || '',
        referenceNumber: existingTransfer?.referenceNumber || '',
        transferredBy: existingTransfer?.transferredBy || '',
        notes: existingTransfer?.notes || '',
    });
    const sf = (k) => (e) => setForm(p => ({...p, [k]: e.target.value}));
    const total = parseFloat(form.profitAmount||0) + parseFloat(form.expensesAmount||0);

    // when partner changes, auto-fill expenses default
    const handlePartnerChange = (val) => {
        const expDefault = val === 'sharon'
            ? (sharonExpenses > 0 ? String(Math.round(sharonExpenses*100)/100) : (existingTransfer?.expensesAmount||''))
            : (oritExpenses > 0 ? String(Math.round(oritExpenses*100)/100) : (existingTransfer?.expensesAmount||''));
        setForm(p => ({...p, partner: val, expensesAmount: expDefault}));
    };

    // init expenses on mount based on initial partner
    useEffect(() => {
        if (!existingTransfer) {
            const expDefault = form.partner === 'sharon'
                ? (sharonExpenses > 0 ? String(Math.round(sharonExpenses*100)/100) : '')
                : (oritExpenses > 0 ? String(Math.round(oritExpenses*100)/100) : '');
            if (expDefault) setForm(p => ({...p, expensesAmount: expDefault}));
        }
    }, []);

    return (
        <Modal title="ğŸ“‹ ×ª×™×¢×•×“ ×”×¢×‘×¨×” ×‘× ×§××™×ª" subtitle={monthLabel} onClose={onClose}>
            <div style={{marginBottom:16}}>
                <label style={{display:'block',fontWeight:600,fontSize:'0.82rem',color:'#374151',marginBottom:8}}>×©×•×ª×¤×”</label>
                <div style={{display:'flex',gap:10}}>
                    {[['sharon','×©×¨×•×Ÿ'],['orit','××•×¨×™×ª']].map(([val,lbl])=>(
                        <button key={val} onClick={()=>handlePartnerChange(val)}
                            style={{flex:1,padding:'10px',borderRadius:8,border:'2px solid',
                                borderColor:form.partner===val?'#667eea':'#e5e7eb',
                                background:form.partner===val?'#ede9fe':'white',
                                color:form.partner===val?'#5b21b6':'#6b7280',
                                fontWeight:600,cursor:'pointer',fontSize:'0.95rem'}}>
                            ğŸ‘©â€âš–ï¸ {lbl}
                            {val==='sharon' && sharonExpenses>0 && <span style={{display:'block',fontSize:'0.72rem',color:'#6d28d9',marginTop:2}}>×”×•×¦××•×ª: â‚ª{Math.round(sharonExpenses).toLocaleString()}</span>}
                            {val==='orit'   && oritExpenses>0   && <span style={{display:'block',fontSize:'0.72rem',color:'#6d28d9',marginTop:2}}>×”×•×¦××•×ª: â‚ª{Math.round(oritExpenses).toLocaleString()}</span>}
                        </button>
                    ))}
                </div>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14,marginBottom:14}}>
                <div>
                    <label style={{display:'block',fontWeight:600,fontSize:'0.82rem',color:'#374151',marginBottom:5}}>×—×œ×•×§×ª ×¨×•×•×— (â‚ª)</label>
                    <input type="number" className="input-field" style={{background:'#f0fdf4'}} value={form.profitAmount} onChange={sf('profitAmount')} placeholder="0"/>
                </div>
                <div>
                    <label style={{display:'block',fontWeight:600,fontSize:'0.82rem',color:'#374151',marginBottom:5}}>×”×—×–×¨ ×”×•×¦××•×ª (â‚ª)</label>
                    <input type="number" className="input-field" style={{background:'#eff6ff'}} value={form.expensesAmount} onChange={sf('expensesAmount')} placeholder="0"/>
                </div>
                <div>
                    <label style={{display:'block',fontWeight:600,fontSize:'0.82rem',color:'#374151',marginBottom:5}}>×ª××¨×™×š ×”×¢×‘×¨×” (DD/MM/YYYY)</label>
                    <input type="date" className="input-field"
                        value={form.transferDate ? form.transferDate.split('/').reverse().join('-') : ''}
                        onChange={e => {
                            const [y,m,d] = e.target.value.split('-');
                            sf('transferDate')({target:{value: e.target.value ? `${d}/${m}/${y}` : ''}});
                        }}
                    />
                    {form.transferDate && <div style={{fontSize:'0.78rem',color:'#6b7280',marginTop:3}}>{form.transferDate}</div>}
                </div>
                <div>
                    <label style={{display:'block',fontWeight:600,fontSize:'0.82rem',color:'#374151',marginBottom:5}}>××¡×¤×¨ ××¡××›×ª×</label>
                    <input type="text" className="input-field" value={form.referenceNumber} onChange={sf('referenceNumber')} placeholder="××¡×¤×¨ ××¡××›×ª×"/>
                </div>
                <div style={{gridColumn:'1/-1'}}>
                    <label style={{display:'block',fontWeight:600,fontSize:'0.82rem',color:'#374151',marginBottom:5}}>×©× ×”××¢×‘×™×¨</label>
                    <input type="text" className="input-field" value={form.transferredBy} onChange={sf('transferredBy')} placeholder="×©× ××œ×"/>
                </div>
            </div>

            {(form.profitAmount || form.expensesAmount) && (
                <div style={{background:'linear-gradient(135deg,#f0fdf4,#dcfce7)',border:'1px solid #86efac',borderRadius:10,padding:14,marginBottom:14}}>
                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:5,fontSize:'0.9rem'}}><span>×—×œ×•×§×ª ×¨×•×•×—:</span><b>â‚ª{parseFloat(form.profitAmount||0).toLocaleString()}</b></div>
                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:8,fontSize:'0.9rem'}}><span>×”×—×–×¨ ×”×•×¦××•×ª:</span><b>â‚ª{parseFloat(form.expensesAmount||0).toLocaleString()}</b></div>
                    <div style={{borderTop:'1px solid #86efac',paddingTop:8,display:'flex',justifyContent:'space-between'}}>
                        <b style={{color:'#166534'}}>×¡×”"×› ×œ×”×¢×‘×¨×”:</b>
                        <b style={{color:'#166534',fontSize:'1.05rem'}}>â‚ª{total.toLocaleString()}</b>
                    </div>
                </div>
            )}

            <div style={{marginBottom:20}}>
                <label style={{display:'block',fontWeight:600,fontSize:'0.82rem',color:'#374151',marginBottom:5}}>×”×¢×¨×•×ª</label>
                <textarea className="input-field" rows="2" value={form.notes} onChange={sf('notes')} placeholder="×”×¢×¨×•×ª..." style={{resize:'vertical'}}/>
            </div>
            <div style={{display:'flex',gap:10,justifyContent:'flex-end'}}>
                <button onClick={onClose} style={{padding:'10px 22px',borderRadius:8,border:'1px solid #d1d5db',background:'white',color:'#374151',cursor:'pointer',fontWeight:600}}>×‘×™×˜×•×œ</button>
                <button onClick={()=>onSave({...form, total, savedAt:new Date().toLocaleString('he-IL')})}
                    style={{padding:'10px 26px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#667eea,#764ba2)',color:'white',cursor:'pointer',fontWeight:700}}>
                    ğŸ’¾ ×©××•×¨ ×ª×™×¢×•×“
                </button>
            </div>
        </Modal>
    );
}

function AllTransfersModal({ monthlyData, onClose, onEdit, onDelete, selectedYear }) {
    const all = [];
    for (const [key, data] of Object.entries(monthlyData)) {
        (data.transfers||[]).forEach((t, idx) => {
            const [yr,mo] = key.split('-');
            all.push({...t, key, yr, mo, ml: MONTHS.find(m=>m.v===mo)?.l||mo, transferIndex: idx});
        });
    }
    
    // ×¡×™× ×•×Ÿ ×œ×¤×™ ×©× ×” × ×‘×—×¨×ª
    const filteredByYear = selectedYear ? all.filter(t => parseInt(t.yr) === selectedYear) : all;
    
    filteredByYear.sort((a,b)=>(b.transferDate||b.savedAt||'').localeCompare(a.transferDate||a.savedAt||''));
    const totProfit = filteredByYear.reduce((s,t)=>s+parseFloat(t.profitAmount||0),0);
    const totExp = filteredByYear.reduce((s,t)=>s+parseFloat(t.expensesAmount||0),0);
    const totAll = filteredByYear.reduce((s,t)=>s+parseFloat(t.total||0),0);

    const handleDelete = (transfer) => {
        if (window.confirm(`×”×× ×œ××—×•×§ ×”×¢×‘×¨×” ×©×œ ${transfer.partner==='sharon'?'×©×¨×•×Ÿ':'××•×¨×™×ª'} ××—×•×“×© ${transfer.ml} ${transfer.yr}?`)) {
            onDelete(transfer.key, transfer.transferIndex);
        }
    };
    
    const exportToExcel = () => {
        const ws_data = [
            ['×“×•×— ×”×¢×‘×¨×•×ª ' + (selectedYear || '×›×œ ×”×©× ×™×')],
            ['×ª××¨×™×š ×”×¤×§×”: ' + new Date().toLocaleDateString('he-IL')],
            [],
            ['×—×•×“×©', '×©×•×ª×¤×”', '×ª×™××•×¨', '×¨×•×•×—', '×”×•×¦××•×ª', '×¡×”"×›', '×ª××¨×™×š', '××¡××›×ª×', '××¢×‘×™×¨'],
            ...filteredByYear.map(t => [
                `${t.ml} ${t.yr}`,
                t.partner === 'sharon' ? '×©×¨×•×Ÿ' : '××•×¨×™×ª',
                t.description || '-',
                parseFloat(t.profitAmount||0),
                parseFloat(t.expensesAmount||0),
                parseFloat(t.total||0),
                t.transferDate || '-',
                t.referenceNumber || '-',
                t.transferredBy || '-'
            ]),
            [],
            ['×¡×”"×›', '', '', totProfit, totExp, totAll, '', '', '']
        ];
        
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '×”×¢×‘×¨×•×ª');
        XLSX.writeFile(wb, `×”×¢×‘×¨×•×ª-${selectedYear || '×›×•×œ×Ÿ'}-${new Date().getTime()}.xlsx`);
    };

    return (
        <Modal 
            title={`ğŸ“‚ ×›×œ ×”×”×¢×‘×¨×•×ª ${selectedYear ? `×œ×©× ×ª ${selectedYear}` : ''}`} 
            subtitle={`${filteredByYear.length} ×¨×©×•××•×ª`} 
            onClose={onClose}
        >
            <div style={{marginBottom: 16}}>
                <button
                    onClick={exportToExcel}
                    style={{
                        padding: '10px 20px',
                        borderRadius: 6,
                        border: 'none',
                        background: '#16a34a',
                        color: 'white',
                        fontWeight: 600,
                        cursor: 'pointer',
                        fontSize: '0.9rem',
                        display: 'flex',
                        alignItems: 'center',
                        gap: 8
                    }}
                >
                    ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ
                </button>
            </div>
            {filteredByYear.length === 0 ? (
                <p style={{textAlign:'center',color:'#9ca3af',padding:'30px 0'}}>
                    ××™×Ÿ ×”×¢×‘×¨×•×ª ××ª×•×¢×“×•×ª {selectedYear ? `×œ×©× ×ª ${selectedYear}` : '×¢×“×™×™×Ÿ'}
                </p>
            ) : (
                <div style={{overflowX:'auto'}}>
                    <table style={{width:'100%',borderCollapse:'collapse',fontSize:'0.82rem'}}>
                        <thead>
                            <tr>
                                {['×—×•×“×©','×©×•×ª×¤×”','×ª×™××•×¨','×¨×•×•×—','×”×•×¦××•×ª','×¡×”"×›','×ª××¨×™×š','××¡××›×ª×','××¢×‘×™×¨','×¤×¢×•×œ×•×ª'].map(h=>(
                                    <th key={h} className="th" style={{whiteSpace:'nowrap'}}>{h}</th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {filteredByYear.map((t,i)=>(
                                <tr key={i} style={{background:i%2===0?'white':'#f9fafb',borderBottom:'1px solid #e5e7eb'}}>
                                    <td className="tc" style={{whiteSpace:'nowrap',fontWeight:500}}>{t.ml} {t.yr}</td>
                                    <td className="tc">{t.partner==='sharon'?'×©×¨×•×Ÿ':'××•×¨×™×ª'}</td>
                                    <td className="tc" style={{maxWidth:200,overflow:'hidden',textOverflow:'ellipsis'}}>{t.description||'-'}</td>
                                    <td className="tc" style={{color:'#166534'}}>{fmt(t.profitAmount)}</td>
                                    <td className="tc" style={{color:'#1d4ed8'}}>{fmt(t.expensesAmount)}</td>
                                    <td className="tc" style={{fontWeight:700}}>{fmt(t.total)}</td>
                                    <td className="tc" style={{whiteSpace:'nowrap'}}>{t.transferDate||'-'}</td>
                                    <td className="tc">{t.referenceNumber||'-'}</td>
                                    <td className="tc">{t.transferredBy||'-'}</td>
                                    <td className="tc" style={{whiteSpace:'nowrap'}}>
                                        <button 
                                            onClick={() => onEdit(t)}
                                            className="btn-icon"
                                            title="×¢×¨×™×›×”"
                                            style={{marginLeft:4}}
                                        >
                                            âœï¸
                                        </button>
                                        <button 
                                            onClick={() => handleDelete(t)}
                                            className="btn-icon"
                                            title="××—×™×§×”"
                                        >
                                            ğŸ—‘ï¸
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                        <tfoot>
                            <tr style={{background:'#ede9fe',borderTop:'2px solid #c4b5fd',fontWeight:700}}>
                                <td className="tc" colSpan={3}>×¡×”"×›</td>
                                <td className="tc" style={{color:'#166534'}}>â‚ª{totProfit.toLocaleString()}</td>
                                <td className="tc" style={{color:'#1d4ed8'}}>â‚ª{totExp.toLocaleString()}</td>
                                <td className="tc" style={{color:'#5b21b6'}}>â‚ª{totAll.toLocaleString()}</td>
                                <td className="tc" colSpan={4}></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            )}
        </Modal>
    );
}

function ExpensesModal({ importedExpenses, odcanitExpenses, savedExpenseRefunds, onClose, onUpdateExpenses }) {
    const { useState } = React;
    
    // DEBUG: ×”×¦×’ ××” ×™×© ×‘× ×ª×•× ×™×
    console.log('=== ExpensesModal DEBUG ===');
    console.log('importedExpenses:', importedExpenses);
    console.log('odcanitExpenses:', odcanitExpenses);
    console.log('savedExpenseRefunds:', savedExpenseRefunds);
    console.log('importedExpenses.length:', importedExpenses.length);
    console.log('odcanitExpenses.length:', odcanitExpenses.length);
    
    if (odcanitExpenses.length > 0) {
        console.log('First odcanit expense:', odcanitExpenses[0]);
        console.log('First odcanit expense stringified:', JSON.stringify(odcanitExpenses[0], null, 2));
    }
    
    // ×©×™×œ×•×‘ ×”×•×¦××•×ª ××¢×•×“×›× ×™×ª ×•×××§×¡×œ
    // ×”×•×¦××•×ª ××¢×•×“×›× ×™×ª: {date, description, amount, Category, ACTID}
    // ×”×•×¦××•×ª ×××§×¡×œ: {id, date, registeredBy, client, description, item, amount, checkedSharon, checkedOrit}
    
    const allExpenses = [
        // ×”×•×¦××•×ª ××¢×•×“×›× ×™×ª - × ×•×¡×™×£ ×œ×”×Ÿ id ×™×™×—×•×“×™
        ...odcanitExpenses.map((exp, idx) => ({
            id: `odcanit_${idx}`,
            date: exp.date,
            registeredBy: exp.registeredBy || '-',
            description: exp.description || '-',
            billingDescription: exp.billingDescription || '-',
            amount: parseFloat(exp.amount || 0),
            source: 'odcanit',
            checkedSharon: false,
            checkedOrit: false
        })),
        // ×”×•×¦××•×ª ×××§×¡×œ
        ...importedExpenses.map(exp => ({
            ...exp,
            billingDescription: exp.description || '-',
            source: 'excel'
        }))
    ];
    
    console.log('allExpenses:', allExpenses);
    console.log('allExpenses.length:', allExpenses.length);
    if (allExpenses.length > 0) {
        console.log('First expense in allExpenses:', allExpenses[0]);
        console.log('All expenses stringified:', JSON.stringify(allExpenses, null, 2));
    }
    
    // State ×œ× ×™×”×•×œ ×©×™×•×š ×”×”×•×¦××•×ª ×•×¡×™××•×Ÿ ×œ×—×–×¨
    const [expenseRefunds, setExpenseRefunds] = useState(() => {
        // × ×©×ª××© ×‘-id ×©×œ ×›×œ ×”×•×¦××” ×›××¤×ª×—
        return allExpenses.reduce((acc, exp) => {
            // ×× ×™×© ××¦×‘ ×©××•×¨ - ×”×©×ª××© ×‘×•, ××—×¨×ª ××ª×—×œ ××—×“×©
            if (savedExpenseRefunds[exp.id]) {
                acc[exp.id] = savedExpenseRefunds[exp.id];
            } else {
                acc[exp.id] = {
                    refund: false, // ×”×× ×œ×‘×¦×¢ ×”×—×–×¨
                    partner: exp.checkedSharon ? 'sharon' : (exp.checkedOrit ? 'orit' : 'none') // ×œ××™×–×• ×©×•×ª×¤×”
                };
            }
            return acc;
        }, {});
    });

    const toggleRefund = (id) => {
        setExpenseRefunds(prev => {
            const expense = allExpenses.find(e => e.id === id);
            const isRefund = !prev[id].refund;
            
            // ×©×™×•×š ××•×˜×•××˜×™ ×œ×¤×™ ××™ ×©×¨×©× ××ª ×”×—×™×•×‘
            let partner = 'none';
            if (isRefund && expense) {
                const registeredBy = (expense.registeredBy || '').toLowerCase();
                if (registeredBy.includes('×©×¨×•×Ÿ')) {
                    partner = 'sharon';
                } else if (registeredBy.includes('××•×¨×™×ª')) {
                    partner = 'orit';
                }
            }
            
            return {
                ...prev,
                [id]: { 
                    ...prev[id], 
                    refund: isRefund,
                    partner: partner
                }
            };
        });
    };

    const handleSave = () => {
        // ×—×™×©×•×‘ ×¡×›×•××™ ×”×”×•×¦××•×ª ×œ×›×œ ×©×•×ª×¤×” - ×¨×§ ××œ×• ×©××¡×•×× ×™× ×œ×”×—×–×¨
        const sharonExpenses = allExpenses.reduce((sum, exp) => {
            const refund = expenseRefunds[exp.id];
            return refund?.refund && refund?.partner === 'sharon' ? sum + exp.amount : sum;
        }, 0);
        
        const oritExpenses = allExpenses.reduce((sum, exp) => {
            const refund = expenseRefunds[exp.id];
            return refund?.refund && refund?.partner === 'orit' ? sum + exp.amount : sum;
        }, 0);

        onUpdateExpenses({
            expenseRefunds,
            sharonExpenses,
            oritExpenses
        });
        onClose();
    };

    const fmt = n => 'â‚ª' + Math.round(n).toLocaleString('he-IL');

    const sharonTotal = allExpenses.reduce((sum, exp) => {
        const refund = expenseRefunds[exp.id];
        return refund?.refund && refund?.partner === 'sharon' ? sum + exp.amount : sum;
    }, 0);
    
    const oritTotal = allExpenses.reduce((sum, exp) => {
        const refund = expenseRefunds[exp.id];
        return refund?.refund && refund?.partner === 'orit' ? sum + exp.amount : sum;
    }, 0);
    
    const totalRefunds = sharonTotal + oritTotal;
    const totalExpenses = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);

    return (
        <Modal title="ğŸ’° ×¤×™×¨×•×˜ ×”×•×¦××•×ª ×•×”×—×–×¨×™×" subtitle={`${allExpenses.length} ×—×™×•×‘×™ ×”×•×¦××” (${odcanitExpenses.length} ××¢×•×“×›× ×™×ª, ${importedExpenses.length} ×××§×¡×œ)`} onClose={onClose}>
            <div style={{marginBottom:16}}>
                <p style={{fontSize:'0.85rem',color:'#6b7280',marginBottom:12}}>
                    ×¡××Ÿ ×”×—×–×¨ ×¢×‘×•×¨ ×”×”×•×¦××•×ª ×©×™×© ×œ×”×—×–×™×¨, ×•×©×™×™×š ×œ×©×•×ª×¤×”. ×”×¡×›×•××™× ×™×ª××œ××• ××•×˜×•××˜×™×ª ×‘×˜×•×¤×¡ ×”×”×¢×‘×¨×”.
                </p>
                
                {/* ×¡×™×›×•× */}
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:12,marginBottom:16,padding:12,background:'#f9fafb',borderRadius:8}}>
                    <div>
                        <div style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:4}}>×¡×”"×› ×”×•×¦××•×ª</div>
                        <div style={{fontSize:'1.1rem',fontWeight:700,color:'#6b7280'}}>{fmt(totalExpenses)}</div>
                    </div>
                    <div>
                        <div style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:4}}>×©×¨×•×Ÿ - ×”×—×–×¨</div>
                        <div style={{fontSize:'1.1rem',fontWeight:700,color:'#059669'}}>{fmt(sharonTotal)}</div>
                    </div>
                    <div>
                        <div style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:4}}>××•×¨×™×ª - ×”×—×–×¨</div>
                        <div style={{fontSize:'1.1rem',fontWeight:700,color:'#7c3aed'}}>{fmt(oritTotal)}</div>
                    </div>
                    <div>
                        <div style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:4}}>×¡×”"×› ×”×—×–×¨×™×</div>
                        <div style={{fontSize:'1.1rem',fontWeight:700,color:'#1e40af'}}>{fmt(totalRefunds)}</div>
                    </div>
                </div>
            </div>

            {allExpenses.length === 0 ? (
                <div style={{textAlign:'center',padding:'40px 20px'}}>
                    <div style={{fontSize:'3rem',marginBottom:16}}>ğŸ“­</div>
                    <p style={{color:'#6b7280',fontSize:'0.95rem',marginBottom:8,fontWeight:600}}>××™×Ÿ ×—×™×•×‘×™ ×”×•×¦××”</p>
                    <p style={{color:'#9ca3af',fontSize:'0.82rem',marginBottom:16}}>
                        ×—×™×•×‘×™ ×”×•×¦××” ×™×•×¤×™×¢×• ×›××Ÿ ×œ××—×¨ ×™×™×‘×•× ××¢×•×“×›× ×™×ª ××• ×§×•×‘×¥ ×—×™×•×‘×™× ×××§×¡×œ
                    </p>
                </div>
            ) : (
                <div style={{overflowX:'auto',maxHeight:'400px',overflowY:'auto'}}>
                    <table style={{width:'100%',borderCollapse:'collapse',fontSize:'0.82rem'}}>
                        <thead style={{position:'sticky',top:0,background:'white',zIndex:1}}>
                            <tr>
                                {['××§×•×¨','×”×—×–×¨?','×ª××¨×™×š','× ×¨×©× ×¢"×™','×¡×•×’','×ª×™××•×¨ ×—×™×•×‘','×¡×›×•×'].map(h=>(
                                    <th key={h} className="th" style={{whiteSpace:'nowrap'}}>{h}</th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {allExpenses.map((exp) => {
                                const refund = expenseRefunds[exp.id] || { refund: false, partner: 'none' };
                                return (
                                    <tr key={exp.id} style={{
                                        background: refund.refund 
                                            ? (refund.partner === 'sharon' ? '#d1fae5' : refund.partner === 'orit' ? '#ede9fe' : '#fef3c7')
                                            : (String(exp.id).includes('odcanit') ? '#e0f2fe' : (exp.id % 2 === 0 ? 'white' : '#f9fafb')),
                                        borderBottom:'1px solid #e5e7eb'
                                    }}>
                                        <td className="tc" style={{fontSize:'0.7rem',color:'#6b7280'}}>
                                            {exp.source === 'odcanit' ? 'ğŸ”„' : 'ğŸ“Š'}
                                        </td>
                                        <td className="tc">
                                            <input 
                                                type="checkbox"
                                                checked={refund.refund}
                                                onChange={() => toggleRefund(exp.id)}
                                                style={{width:16,height:16,cursor:'pointer'}}
                                            />
                                        </td>
                                        <td className="tc" style={{whiteSpace:'nowrap',fontSize:'0.75rem'}}>{exp.date || '-'}</td>
                                        <td className="tc" style={{fontSize:'0.75rem',fontWeight:500}}>{exp.registeredBy || '-'}</td>
                                        <td className="tc" style={{fontSize:'0.75rem',fontWeight:600,color:'#1e40af'}}>{exp.description || '-'}</td>
                                        <td className="tc" style={{textAlign:'right',paddingRight:8,fontSize:'0.75rem'}}>{exp.billingDescription || '-'}</td>
                                        <td className="tc" style={{fontWeight:600,color:'#dc2626'}}>{fmt(exp.amount)}</td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            )}

            <div style={{marginTop:16,display:'flex',gap:12,justifyContent:'space-between',alignItems:'center'}}>
                <button 
                    onClick={() => {
                        const debugData = {
                            odcanitExpenses,
                            importedExpenses,
                            allExpenses,
                            odcanitCount: odcanitExpenses.length,
                            excelCount: importedExpenses.length,
                            totalCount: allExpenses.length
                        };
                        console.log('=== DEBUG DATA ===');
                        console.log(JSON.stringify(debugData, null, 2));
                        alert('× ×ª×•× ×™ Debug × ×©×œ×—×• ×œ-Console. ×œ×—×¥ F12 ×•×‘×—×¨ Console ×›×“×™ ×œ×¨××•×ª.');
                    }}
                    style={{padding:'8px 16px',borderRadius:6,border:'1px solid #94a3b8',background:'#f1f5f9',color:'#475569',fontSize:'0.8rem',cursor:'pointer'}}
                >
                    ğŸ› Debug Console
                </button>
                <div style={{display:'flex',gap:12}}>
                    <button 
                        onClick={onClose}
                        style={{padding:'10px 20px',borderRadius:6,border:'1px solid #d1d5db',background:'white',color:'#374151',fontWeight:600,cursor:'pointer'}}
                    >
                        ×‘×™×˜×•×œ
                    </button>
                    <button 
                        onClick={handleSave}
                        style={{padding:'10px 20px',borderRadius:6,border:'none',background:'#3b82f6',color:'white',fontWeight:600,cursor:'pointer'}}
                    >
                        ×©××•×¨ ×•×¢×“×›×Ÿ ×”×¢×‘×¨×”
                    </button>
                </div>
            </div>
        </Modal>
    );
}

function ReportsModal({ data, avgVAT, onClose }) {
    const { useEffect, useRef, useState } = React;
    const [activeTab, setActiveTab] = useState('annual');
    const [selPartnerYear, setSelPartnerYear] = useState(new Date().getFullYear());
    const [retainerSplitMethod, setRetainerSplitMethod] = useState('equal'); // 'hours' or 'equal'
    const canvasAnnual = useRef(null);
    const canvasMulti  = useRef(null);

    const COLORS = ['#6366f1','#22c55e','#f59e0b','#ef4444','#8b5cf6','#06b6d4'];
    const fmtN = n => n > 0 ? 'â‚ª' + Math.round(n).toLocaleString('he-IL') : '-';
    const fmtK = n => n > 0 ? 'â‚ª' + Math.round(n/1000) + 'K' : '-';

    // â”€â”€ × ×ª×•× ×™ ×—×œ×•×§×ª ×¨×•×•×—×™× â”€â”€
    const annualData = YEARS.map((y,yi) => ({
        year: y,
        color: COLORS[yi],
        months: MONTHS.map(m => parseFloat(data[`${y}-${m.v}`]?.profitDistribution || 0)),
        total:  MONTHS.reduce((s,m) => s + parseFloat(data[`${y}-${m.v}`]?.profitDistribution || 0), 0),
    }));

    // â”€â”€ ×’×¨×£ 1: ×¢××•×“×•×ª ××§×•×‘×¦×•×ª ×œ×¤×™ ×—×•×“×©, ×¦×‘×¢ = ×©× ×” â”€â”€
    useEffect(() => {
        if (activeTab !== 'annual') return;
        const canvas = canvasAnnual.current; if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        const pad = { top:36, right:16, bottom:56, left:64 };
        const cW = W - pad.left - pad.right, cH = H - pad.top - pad.bottom;
        ctx.clearRect(0, 0, W, H);

        const maxVal = Math.max(...annualData.flatMap(y => y.months), 1);
        const groupW = cW / 12;
        const barW   = (groupW * 0.9) / YEARS.length;

        // grid
        for (let i = 0; i <= 4; i++) {
            const y = pad.top + (cH/4)*i;
            ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left+cW, y); ctx.stroke();
            ctx.fillStyle = '#9ca3af'; ctx.font = '10px Arial'; ctx.textAlign = 'right';
            ctx.fillText(fmtK(maxVal*(1-i/4)), pad.left-5, y+4);
        }

        // bars
        MONTHS.forEach((m, mi) => {
            const gx = pad.left + mi*groupW + groupW*0.05;
            YEARS.forEach((yr, yi) => {
                const val = annualData[yi].months[mi];
                if (!val) return;
                const x = gx + yi*barW;
                const bH = (val/maxVal)*cH;
                ctx.fillStyle = COLORS[yi] + 'dd';
                ctx.beginPath();
                if (ctx.roundRect) ctx.roundRect(x, pad.top+cH-bH, barW-1, bH, [2,2,0,0]);
                else ctx.rect(x, pad.top+cH-bH, barW-1, bH);
                ctx.fill();
            });
            // month label
            ctx.fillStyle = '#6b7280'; ctx.font = '10px Arial'; ctx.textAlign = 'center';
            ctx.fillText(m.l.slice(0,3), pad.left + mi*groupW + groupW/2, pad.top+cH+14);
        });

        // legend
        YEARS.forEach((yr, yi) => {
            const lx = pad.left + yi*(cW/YEARS.length) + (cW/YEARS.length)/2;
            ctx.fillStyle = COLORS[yi];
            ctx.fillRect(lx - 14, H-20, 10, 10);
            ctx.fillStyle = '#374151'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'left';
            ctx.fillText(yr, lx, H-12);
        });
    }, [activeTab, data]);

    const [selMetric, setSelMetric] = useState('profitDistribution');
    const [hoveredYear, setHoveredYear] = useState(null);

    const METRICS = [
        { id:'profitDistribution', label:'×—×œ×•×§×ª ×¨×•×•×—×™× ×œ×©×•×ª×¤×”', prefix:'â‚ª', divisor:1 },
        { id:'billingHours',       label:'×©×¢×•×ª ×—×™×•×‘',            prefix:'',  divisor:1, suffix:'×©×³' },
        { id:'totalBillings',      label:'×¡×”"×› ×—×™×•×‘×™×',          prefix:'â‚ª', divisor:1 },
        { id:'dailyRate',          label:'×××•×¦×¢ ×—×™×•×‘×™× ×™×•××™',    prefix:'â‚ª', divisor:1 },
        { id:'avgRate',            label:'×¢×¨×š ×©×¢×” ×›×œ×œ×™',         prefix:'â‚ª', divisor:1 },
        { id:'incomeWithVAT',      label:'×”×›× ×¡×•×ª (×›×•×œ×œ ××¢"×)',   prefix:'â‚ª', divisor:1 },
        { id:'expensesWithVAT',    label:'×”×•×¦××•×ª (×›×•×œ×œ ××¢"×)',   prefix:'â‚ª', divisor:1 },
        { id:'openInvoices',       label:'×—×©×‘×•× ×•×ª ×œ×§×‘×œ',         prefix:'â‚ª', divisor:1 },
    ];

    // ×—×™×©×•×‘ ×¢×¨×š ××˜×¨×™×§×” ×œ×¤×™ key ×•×—×•×“×©
    const getMetricVal = (d, metricId) => {
        if (!d) return 0;
        if (metricId === 'dailyRate') {
            const totalB = parseFloat(d.totalBillings||0);
            const retF   = parseFloat(d.retainerFee||0);
            const wd     = parseFloat(d.workDays||0);
            return wd > 0 ? (totalB - retF) / wd : 0;
        }
        if (metricId === 'avgRate') {
            const totalB = parseFloat(d.totalBillings||0);
            const bH     = parseFloat(d.billingHours||0);
            return bH > 0 ? totalB / bH : 0;
        }
        return parseFloat(d[metricId] || 0);
    };

    // × ×ª×•× ×™ ××˜×¨×™×§×” ×œ×¤×™ ×©× ×”
    const metricData = YEARS.map((y,yi) => ({
        year: y, color: COLORS[yi],
        months: MONTHS.map(m => getMetricVal(data[`${y}-${m.v}`], selMetric)),
    }));
    const metricDef = METRICS.find(m => m.id === selMetric) || METRICS[0];

    // â”€â”€ ×’×¨×£ 2: ×§×•×•×™× â€” ×›×œ ×©× ×” ×‘×¦×‘×¢ ××—×¨, hover highlight â”€â”€
    const drawMultiChart = (hovered) => {
        const canvas = canvasMulti.current; if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        const pad = { top:36, right:16, bottom:52, left:72 };
        const cW = W - pad.left - pad.right, cH = H - pad.top - pad.bottom;
        ctx.clearRect(0, 0, W, H);

        const allVals = metricData.flatMap(y => y.months).filter(v => v > 0);
        if (!allVals.length) {
            ctx.fillStyle = '#9ca3af'; ctx.font = '14px Arial'; ctx.textAlign = 'center';
            ctx.fillText('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×” ×¢×‘×•×¨ ××˜×¨×™×§×” ×–×•', W/2, H/2);
            return;
        }
        const minVal = 0;
        const maxVal = Math.max(...allVals) * 1.1;
        const range  = maxVal - minVal;

        // format Y label
        const fmtY = v => {
            if (metricDef.suffix) return Math.round(v) + metricDef.suffix;
            if (v >= 1000) return metricDef.prefix + Math.round(v/1000) + 'K';
            return metricDef.prefix + Math.round(v);
        };

        // grid
        for (let i = 0; i <= 4; i++) {
            const yy = pad.top + (cH/4)*i;
            ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(pad.left, yy); ctx.lineTo(pad.left+cW, yy); ctx.stroke();
            ctx.fillStyle = '#9ca3af'; ctx.font = '10px Arial'; ctx.textAlign = 'right';
            ctx.fillText(fmtY(maxVal*(1-i/4)), pad.left-5, yy+4);
        }

        // month x-labels
        MONTHS.forEach((m, mi) => {
            const x = pad.left + mi*(cW/11);
            ctx.fillStyle = '#6b7280'; ctx.font = '10px Arial'; ctx.textAlign = 'center';
            ctx.fillText(m.l.slice(0,3), x, pad.top+cH+16);
        });

        // draw dimmed lines first, then highlighted on top
        const drawOrder = hovered !== null
            ? [...metricData.filter((_,i)=>i!==hovered), metricData[hovered]]
            : metricData;

        drawOrder.forEach((yd) => {
            const yi = YEARS.indexOf(yd.year);
            const isHov = hovered !== null && yi === hovered;
            const isDim = hovered !== null && yi !== hovered;

            const pts = yd.months.map((v,mi) => ({
                x: pad.left + mi*(cW/11),
                y: pad.top + cH - ((v - minVal)/range)*cH,
                v
            }));

            // line
            ctx.beginPath();
            ctx.strokeStyle = isDim ? COLORS[yi]+'44' : COLORS[yi];
            ctx.lineWidth   = isHov ? 3.5 : 2;
            ctx.shadowBlur  = isHov ? 8 : 0;
            ctx.shadowColor = COLORS[yi];
            pts.forEach((p,i) => i===0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y));
            ctx.stroke();
            ctx.shadowBlur = 0;

            // dots
            pts.forEach(p => {
                if (!p.v) return;
                ctx.beginPath(); ctx.arc(p.x, p.y, isHov ? 5 : 3.5, 0, Math.PI*2);
                ctx.fillStyle   = isDim ? '#ffffff88' : 'white';
                ctx.fill();
                ctx.strokeStyle = isDim ? COLORS[yi]+'44' : COLORS[yi];
                ctx.lineWidth   = isHov ? 2.5 : 2;
                ctx.stroke();
            });

            // value labels on hover
            if (isHov) {
                pts.forEach(p => {
                    if (!p.v) return;
                    ctx.fillStyle = '#1e3a5f'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'center';
                    ctx.fillText(fmtY(p.v), p.x, p.y - 10);
                });
            }
        });

        // legend
        metricData.forEach((yd, yi) => {
            const isHov = hovered === yi;
            const lx = 16 + yi * 80;
            ctx.fillStyle = isHov ? COLORS[yi] : COLORS[yi]+'99';
            ctx.fillRect(lx, H-16, isHov ? 16 : 12, isHov ? 5 : 4);
            ctx.fillStyle = isHov ? '#1e3a5f' : '#6b7280';
            ctx.font = isHov ? 'bold 11px Arial' : '10px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(yd.year, lx + (isHov?20:16), H-10);
        });
    };

    useEffect(() => {
        if (activeTab !== 'monthly') return;
        drawMultiChart(hoveredYear);
    }, [activeTab, selMetric, data, hoveredYear]);

    // mouse hover handler
    const handleCanvasMouseMove = (e) => {
        const canvas = canvasMulti.current; if (!canvas) return;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const mx = (e.clientX - rect.left) * scaleX;
        const pad = { left:72 };
        const cW  = canvas.width - pad.left - 16;

        // find which year line is closest
        let closest = null, minDist = 30;
        metricData.forEach((yd, yi) => {
            yd.months.forEach((v, mi) => {
                if (!v) return;
                const x = pad.left + mi*(cW/11);
                const dist = Math.abs(mx - x);
                if (dist < minDist) { minDist = dist; closest = yi; }
            });
        });
        setHoveredYear(closest);
    };

    const handleCanvasMouseLeave = () => setHoveredYear(null);

    // â”€â”€ ×“×•×— ×©×•×ª×¤×•×ª ×œ×©× ×” × ×‘×—×¨×ª â”€â”€
    const partnerYearData = (() => {
        const sharon = { profit:0, transfers:0, expenseReturns:0, billingByHours:0, billingEqual:0, retainerFee:0, months:[] };
        const orit   = { profit:0, transfers:0, expenseReturns:0, billingByHours:0, billingEqual:0 };

        MONTHS.forEach(m => {
            const key = `${selPartnerYear}-${m.v}`;
            const d = data[key];
            if (!d) return;

            // ×—×™×©×•×‘ ×¨×•×•×— ×–×”×” ×œ×—×™×©×•×‘ ×‘×—×•×“×© ×¢×¦××•
            const inc0   = parseFloat(d.incomeWithVAT||0) - parseFloat(d.vatToPay||0);
            const exp0   = parseFloat(d.expensesWithVAT||0) / 1.18;
            const net    = inc0 - exp0 + avgVAT;
            const per    = net / 2;

            if (parseFloat(d.incomeWithVAT||0) > 0 || parseFloat(d.totalBillings||0) > 0 || parseFloat(d.profitDistribution||0) > 0) {
                sharon.profit += per;
                orit.profit   += per;
                sharon.months.push({ month: m.l, profit: per, dist: parseFloat(d.profitDistribution||0) });
            }

            // ×”×¢×‘×¨×•×ª
            (d.transfers||[]).forEach(t => {
                const profit   = parseFloat(t.profitAmount||0);
                const expenses = parseFloat(t.expensesAmount||0);
                if (t.partner==='sharon') {
                    sharon.transfers      += profit + expenses;
                    sharon.expenseReturns += expenses;
                } else {
                    orit.transfers      += profit + expenses;
                    orit.expenseReturns += expenses;
                }
            });

            // ×—×™×•×‘×™× ×œ×¤×™ ×©×•×ª×¤×”
            // sharonBilling/oritBilling ×›×‘×¨ ×›×•×œ×œ×™× ×¨×™×˜×™×™× ×¨ ××—×•×œ×§ ×œ×¤×™ ×©×¢×•×ª
            const sB = parseFloat(d.sharonBilling||0);
            const oB = parseFloat(d.oritBilling||0);
            const retFee = parseFloat(d.retainerFee||0);
            
            // ×œ×¤×™ ×©×¢×•×ª - ×¤×©×•×˜ ××©×ª××©×™× ×‘×¢×¨×›×™× ×”××™×•×‘××™×
            sharon.billingByHours += sB;
            orit.billingByHours += oB;
            
            // ×œ×—×™×©×•×‘ 50/50 ×¦×¨×™×š ×œ×”×¤×¨×™×“ ××ª ×”×¨×™×˜×™×™× ×¨ ××”×—×™×•×‘×™× ×”×¨×’×™×œ×™×
            // sB + oB = regular + retFee
            const totalBilling = sB + oB;
            const totalRegular = totalBilling - retFee;
            const retainerHalf = retFee / 2;
            
            // ×—×œ×•×§×ª ×”×¨×’×™×œ ×œ×¤×™ ×”×™×—×¡ ×‘×™×Ÿ sB ×œ-oB, ×•××– + ×—×¦×™ ×¨×™×˜×™×™× ×¨
            if (totalBilling > 0) {
                const sharonRatio = sB / totalBilling;
                const oritRatio = oB / totalBilling;
                sharon.billingEqual += (totalRegular * sharonRatio) + retainerHalf;
                orit.billingEqual += (totalRegular * oritRatio) + retainerHalf;
            }
            
            sharon.retainerFee += retFee;
            
            console.log(`[×“×•×— ×©×•×ª×¤×•×ª] ${key}: sharon=${sB.toFixed(0)}, orit=${oB.toFixed(0)}, retainer=${retFee.toFixed(0)}, total=${(sB+oB).toFixed(0)}`);
        });

        return { sharon, orit };
    })();

    const pd = partnerYearData;
    const sharonBalance = pd.sharon.profit - pd.sharon.transfers;
    const oritBalance   = pd.orit.profit   - pd.orit.transfers;

    const tabs = [
        {id:'annual',  label:'ğŸ“Š ×”×©×•×•××” ×©× ×ª×™×ª'},
        {id:'monthly', label:'ğŸ“ˆ ×›×œ ×”×©× ×™×'},
        {id:'partners',label:'ğŸ‘©â€âš–ï¸ ×“×•×— ×©×•×ª×¤×•×ª'},
    ];

    return (
        <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
            <div className="modal-box" style={{maxWidth:880}}>
                <div style={{background:'linear-gradient(135deg,#1e3a5f,#2563eb)',borderRadius:'16px 16px 0 0',padding:'20px 24px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <div>
                        <h2 style={{color:'white',fontSize:'1.15rem',fontWeight:700,margin:0}}>ğŸ“Š ×“×•×—×•×ª ×•× ×™×ª×•×—×™×</h2>
                        <p style={{color:'rgba(255,255,255,0.7)',fontSize:'0.8rem',margin:'4px 0 0'}}>2021â€“2026</p>
                    </div>
                    <button onClick={onClose} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:'50%',width:34,height:34,cursor:'pointer',fontSize:'1rem',fontWeight:'bold'}}>âœ•</button>
                </div>

                {/* Tabs */}
                <div style={{display:'flex',borderBottom:'2px solid #e5e7eb',padding:'0 24px',background:'#f9fafb'}}>
                    {tabs.map(t=>(
                        <button key={t.id} onClick={()=>setActiveTab(t.id)}
                            style={{padding:'12px 18px',border:'none',
                                borderBottom: activeTab===t.id ? '2px solid #2563eb' : '2px solid transparent',
                                marginBottom:'-2px',background:'none',cursor:'pointer',
                                fontWeight: activeTab===t.id ? 700 : 500,
                                color: activeTab===t.id ? '#2563eb' : '#6b7280',
                                fontSize:'0.88rem',whiteSpace:'nowrap'}}>
                            {t.label}
                        </button>
                    ))}
                </div>

                <div style={{padding:'24px',maxHeight:'68vh',overflowY:'auto'}}>

                    {/* â”€â”€ ×”×©×•×•××” ×©× ×ª×™×ª: ×¢××•×“×•×ª ××§×•×‘×¦×•×ª ×œ×¤×™ ×—×•×“×© â”€â”€ */}
                    {activeTab==='annual' && (
                        <div>
                            <p style={{color:'#6b7280',fontSize:'0.82rem',marginBottom:12}}>×›×œ ×§×‘×•×¦×” = ×—×•×“×©. ×›×œ ×¢××•×“×” = ×©× ×”. ×¦×™×¨ Y = ×—×œ×•×§×ª ×¨×•×•×—×™× ×œ×©×•×ª×¤×”.</p>
                            <canvas ref={canvasAnnual} width={800} height={300} style={{width:'100%',height:'auto',borderRadius:8,border:'1px solid #e5e7eb'}}/>
                            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8,marginTop:14}}>
                                {annualData.filter(y=>y.total>0).map(y=>(
                                    <div key={y.year} style={{borderRadius:8,padding:'10px 14px',border:`2px solid ${y.color}44`,background:`${y.color}0a`}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                            <span style={{fontWeight:700,color:y.color,fontSize:'1rem'}}>{y.year}</span>
                                            <span style={{fontWeight:700,color:'#1e3a5f'}}>â‚ª{Math.round(y.total).toLocaleString()}</span>
                                        </div>
                                        <div style={{fontSize:'0.75rem',color:'#9ca3af',marginTop:2}}>
                                            ×××•×¦×¢: â‚ª{Math.round(y.total / (y.months.filter(v=>v>0).length||1)).toLocaleString()}/×—×•×“×©
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* â”€â”€ ×’×¨×£ ×§×•×•×™× â€” ×›×œ ×©× ×” â”€â”€ */}
                    {activeTab==='monthly' && (
                        <div>
                            {/* ×‘×•×¨×¨ ××˜×¨×™×§×” */}
                            <div style={{display:'flex',flexWrap:'wrap',gap:6,marginBottom:14}}>
                                {METRICS.map(m=>(
                                    <button key={m.id} onClick={()=>setSelMetric(m.id)}
                                        style={{padding:'5px 11px',borderRadius:20,border:'none',cursor:'pointer',
                                            fontSize:'0.78rem',fontWeight: selMetric===m.id ? 700 : 500,
                                            background: selMetric===m.id ? '#1e3a5f' : '#f3f4f6',
                                            color:      selMetric===m.id ? 'white'   : '#6b7280',
                                            transition:'all 0.15s'}}>
                                        {m.label}
                                    </button>
                                ))}
                            </div>
                            <canvas ref={canvasMulti} width={800} height={300}
                                style={{width:'100%',height:'auto',borderRadius:8,border:'1px solid #e5e7eb',cursor:'crosshair'}}
                                onMouseMove={handleCanvasMouseMove}
                                onMouseLeave={handleCanvasMouseLeave}/>
                            <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:6,marginTop:10}}>
                                {metricData.map((y,yi)=>(
                                    <div key={y.year}
                                        onMouseEnter={()=>setHoveredYear(yi)}
                                        onMouseLeave={()=>setHoveredYear(null)}
                                        style={{display:'flex',alignItems:'center',gap:6,cursor:'pointer',
                                            padding:'4px 6px',borderRadius:6,
                                            background: hoveredYear===yi ? COLORS[yi]+'18' : 'transparent',
                                            transition:'background 0.15s'}}>
                                        <div style={{width:14,height:4,borderRadius:2,background:COLORS[yi],flexShrink:0,
                                            boxShadow: hoveredYear===yi ? `0 0 6px ${COLORS[yi]}` : 'none'}}/>
                                        <span style={{fontSize:'0.8rem',fontWeight: hoveredYear===yi ? 700 : 600,color:'#374151'}}>{y.year}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* â”€â”€ ×“×•×— ×©×•×ª×¤×•×ª â”€â”€ */}
                    {activeTab==='partners' && (
                        <div>
                            {/* ×‘×•×¨×¨ ×©× ×” */}
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
                                <h3 style={{margin:0,fontWeight:700,color:'#1e3a5f',fontSize:'0.95rem'}}>×¡×™×›×•× ×©× ×ª×™ ×œ×¤×™ ×©×•×ª×¤×”</h3>
                                <div style={{display:'flex',gap:6}}>
                                    {YEARS.map(y=>(
                                        <button key={y} onClick={()=>setSelPartnerYear(y)}
                                            style={{padding:'5px 12px',borderRadius:6,border:'none',cursor:'pointer',fontWeight:600,fontSize:'0.82rem',
                                                background: selPartnerYear===y ? '#2563eb' : '#f3f4f6',
                                                color:      selPartnerYear===y ? 'white'   : '#6b7280'}}>
                                            {y}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* ×›×¨×˜×™×¡×™ ×©×•×ª×¤×•×ª */}
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14,marginBottom:16}}>
                                {[['×©×¨×•×Ÿ ğŸ‘©â€âš–ï¸', pd.sharon,'#6366f1','#ede9fe','#4338ca'],
                                  ['××•×¨×™×ª ğŸ‘©â€âš–ï¸', pd.orit,  '#06b6d4','#e0f2fe','#0e7490']].map(([name,p,acc,bg,dark])=>(
                                    <div key={name} style={{background:bg,borderRadius:12,padding:16,border:`1px solid ${acc}44`}}>
                                        <div style={{fontWeight:700,color:dark,fontSize:'1rem',marginBottom:12}}>{name}</div>
                                        <table style={{width:'100%',fontSize:'0.85rem',borderCollapse:'collapse'}}>
                                            <tbody>
                                                {[
                                                    ['×¨×•×•×— × ×§×™ (50%)',         p.profit],
                                                    ['×¡×”"×› ×”×•×¢×‘×¨ (×¨×•×•×—+×”×•×¦\')', p.transfers],
                                                    ['  ××ª×•×›×•: ×”×—×–×¨ ×”×•×¦××•×ª',   p.expenseReturns],
                                                ].map(([l,v])=>(
                                                    <tr key={l} style={{borderBottom:`1px solid ${acc}22`}}>
                                                        <td style={{padding:'5px 4px',color: l.startsWith('  ') ? '#9ca3af' : '#4b5563',fontSize: l.startsWith('  ') ? '0.8rem':'0.85rem'}}>{l}</td>
                                                        <td style={{padding:'5px 4px',fontWeight: l.startsWith('  ') ? 400 : 700,color: l.startsWith('  ') ? '#9ca3af' : dark,textAlign:'left'}}>{fmtN(v)}</td>
                                                    </tr>
                                                ))}
                                                <tr style={{background:`${acc}18`}}>
                                                    <td style={{padding:'8px 4px',fontWeight:700,color:dark}}>×™×ª×¨×” ×œ×”×¢×‘×¨×”</td>
                                                    <td style={{padding:'8px 4px',fontWeight:700,textAlign:'left',
                                                        color: (name.includes('×©×¨×•×Ÿ') ? sharonBalance : oritBalance) >= 0 ? '#166534' : '#dc2626'}}>
                                                        {fmtN(name.includes('×©×¨×•×Ÿ') ? sharonBalance : oritBalance)}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                ))}
                            </div>

                            {/* ×¤×™×¨×•×˜ ×—×•×“×©×™ */}
                            {pd.sharon.months.length > 0 && (
                                <div style={{border:'1px solid #e5e7eb',borderRadius:10,overflow:'hidden',marginBottom:14}}>
                                    <div style={{background:'#f3f4f6',padding:'8px 14px',fontWeight:600,fontSize:'0.85rem',color:'#374151'}}>×¤×™×¨×•×˜ ×—×•×“×©×™ â€” {selPartnerYear}</div>
                                    <table style={{width:'100%',borderCollapse:'collapse',fontSize:'0.83rem'}}>
                                        <thead>
                                            <tr style={{background:'#f9fafb',borderBottom:'1px solid #e5e7eb'}}>
                                                {['×—×•×“×©','×¨×•×•×— × ×§×™ ×œ×©×•×ª×¤×”','×—×œ×•×§×” ×‘×¤×•×¢×œ','×¤×¢×¨'].map(h=>(
                                                    <th key={h} style={{padding:'8px 12px',textAlign:'right',fontWeight:600,color:'#374151'}}>{h}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {pd.sharon.months.map((row,i)=>{
                                                const gap = row.dist - row.profit;
                                                return (
                                                    <tr key={i} style={{borderBottom:'1px solid #f3f4f6',background:i%2===0?'white':'#fafafa'}}>
                                                        <td style={{padding:'7px 12px',fontWeight:500}}>{row.month}</td>
                                                        <td style={{padding:'7px 12px',color:'#166534',fontWeight:500}}>{fmtN(row.profit)}</td>
                                                        <td style={{padding:'7px 12px',color:'#6366f1',fontWeight:500}}>{fmtN(row.dist)}</td>
                                                        <td style={{padding:'7px 12px',fontWeight:600,color: gap >= 0 ? '#166534' : '#dc2626'}}>
                                                            {row.dist > 0 ? (gap >= 0 ? '+' : '') + fmtN(Math.abs(gap)) : '-'}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            {/* ×¤×™×¦×•×œ ×—×™×•×‘×™× ×©×¨×•×Ÿ/××•×¨×™×ª */}
                            {(() => {
                                const sB = retainerSplitMethod === 'hours' ? pd.sharon.billingByHours : pd.sharon.billingEqual;
                                const oB = retainerSplitMethod === 'hours' ? pd.orit.billingByHours : pd.orit.billingEqual;
                                const total = sB + oB;
                                if (total === 0) return (
                                    <div style={{background:'#fffbeb',border:'1px solid #fde68a',borderRadius:10,padding:14}}>
                                        <div style={{fontWeight:600,color:'#92400e',marginBottom:4,fontSize:'0.85rem'}}>ğŸ“‹ ×¤×™×¦×•×œ ×—×™×•×‘×™× ×©×¨×•×Ÿ / ××•×¨×™×ª</div>
                                        <p style={{fontSize:'0.82rem',color:'#78350f',margin:0}}>
                                            ×™×© ×œ×™×™×‘× × ×ª×•× ×™× ××¢×•×“×›× ×™×ª ×¢×‘×•×¨ ×—×•×“×©×™ {selPartnerYear} ×›×“×™ ×œ×¨××•×ª ××ª ×”×¤×™×¦×•×œ.
                                        </p>
                                    </div>
                                );
                                const sPct = Math.round((sB/total)*100);
                                const oPct = 100 - sPct;
                                return (
                                    <div style={{border:'1px solid #e5e7eb',borderRadius:10,padding:16,background:'white'}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
                                            <div style={{fontWeight:700,color:'#1e3a5f',fontSize:'0.9rem'}}>ğŸ“‹ ×¤×™×¦×•×œ ×—×™×•×‘×™× ×©×¨×•×Ÿ / ××•×¨×™×ª â€” {selPartnerYear}</div>
                                            <div style={{display:'flex',gap:8,alignItems:'center'}}>
                                                <span style={{fontSize:'0.8rem',color:'#6b7280',fontWeight:500}}>×—×œ×•×§×ª ×¨×™×˜×™×™× ×¨:</span>
                                                <div style={{display:'flex',background:'#f3f4f6',borderRadius:8,padding:3}}>
                                                    <button 
                                                        onClick={() => setRetainerSplitMethod('hours')}
                                                        style={{
                                                            padding:'5px 12px',
                                                            border:'none',
                                                            borderRadius:6,
                                                            fontSize:'0.8rem',
                                                            fontWeight:600,
                                                            cursor:'pointer',
                                                            background: retainerSplitMethod === 'hours' ? '#6366f1' : 'transparent',
                                                            color: retainerSplitMethod === 'hours' ? 'white' : '#6b7280',
                                                            transition:'all 0.2s'
                                                        }}>
                                                        ×œ×¤×™ ×©×¢×•×ª
                                                    </button>
                                                    <button 
                                                        onClick={() => setRetainerSplitMethod('equal')}
                                                        style={{
                                                            padding:'5px 12px',
                                                            border:'none',
                                                            borderRadius:6,
                                                            fontSize:'0.8rem',
                                                            fontWeight:600,
                                                            cursor:'pointer',
                                                            background: retainerSplitMethod === 'equal' ? '#6366f1' : 'transparent',
                                                            color: retainerSplitMethod === 'equal' ? 'white' : '#6b7280',
                                                            transition:'all 0.2s'
                                                        }}>
                                                        50/50
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:14}}>
                                            {[['×©×¨×•×Ÿ ğŸ‘©â€âš–ï¸', sB, sPct,'#6366f1','#ede9fe'],['××•×¨×™×ª ğŸ‘©â€âš–ï¸', oB, oPct,'#06b6d4','#e0f2fe']].map(([name,val,pct,color,bg])=>(
                                                <div key={name} style={{background:bg,borderRadius:8,padding:'10px 14px'}}>
                                                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:4}}>
                                                        <span style={{fontWeight:600,color,fontSize:'0.88rem'}}>{name}</span>
                                                        <span style={{fontWeight:800,color,fontSize:'1.1rem'}}>{pct}%</span>
                                                    </div>
                                                    <div style={{fontWeight:600,color:'#374151',fontSize:'0.85rem',marginBottom:2}}>{fmtN(val)}</div>
                                                    <div style={{fontSize:'0.75rem',color:'#9ca3af',marginBottom:6}}>×œ×œ× ××¢"×</div>
                                                    <div style={{background:'white',borderRadius:4,height:8,overflow:'hidden'}}>
                                                        <div style={{width:`${pct}%`,height:'100%',background:color,borderRadius:4,transition:'width 0.5s'}}/>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        {/* ×‘×¨ ×”×©×•×•××” ××œ× */}
                                        <div style={{borderRadius:6,overflow:'hidden',height:16,display:'flex'}}>
                                            <div style={{width:`${sPct}%`,background:'#6366f1',display:'flex',alignItems:'center',justifyContent:'center'}}>
                                                <span style={{color:'white',fontSize:'0.72rem',fontWeight:700}}>{sPct > 15 ? `×©×¨×•×Ÿ ${sPct}%` : ''}</span>
                                            </div>
                                            <div style={{flex:1,background:'#06b6d4',display:'flex',alignItems:'center',justifyContent:'center'}}>
                                                <span style={{color:'white',fontSize:'0.72rem',fontWeight:700}}>{oPct > 15 ? `××•×¨×™×ª ${oPct}%` : ''}</span>
                                            </div>
                                        </div>
                                        <p style={{fontSize:'0.75rem',color:'#9ca3af',margin:'8px 0 0'}}>
                                            {retainerSplitMethod === 'hours' 
                                                ? '* ×¨×™×˜×™×™× ×¨ ××—×•×œ×§ ×œ×¤×™ ×™×—×¡ ×©×¢×•×ª ×©×›×œ ×©×•×ª×¤×” ×¢×‘×“×” ×¢×‘×•×¨ ×“×Ÿ ×ª×—×‘×•×¨×”'
                                                : '* ×¨×™×˜×™×™× ×¨ ××—×•×œ×§ 50/50 ×‘×™×Ÿ ×”×©×•×ª×¤×•×ª'
                                            } | ×©×¢×•×ª ×¢×‘×•×“×” ×‘×œ×‘×“ (×œ×œ× ×”×•×¦××•×ª) | ×¡×›×•××™× ×œ×œ× ××¢"×
                                        </p>
                                    </div>
                                );
                            })()}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

function App() {
    const [selMonth, setSelMonth] = useState(String(new Date().getMonth() + 1).padStart(2, '0'));
    const [selYear, setSelYear] = useState(new Date().getFullYear());
    const [data, setData] = useState({});
    const [avgVAT, setAvgVAT] = useState(2500);
    const [cur, setCur] = useState(EMPTY);
    const [showTransfer, setShowTransfer] = useState(false);
    const [showAllTransfers, setShowAllTransfers] = useState(false);
    const [showReports, setShowReports] = useState(false);
    const [showSettings, setShowSettings] = useState(false);
    const [autoBackupEnabled, setAutoBackupEnabled] = useState(false);
    const [githubToken, setGithubToken] = useState('');
    const [githubSyncEnabled, setGithubSyncEnabled] = useState(false);
    const [syncStatus, setSyncStatus] = useState(''); // 'syncing', 'synced', 'error'
    const [importMsg, setImportMsg] = useState(null);
    const [importedExpenses, setImportedExpenses] = useState([]); // [{id, date, registeredBy, client, item, amount, checked}]
    const [showExpenses, setShowExpenses] = useState(false);
    const [showExpensesModal, setShowExpensesModal] = useState(false);
    const [odcanitImporting, setOdcanitImporting] = useState(false);
    const fileInputRef   = React.useRef(null);
    const fileInputRef2  = React.useRef(null);
    const fileRestoreRef = React.useRef(null);

    // Helper function to save data to localStorage
    const saveData = (dataToSave) => {
        localStorage.setItem('lawFin_v2', JSON.stringify(dataToSave));
        if (githubSyncEnabled && githubToken) {
            saveToGitHub(githubToken, dataToSave);
        }
    };

    // ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×©×œ ×–×™×›×•×™ ××¢"× ×›××©×¨ ×××œ××™× ××¢"× ×©×©×•×œ× ×‘×¤×•×¢×œ
    useEffect(() => {
        const vatToPay = parseFloat(cur.vatToPay||0);
        const vatActual = parseFloat(cur.actualVATPaid||0);
        
        if (vatActual > 0 && vatToPay > 0) {
            const calculatedCredit = vatToPay - vatActual;
            if (calculatedCredit !== avgVAT) {
                setAvgVAT(calculatedCredit);
            }
        }
    }, [cur.actualVATPaid, cur.vatToPay]);

    const loadHistoricalData = () => {
        const HISTORICAL_DATA = {
    "2021-02": {"billingHours":312.25,"totalBillings":161034.0,"retainerFee":50000.0,"retainerHours":83.25,"workDays":20.0,"incomeWithVAT":13279.0,"expensesWithVAT":15560.0,"vatToPay":1657,"openInvoices":154960,"actualVATPaid":16122,"vatCredit":3464},
    "2021-03": {"billingHours":270.25,"totalBillings":167270.0,"retainerFee":50000.0,"retainerHours":24.75,"workDays":19.0,"incomeWithVAT":71142.0,"expensesWithVAT":33715.0,"vatToPay":10337.0,"openInvoices":299618,"vatCredit":3464,"actualVATPaid":16122},
    "2021-04": {"billingHours":237.25,"totalBillings":158735.0,"retainerFee":50000.0,"retainerHours":22.5,"workDays":18.0,"incomeWithVAT":211030.0,"expensesWithVAT":20805.0,"vatToPay":30641.0,"openInvoices":108646,"vatCredit":0},
    "2021-05": {"billingHours":258.75,"totalBillings":161000.0,"retainerFee":50000.0,"retainerHours":25.25,"workDays":20.0,"incomeWithVAT":165903.5,"expensesWithVAT":21476.0,"vatToPay":24106.0,"openInvoices":288598,"actualVATPaid":25260,"vatCredit":3496},
    "2021-06": {"billingHours":275.5,"totalBillings":160615.0,"retainerFee":50000.0,"retainerHours":34.0,"workDays":22.0,"incomeWithVAT":229911.05,"expensesWithVAT":18866.0,"vatToPay":33406.0,"openInvoices":105849,"vatCredit":3496,"actualVATPaid":25260},
    "2021-07": {"billingHours":262.0,"totalBillings":145187.0,"retainerFee":50000.0,"retainerHours":65.25,"workDays":21.0,"incomeWithVAT":156389.0,"expensesWithVAT":18334.0,"vatToPay":22723.0,"openInvoices":137307,"actualVATPaid":16858,"vatCredit":3335},
    "2021-08": {"billingHours":167.25,"totalBillings":115477.5,"retainerFee":50000.0,"retainerHours":39.75,"workDays":23.0,"incomeWithVAT":121560.0,"expensesWithVAT":17661.0,"vatToPay":17663.0,"openInvoices":185655,"vatCredit":3335,"actualVATPaid":16858},
    "2021-09": {"billingHours":161.25,"totalBillings":135942.5,"retainerFee":50000.0,"retainerHours":12.5,"workDays":10.0,"incomeWithVAT":155102.5,"expensesWithVAT":19093.0,"vatToPay":22536.0,"openInvoices":254802,"actualVATPaid":20273,"vatCredit":3422},
    "2021-10": {"billingHours":254.5,"totalBillings":164767.5,"retainerFee":50000.0,"retainerHours":40.5,"workDays":21.0,"incomeWithVAT":171046.0,"expensesWithVAT":18323.0,"vatToPay":24853.0,"openInvoices":274765,"vatCredit":3422,"actualVATPaid":20273},
    "2021-11": {"billingHours":255.5,"totalBillings":168729.0,"retainerFee":50000.0,"retainerHours":51.25,"workDays":22.0,"incomeWithVAT":97505.0,"expensesWithVAT":24393.0,"vatToPay":14167.0,"openInvoices":420092,"actualVATPaid":24120,"vatCredit":3768},
    "2021-12": {"billingHours":296.5,"totalBillings":156207.0,"retainerFee":50000.0,"retainerHours":47.0,"workDays":22.0,"incomeWithVAT":286360.0,"expensesWithVAT":21867.0,"vatToPay":41608.0,"openInvoices":335475,"vatCredit":3768,"actualVATPaid":24120},
    "2022-01": {"billingHours":262.5,"totalBillings":173255.0,"retainerFee":50000.0,"retainerHours":20.0,"workDays":22.0,"incomeWithVAT":139958.0,"expensesWithVAT":17030.0,"vatToPay":20336.0,"openInvoices":376057,"actualVATPaid":35418,"vatCredit":5825},
    "2022-02": {"billingHours":316.0,"totalBillings":215910.0,"retainerFee":50000.0,"retainerHours":56.5,"workDays":20.0,"incomeWithVAT":143886.0,"expensesWithVAT":22353.0,"vatToPay":20907.0,"openInvoices":452545,"vatCredit":0},
    "2022-03": {"billingHours":275.75,"totalBillings":166994.0,"retainerFee":50000.0,"retainerHours":26.25,"workDays":23.0,"incomeWithVAT":279176.0,"expensesWithVAT":31625.0,"vatToPay":40564.0,"openInvoices":361417,"actualVATPaid":64626,"vatCredit":8735},
    "2022-04": {"billingHours":182.0,"totalBillings":127470.5,"retainerFee":50000.0,"retainerHours":18.75,"workDays":15.0,"incomeWithVAT":226366.0,"expensesWithVAT":19004.0,"vatToPay":32797.39,"openInvoices":305441,"vatCredit":0},
    "2022-05": {"billingHours":258.0,"totalBillings":173471.0,"retainerFee":50000.0,"retainerHours":23.5,"workDays":21.0,"incomeWithVAT":86180.0,"expensesWithVAT":20979.0,"vatToPay":12521.0,"openInvoices":268576,"actualVATPaid":49961,"vatCredit":6536},
    "2022-06": {"billingHours":260.75,"totalBillings":155474.0,"retainerFee":50000.0,"retainerHours":38.0,"workDays":22.0,"incomeWithVAT":302657.0,"expensesWithVAT":18466.0,"vatToPay":43976.0,"openInvoices":300946,"vatCredit":0},
    "2022-07": {"billingHours":205.0,"totalBillings":132930.0,"retainerFee":50000.0,"retainerHours":25.5,"workDays":21.0,"incomeWithVAT":135505.0,"expensesWithVAT":26792.0,"vatToPay":19688.0,"openInvoices":296320,"actualVATPaid":34413,"vatCredit":7886},
    "2022-08": {"billingHours":280.75,"totalBillings":178403.0,"retainerFee":50000.0,"retainerHours":28.0,"workDays":23.0,"incomeWithVAT":155617.0,"expensesWithVAT":18672.0,"vatToPay":22611.0,"openInvoices":353610,"vatCredit":0},
    "2022-09": {"billingHours":227.5,"totalBillings":150017.0,"retainerFee":50000.0,"retainerHours":25.75,"workDays":18.0,"incomeWithVAT":198618.0,"expensesWithVAT":19687.0,"vatToPay":28859.0,"openInvoices":350679,"actualVATPaid":47112,"vatCredit":8080},
    "2022-10": {"billingHours":182.0,"totalBillings":127767.0,"retainerFee":50000.0,"retainerHours":39.0,"workDays":13.0,"incomeWithVAT":181391.0,"expensesWithVAT":16950.0,"vatToPay":26333.0,"openInvoices":309015,"vatCredit":0},
    "2022-11": {"billingHours":289.65,"totalBillings":188242.0,"retainerFee":50000.0,"retainerHours":38.5,"workDays":22.0,"incomeWithVAT":163592.48,"expensesWithVAT":17569.0,"vatToPay":23769.0,"openInvoices":360072,"actualVATPaid":49777,"vatCredit":6802},
    "2022-12": {"billingHours":245.25,"totalBillings":150870.0,"retainerFee":50000.0,"retainerHours":51.0,"workDays":21.0,"incomeWithVAT":225809.06,"expensesWithVAT":22678.54,"vatToPay":32809.87,"openInvoices":321432,"vatCredit":0},
    "2023-01": {"billingHours":320.25,"totalBillings":184994.0,"retainerFee":50000.0,"retainerHours":39.0,"workDays":23.0,"incomeWithVAT":202636.73,"expensesWithVAT":23565.0,"vatToPay":29421.87,"openInvoices":360715,"actualVATPaid":26429,"vatCredit":2993},
    "2023-02": {"billingHours":325.0,"totalBillings":185795.0,"retainerFee":50000.0,"retainerHours":34.0,"workDays":20.0,"incomeWithVAT":137841.11,"expensesWithVAT":17700.0,"vatToPay":20028.0,"openInvoices":424094,"actualVATPaid":16887,"vatCredit":3141},
    "2023-03": {"billingHours":288.0,"totalBillings":170120.45,"retainerFee":50000.0,"retainerHours":27.5,"workDays":21.0,"incomeWithVAT":211195.71,"expensesWithVAT":21253.13,"vatToPay":30611.59,"openInvoices":408327,"actualVATPaid":27175,"vatCredit":3437},
    "2023-04": {"billingHours":179.0,"totalBillings":117295.0,"retainerFee":50000.0,"retainerHours":54.0,"workDays":14.0,"incomeWithVAT":259685.0,"expensesWithVAT":21571.0,"vatToPay":37732.13,"openInvoices":299795,"actualVATPaid":34429,"vatCredit":3303},
    "2023-05": {"billingHours":266.15,"totalBillings":157996.6,"retainerFee":50000.0,"retainerHours":51.4,"workDays":22.0,"incomeWithVAT":194905.0,"expensesWithVAT":18017.0,"vatToPay":28319.0,"openInvoices":294329,"actualVATPaid":24308,"vatCredit":4011},
    "2023-06": {"billingHours":275.75,"totalBillings":165687.74,"retainerFee":50000.0,"retainerHours":45.75,"workDays":21.0,"incomeWithVAT":147041.0,"expensesWithVAT":27165.0,"vatToPay":19003.0,"openInvoices":345458,"actualVATPaid":13145,"vatCredit":5858},
    "2023-07": {"billingHours":305.0,"totalBillings":173260.0,"retainerFee":50000.0,"retainerHours":37.25,"workDays":20.0,"incomeWithVAT":224269.14,"expensesWithVAT":19948.0,"vatToPay":32586.13,"openInvoices":323340,"actualVATPaid":29397,"vatCredit":3189},
    "2023-08": {"billingHours":256.75,"totalBillings":145910.0,"retainerFee":50000.0,"retainerHours":34.0,"workDays":23.0,"incomeWithVAT":130927.16,"expensesWithVAT":18464.0,"vatToPay":19023.62,"openInvoices":363325,"actualVATPaid":15806,"vatCredit":3218},
    "2023-09": {"billingHours":231.25,"totalBillings":149868.0,"retainerFee":50000.0,"retainerHours":28.5,"workDays":20.0,"incomeWithVAT":241381.0,"expensesWithVAT":17563.0,"vatToPay":35048.0,"openInvoices":306120,"actualVATPaid":31843,"vatCredit":3205},
    "2023-10": {"billingHours":162.0,"totalBillings":132630.0,"retainerFee":50000.0,"retainerHours":15.0,"workDays":18.0,"incomeWithVAT":173369.4,"expensesWithVAT":17488.0,"vatToPay":25190.44,"openInvoices":294230,"actualVATPaid":21885,"vatCredit":3305},
    "2023-11": {"billingHours":164.25,"totalBillings":124517.0,"retainerFee":50000.0,"retainerHours":23.0,"workDays":22.0,"incomeWithVAT":178172.4,"expensesWithVAT":18239.0,"vatToPay":25888.0,"openInvoices":254087,"actualVATPaid":22352,"vatCredit":3536},
    "2023-12": {"billingHours":201.0,"totalBillings":114154.0,"retainerFee":50000.0,"retainerHours":68.25,"workDays":21.0,"incomeWithVAT":99419.0,"expensesWithVAT":17626.0,"vatToPay":14445.0,"openInvoices":284067,"actualVATPaid":11316,"vatCredit":3129},
    "2024-01": {"billingHours":260.0,"totalBillings":141834.53,"retainerFee":50000.0,"retainerHours":99.75,"workDays":23.0,"incomeWithVAT":153934.0,"expensesWithVAT":24111.0,"vatToPay":22366.0,"openInvoices":295974,"actualVATPaid":18844,"vatCredit":3522},
    "2024-02": {"billingHours":231.5,"totalBillings":156007.0,"retainerFee":50000.0,"retainerHours":41.0,"workDays":20.0,"incomeWithVAT":164271.0,"expensesWithVAT":20227.0,"vatToPay":23803.0,"openInvoices":306872,"actualVATPaid":20360,"vatCredit":3443},
    "2024-03": {"billingHours":234.25,"totalBillings":149743.0,"retainerFee":50000.0,"retainerHours":41.0,"workDays":21.0,"incomeWithVAT":217601.0,"expensesWithVAT":18170.0,"vatToPay":31587.0,"openInvoices":272490,"actualVATPaid":28368,"vatCredit":3219},
    "2024-04": {"billingHours":201.5,"totalBillings":144361.0,"retainerFee":50000.0,"retainerHours":10.0,"workDays":16.0,"incomeWithVAT":205418.0,"expensesWithVAT":6074.0,"vatToPay":29847.0,"openInvoices":249955,"actualVATPaid":28443,"vatCredit":1404},
    "2024-05": {"billingHours":237.0,"totalBillings":161462.36,"retainerFee":50000.0,"retainerHours":33.0,"workDays":22.0,"incomeWithVAT":95974.0,"expensesWithVAT":9386.0,"vatToPay":13918.0,"openInvoices":332960,"actualVATPaid":11948,"vatCredit":1970},
    "2024-06": {"billingHours":133.0,"totalBillings":114030.0,"retainerFee":50000.0,"retainerHours":38.25,"workDays":21.0,"incomeWithVAT":205643.42,"expensesWithVAT":12200.0,"vatToPay":29856.87,"openInvoices":276518,"actualVATPaid":27623,"vatCredit":2234},
    "2024-07": {"billingHours":270.5,"totalBillings":177471.43,"retainerFee":50000.0,"retainerHours":43.5,"workDays":23.0,"incomeWithVAT":137545.82,"expensesWithVAT":18471.0,"vatToPay":19927.76,"openInvoices":331835,"actualVATPaid":15537,"vatCredit":4391},
    "2024-08": {"billingHours":229.0,"totalBillings":145745.07,"retainerFee":50000.0,"retainerHours":35.5,"workDays":21.0,"incomeWithVAT":216835.53,"expensesWithVAT":12268.0,"vatToPay":31506.03,"openInvoices":291511,"actualVATPaid":28943,"vatCredit":2563},
    "2024-09": {"billingHours":263.75,"totalBillings":164475.49,"retainerFee":50000.0,"retainerHours":33.0,"workDays":22.0,"incomeWithVAT":106950.75,"expensesWithVAT":11895.0,"vatToPay":15516.9,"openInvoices":374472,"actualVATPaid":12768,"vatCredit":2749},
    "2024-10": {"billingHours":190.5,"totalBillings":127857.87,"retainerFee":50000.0,"retainerHours":16.75,"workDays":17.0,"incomeWithVAT":265925.7,"expensesWithVAT":13056.0,"vatToPay":38610.02,"openInvoices":262858,"actualVATPaid":36206,"vatCredit":2404},
    "2024-11": {"billingHours":253.5,"totalBillings":177449.65,"retainerFee":50000.0,"retainerHours":30.5,"workDays":20.0,"incomeWithVAT":129206.12,"expensesWithVAT":12173.0,"vatToPay":18773.55,"openInvoices":320032,"actualVATPaid":16159,"vatCredit":2615},
    "2024-12": {"billingHours":308.0,"totalBillings":179775.0,"retainerFee":50000.0,"retainerHours":37.5,"workDays":23.0,"incomeWithVAT":294339.67,"expensesWithVAT":21927.0,"vatToPay":42806.73,"openInvoices":289810,"actualVATPaid":35591,"vatCredit":7216},
    "2025-01": {"billingHours":273.75,"totalBillings":155607.5,"retainerFee":50000.0,"retainerHours":71.5,"workDays":22.0,"incomeWithVAT":115504.2,"expensesWithVAT":15424.0,"vatToPay":17619.29,"openInvoices":319715,"actualVATPaid":15931,"vatCredit":1688},
    "2025-02": {"billingHours":244.6,"totalBillings":141135.0,"retainerFee":50000.0,"retainerHours":49.5,"workDays":20.0,"incomeWithVAT":239663.55,"expensesWithVAT":13717.0,"vatToPay":36558.85,"openInvoices":260838,"actualVATPaid":34179,"vatCredit":2380},
    "2025-03": {"billingHours":229.75,"totalBillings":141830.0,"retainerFee":50000.0,"retainerHours":59.0,"workDays":22.0,"incomeWithVAT":161298.7,"expensesWithVAT":13408.0,"vatToPay":24604.88,"openInvoices":259769,"actualVATPaid":22134,"vatCredit":2471},
    "2025-04": {"billingHours":240.25,"totalBillings":156680.0,"retainerFee":50000.0,"retainerHours":25.0,"workDays":21.0,"incomeWithVAT":110679.66,"expensesWithVAT":12427.0,"vatToPay":16633.63,"openInvoices":333120,"actualVATPaid":14343,"vatCredit":2291},
    "2025-05": {"billingHours":247.08,"totalBillings":151323.1,"retainerFee":50000.0,"retainerHours":18.75,"workDays":21.0,"incomeWithVAT":177401.73,"expensesWithVAT":13043.0,"vatToPay":27061.28,"openInvoices":328508,"actualVATPaid":23631,"vatCredit":3430},
    "2025-06": {"billingHours":205.0,"totalBillings":144052.5,"retainerFee":50000.0,"retainerHours":25.5,"workDays":22.0,"incomeWithVAT":201607.0,"expensesWithVAT":10152.0,"vatToPay":30753.61,"openInvoices":289000,"actualVATPaid":28739,"vatCredit":2015},
    "2025-07": {"billingHours":162.5,"totalBillings":115540.0,"retainerFee":50000.0,"retainerHours":31.5,"workDays":23.0,"incomeWithVAT":164138.7,"expensesWithVAT":10384.0,"vatToPay":24969.46,"openInvoices":276795,"actualVATPaid":23027,"vatCredit":1942},
    "2025-08": {"billingHours":167.75,"totalBillings":112672.5,"retainerFee":50000.0,"retainerHours":37.0,"workDays":21.0,"incomeWithVAT":160179.51,"expensesWithVAT":13082.0,"vatToPay":24434.16,"openInvoices":257623,"actualVATPaid":22190,"vatCredit":2244},
    "2025-09": {"billingHours":198.5,"totalBillings":137810.0,"retainerFee":50000.0,"retainerHours":37.25,"workDays":22.0,"incomeWithVAT":136611.33,"expensesWithVAT":16736.0,"vatToPay":20839.01,"openInvoices":278806,"actualVATPaid":17699,"vatCredit":3140},
    "2025-10": {"billingHours":209.0,"totalBillings":145950.0,"retainerFee":50000.0,"retainerHours":25.5,"workDays":18.0,"incomeWithVAT":149815.0,"expensesWithVAT":13522.0,"vatToPay":22853.14,"openInvoices":327860,"actualVATPaid":20596,"vatCredit":2257},
    "2025-11": {"billingHours":241.0,"totalBillings":164482.5,"retainerFee":50000.0,"retainerHours":27.25,"workDays":21.0,"incomeWithVAT":199005.04,"expensesWithVAT":26716.0,"vatToPay":28364.69,"openInvoices":350118,"actualVATPaid":25671,"vatCredit":2694},
    "2025-12": {"billingHours":190.75,"totalBillings":122475.0,"retainerFee":50000.0,"retainerHours":41.25,"workDays":23.0,"incomeWithVAT":192684.65,"expensesWithVAT":21062.0,"vatToPay":29392.58,"openInvoices":326000,"actualVATPaid":26575,"vatCredit":2818},
    "2026-01": {"billingHours":231.0,"totalBillings":154415.54,"retainerFee":50000.0,"retainerHours":39.0,"workDays":21.0,"incomeWithVAT":132972.43,"expensesWithVAT":20300.0,"vatToPay":19924.74,"openInvoices":358092,"actualVATPaid":17477,"vatCredit":0}
};
        
        const confirmed = confirm('×”×× ×œ×˜×¢×•×Ÿ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×”×™×¡×˜×•×¨×™×™× ××”×§×•×‘×¥?\n\n×¤×¢×•×œ×” ×–×• ×ª×¢×“×›×Ÿ ××ª ×”××¢×¨×›×ª ×¢× 60 ×—×•×“×©×™× ×©×œ × ×ª×•× ×™× ×-2021 ×¢×“ 2026.\n\n×›×•×œ×œ: ×—×™×•×‘×™×, ×©×¢×•×ª, ×™××™ ×¢×‘×•×“×”, ×”×›× ×¡×•×ª, ×”×•×¦××•×ª, ××¢"×, ××¢"× ×©×©×•×œ× ×‘×¤×•×¢×œ, ×–×™×›×•×™ ××¢"× ×•×—×©×‘×•× ×•×ª ×¤×ª×•×—×™×.');
        
        if (confirmed) {
            const newData = { ...data };
            Object.keys(HISTORICAL_DATA).forEach(key => {
                newData[key] = {
                    ...newData[key],
                    ...HISTORICAL_DATA[key]
                };
            });
            
            setData(newData);
            localStorage.setItem('financeData', JSON.stringify(newData));
            alert('âœ… × ×˜×¢× ×• 60 ×—×•×“×©×™× ×©×œ × ×ª×•× ×™× ×‘×”×¦×œ×—×”!\n\n×”× ×ª×•× ×™× ×›×•×œ×œ×™×:\nâ€¢ ×©×¢×•×ª ×—×™×•×‘\nâ€¢ ×¡×”"×› ×—×™×•×‘×™×\nâ€¢ ×©×¢×•×ª ×¨×™×˜×™×™× ×¨\nâ€¢ ×™××™ ×¢×‘×•×“×”\nâ€¢ ×”×›× ×¡×•×ª ×•×”×•×¦××•×ª\nâ€¢ ××¢"× ×¨××©×•× ×™\nâ€¢ ××¢"× ×©×©×•×œ× ×‘×¤×•×¢×œ\nâ€¢ ×–×™×›×•×™ ××¢"× (×§×‘×•×¢: â‚ª2,500)\nâ€¢ ×—×©×‘×•× ×•×ª ×¤×ª×•×—×™×');
        }
    };

    const exportInvoicesToExcel = async () => {
        alert('ğŸ” ×”×¤×•× ×§×¦×™×” ×”×ª×—×™×œ×” ×œ×¨×•×¥!');
        console.log('=== FUNCTION STARTED ===');
        
        if (!selMonth) {
            alert('âŒ ×œ× × ×‘×—×¨ ×—×•×“×©! selMonth = ' + selMonth);
            console.log('selMonth:', selMonth);
            console.log('selYear:', selYear);
            return;
        }

        try {
            const monthName = MONTHS.find(m => m.v === selMonth)?.l;
            const year = selYear;
            const month = parseInt(selMonth);

            console.log('[DEBUG] ===== EXPORT INVOICES DEBUG =====');
            console.log('[DEBUG] Selected month:', selMonth, 'Year:', year);
            console.log('[DEBUG] Month name:', monthName);
            alert(`××™×™×‘× ×—×©×‘×•× ×™×•×ª ×¢×‘×•×¨ ${monthName} ${year}...`);

            // Main query - simplified to get ALL columns
            const query = `
                SELECT *
                FROM vwExportToOuterSystems_ReceiptAndIncome
                WHERE YEAR(DocDate) = ${year} 
                    AND MONTH(DocDate) = ${month}
                    AND DocType IN (2, 4)
                ORDER BY DocDate, DocNumber
            `;

            console.log('[DEBUG] Export query:', query);

            // DEBUG: First check what DocTypes exist in this month
            const debugCheckQuery = `
                SELECT 
                    DocType,
                    COUNT(*) as Count,
                    SUM(TotalAll) as TotalAmount
                FROM vwExportToOuterSystems_ReceiptAndIncome
                WHERE YEAR(DocDate) = ${year} AND MONTH(DocDate) = ${month}
                GROUP BY DocType
                ORDER BY DocType
            `;
            
            console.log('[DEBUG] Checking what DocTypes exist in this month...');
            const debugCheckResponse = await fetch('http://localhost:5000/api/odcanit-import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    server: '172.16.19.2\\ODCANIT',
                    database: 'odlight',
                    username: 'OdcanitAPI',
                    password: '392913',
                    queries: {debugCheck: debugCheckQuery}
                })
            });
            
            if (debugCheckResponse.ok) {
                const debugCheckResult = await debugCheckResponse.json();
                console.log('[DEBUG] â­ DocTypes in this month:', debugCheckResult.data.debugCheck);
                
                // Now let's see a sample invoice to understand the data structure
                const sampleQuery = `
                    SELECT TOP 3 *
                    FROM vwExportToOuterSystems_ReceiptAndIncome
                    WHERE YEAR(DocDate) = ${year} AND MONTH(DocDate) = ${month}
                    AND DocType = 2
                `;
                
                const sampleResponse = await fetch('http://localhost:5000/api/odcanit-import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        server: '172.16.19.2\\ODCANIT',
                        database: 'odlight',
                        username: 'OdcanitAPI',
                        password: '392913',
                        queries: {sample: sampleQuery}
                    })
                });
                
                if (sampleResponse.ok) {
                    const sampleResult = await sampleResponse.json();
                    console.log('[DEBUG] â­â­ Sample invoice data:', sampleResult.data.sample);
                }
            }

            // Call API to get invoice data
            const response = await fetch('http://localhost:5000/api/odcanit-import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    server: '172.16.19.2\\ODCANIT',
                    database: 'odlight',
                    username: 'OdcanitAPI',
                    password: '392913',
                    queries: {invoices: query}
                })
            });

            if (!response.ok) {
                throw new Error('×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª');
            }

            const result = await response.json();
            console.log('[DEBUG] API Response:', result);

            if (!result.success) {
                throw new Error(result.error || '×©×’×™××” ×‘×©×œ×™×¤×ª × ×ª×•× ×™×');
            }

            const invoices = Array.isArray(result.data.invoices) 
                ? result.data.invoices 
                : (result.data.invoices ? [result.data.invoices] : []);

            console.log('[DEBUG] Invoices count:', invoices.length);
            if (invoices.length > 0) console.log('[DEBUG] First invoice:', invoices[0]);

            if (invoices.length === 0) {
                alert(`×œ× × ××¦××• ×—×©×‘×•× ×™×•×ª ×¢×‘×•×¨ ${monthName} ${year}\n\n× × ×œ×‘×“×•×§:\nâ€¢ ×©×”×©×¨×ª ×¤×•×¢×œ\nâ€¢ ×©×™×© ×—×©×‘×•× ×™×•×ª ×‘×—×•×“×© ×–×” ×‘××¢×¨×›×ª\n\n×‘×“×•×§ ××ª Console (F12) ×œ×¤×¨×˜×™× × ×•×¡×¤×™×`);
                return;
            }

            // Create Excel workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for Excel - using raw fields from database
            const excelData = invoices.map(inv => {
                const docTypeText = inv.DocType === 1 ? '×—×©×‘×•× ×™×ª-××¡' :
                                   inv.DocType === 2 ? '×—×©×‘×•× ×™×ª-××¡/×§×‘×œ×”' :
                                   inv.DocType === 3 ? '×—×©×‘×•× ×™×ª ×–×™×›×•×™' :
                                   inv.DocType === 4 ? '×—×©×‘×•× ×™×ª ×¢×¡×§×”' : '××—×¨';
                
                // Format date as DD/MM/YY
                let formattedDate = '';
                if (inv.DocDate) {
                    const date = new Date(inv.DocDate);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = String(date.getFullYear()).slice(-2);
                    formattedDate = `${day}/${month}/${year}`;
                }
                
                const fees = parseFloat(inv.Fees || 0);
                const feesNV = parseFloat(inv.FeesNV || 0);
                const expenses = parseFloat(inv.Expenses || 0);
                const expensesNV = parseFloat(inv.ExpensesNV || 0);
                
                return {
                    '×¡×•×’': docTypeText,
                    '××¡×¤×¨ ×—×©×‘×•× ×™×ª': inv.DocNumber || '',
                    '×ª××¨×™×š': formattedDate,
                    '××¡×¤×¨ ×œ×§×•×—': inv.ClientVisualID || '',
                    '×©×›"×˜ ×—×™×™×‘': fees,
                    '×©×›"×˜ ×¤×˜×•×¨': feesNV,
                    '×”×•×¦××•×ª': expenses,
                    '×”×•×¦××•×ª ×¤×˜×•×¨×•×ª': expensesNV,
                    '×¡×”"×› ×—×™×™×‘': fees + expenses,
                    '××¢"×': parseFloat(inv.TotalTax || 0),
                    '×¡×”"×›': parseFloat(inv.TotalAll || 0),
                    '×”×¢×¨×•×ª': inv.Remark || ''
                };
            });

            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(excelData, {
                header: ['×¡×•×’', '××¡×¤×¨ ×—×©×‘×•× ×™×ª', '×ª××¨×™×š', '××¡×¤×¨ ×œ×§×•×—', 
                        '×©×›"×˜ ×—×™×™×‘', '×©×›"×˜ ×¤×˜×•×¨', '×”×•×¦××•×ª', '×”×•×¦××•×ª ×¤×˜×•×¨×•×ª',
                        '×¡×”"×› ×—×™×™×‘', '××¢"×', '×¡×”"×›', '×”×¢×¨×•×ª']
            });

            // Set column widths
            ws['!cols'] = [
                {wch: 20}, // ×¡×•×’
                {wch: 15}, // ××¡×¤×¨ ×—×©×‘×•× ×™×ª
                {wch: 12}, // ×ª××¨×™×š
                {wch: 15}, // ××¡×¤×¨ ×œ×§×•×—
                {wch: 12}, // ×©×›"×˜ ×—×™×™×‘
                {wch: 12}, // ×©×›"×˜ ×¤×˜×•×¨
                {wch: 12}, // ×”×•×¦××•×ª
                {wch: 18}, // ×”×•×¦××•×ª ×¤×˜×•×¨×•×ª
                {wch: 12}, // ×¡×”"×› ×—×™×™×‘
                {wch: 12}, // ××¢"×
                {wch: 12}, // ×¡×”"×›
                {wch: 40}  // ×”×¢×¨×•×ª
            ];
            
            // Set RTL (Right to Left) for the worksheet
            if (!ws['!views']) ws['!views'] = [{}];
            ws['!views'][0] = { rightToLeft: true };

            XLSX.utils.book_append_sheet(wb, ws, '×—×©×‘×•× ×™×•×ª');

            // Generate filename: "×”×›× ×¡×•×ª ×©×•×ª×¤×•×ª ×œ×—×•×“×© MM/YY"
            const monthStr = String(month).padStart(2, '0');
            const yearStr = String(year).slice(-2);
            const filename = `×”×›× ×¡×•×ª ×©×•×ª×¤×•×ª ×œ×—×•×“×© ${monthStr}-${yearStr}.xlsx`;

            // Download file
            XLSX.writeFile(wb, filename);

            alert(`âœ… ×™×™×¦×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!\n\n×™×•×¦××• ${invoices.length} ×—×©×‘×•× ×™×•×ª ×¢×‘×•×¨ ${monthName} ${year}`);

        } catch (error) {
            console.error('âŒ Export error:', error);
            console.error('Error stack:', error.stack);
            alert(`âŒ ×©×’×™××” ×‘×™×™×¦×•×:\n\n${error.message}\n\n${error.stack}\n\n×‘×“×•×§ Console (F12) ×œ×¤×¨×˜×™× × ×•×¡×¤×™×`);
        }
    };

    const handleBackup = () => {
        const backup = {
            version: 'lawFin_v2',
            exportedAt: new Date().toISOString(),
            data: data,
            avgVAT: avgVAT,
        };
        const json = JSON.stringify(backup, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url  = URL.createObjectURL(blob);
        const now  = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        const a = document.createElement('a');
        a.href = url; a.download = `×’×™×‘×•×™-××©×¨×“-${dateStr}.json`; a.click();
        URL.revokeObjectURL(url);
    };

    const handleRestore = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const backup = JSON.parse(ev.target.result);
                if (!backup.data || backup.version !== 'lawFin_v2') {
                    alert('âŒ ×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ ××• ××’×¨×¡×” ×©×’×•×™×”.');
                    return;
                }
                if (!window.confirm(`×©×—×–×•×¨ ×™×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×.\n×’×•×‘×” ×‘×ª××¨×™×š: ${new Date(backup.exportedAt).toLocaleString('he-IL')}\n\n×œ×”××©×™×š?`)) return;
                setData(backup.data);
                if (backup.avgVAT) setAvgVAT(backup.avgVAT);
                localStorage.setItem('lawFin_v2', JSON.stringify(backup.data));
                alert('âœ… ×”× ×ª×•× ×™× ×©×•×—×–×¨×• ×‘×”×¦×œ×—×”!');
            } catch {
                alert('âŒ ×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ ×”×’×™×‘×•×™.');
            }
            e.target.value = '';
        };
        reader.readAsText(file);
    };

    const handleMonthlyReport = async () => {
        if (!selMonth) { alert('×× × ×‘×—×¨ ×—×•×“×© ×œ×¤× ×™ ×™×¦×™×¨×ª ×”×“×•×—'); return; }
        
        const monthLabel = MONTHS.find(m => m.v === selMonth)?.l || selMonth;
        const key = `${selYear}-${selMonth}`;
        const d = data[key] || {};

        // Get previous month data for comparison
        const prevMonthNum = parseInt(selMonth) - 1;
        const prevYear = prevMonthNum < 1 ? selYear - 1 : selYear;
        const prevMonth = prevMonthNum < 1 ? '12' : String(prevMonthNum).padStart(2, '0');
        const prevKey = `${prevYear}-${prevMonth}`;
        const prevD = data[prevKey] || {};

        // Current month calculations
        const income0   = parseFloat(d.incomeWithVAT||0) - parseFloat(d.vatToPay||0);
        const expenses0 = parseFloat(d.expensesWithVAT||0)/1.18;
        const netProfit = income0 - expenses0;
        const perPartner = netProfit / 2;
        const totalB    = parseFloat(d.totalBillings||0);
        const retainerF = parseFloat(d.retainerFee||50000);
        const regularBillings = totalB - retainerF;
        const billingH  = parseFloat(d.billingHours||0);
        const retainerH = parseFloat(d.retainerHours||0);
        const workDays  = parseFloat(d.workDays||0);
        const openInv   = parseFloat(d.openInvoices||0);
        const dailyBilling = workDays > 0 ? regularBillings / workDays : 0;
        const avgHoursPerDay = workDays > 0 ? billingH / workDays : 0;
        const nonRetainerHours = billingH - retainerH;
        const nonRetainerRate = nonRetainerHours > 0 ? regularBillings / nonRetainerHours : 0;
        
        // Get active clients from saved data
        const activeClients = d.activeClients || 0;

        // Calculate YTD transfers per partner - current year (PROFIT ONLY, no expenses)
        const ytdTransfers = {sharon: 0, orit: 0};
        MONTHS.forEach(m => {
            if (parseInt(m.v) <= parseInt(selMonth)) {
                const monthKey = `${selYear}-${m.v}`;
                const monthData = data[monthKey];
                if (monthData && monthData.transfers) {
                    monthData.transfers.forEach(t => {
                        const profitOnly = parseFloat(t.profitAmount||0); // Only profit, not expenses
                        if (t.partner === 'sharon') ytdTransfers.sharon += profitOnly;
                        else if (t.partner === 'orit') ytdTransfers.orit += profitOnly;
                    });
                }
            }
        });

        // Calculate YTD transfers per partner - previous year (PROFIT ONLY, for comparison)
        const prevYtdTransfers = {sharon: 0, orit: 0};
        MONTHS.forEach(m => {
            if (parseInt(m.v) <= parseInt(selMonth)) {
                const monthKey = `${selYear - 1}-${m.v}`;
                const monthData = data[monthKey];
                if (monthData && monthData.transfers) {
                    monthData.transfers.forEach(t => {
                        const profitOnly = parseFloat(t.profitAmount||0); // Only profit, not expenses
                        if (t.partner === 'sharon') prevYtdTransfers.sharon += profitOnly;
                        else if (t.partner === 'orit') prevYtdTransfers.orit += profitOnly;
                    });
                }
            }
        });

        // Calculate multi-year average YTD for comparison (from profitDistribution data)
        const multiYearAvgYTD = {sharon: 0, orit: 0};
        let yearsWithData = 0;
        
        YEARS.forEach(year => {
            if (year !== selYear) { // Don't include current year in average
                let yearYTD = 0;
                MONTHS.forEach(m => {
                    if (parseInt(m.v) <= parseInt(selMonth)) {
                        const monthData = data[`${year}-${m.v}`];
                        if (monthData && monthData.profitDistribution) {
                            yearYTD += parseFloat(monthData.profitDistribution || 0);
                        }
                    }
                });
                if (yearYTD > 0) {
                    multiYearAvgYTD.sharon += yearYTD; // profitDistribution is per partner
                    multiYearAvgYTD.orit += yearYTD;
                    yearsWithData++;
                }
            }
        });
        
        // Calculate average
        if (yearsWithData > 0) {
            multiYearAvgYTD.sharon = multiYearAvgYTD.sharon / yearsWithData;
            multiYearAvgYTD.orit = multiYearAvgYTD.orit / yearsWithData;
        }

        // Get previous MONTH active clients for MoM comparison (not YoY)
        const prevMonthActiveClients = data[prevKey]?.activeClients || 0;

        // Previous month calculations
        const prevIncome0   = parseFloat(prevD.incomeWithVAT||0) - parseFloat(prevD.vatToPay||0);
        const prevExpenses0 = parseFloat(prevD.expensesWithVAT||0)/1.18;
        const prevNetProfit = prevIncome0 - prevExpenses0;
        const prevTotalB    = parseFloat(prevD.totalBillings||0);
        const prevRetainerF = parseFloat(prevD.retainerFee||50000);
        const prevRegularBillings = prevTotalB - prevRetainerF;
        const prevBillingH  = parseFloat(prevD.billingHours||0);
        const prevRetainerH = parseFloat(prevD.retainerHours||0);
        const prevWorkDays  = parseFloat(prevD.workDays||0);
        const prevOpenInv   = parseFloat(prevD.openInvoices||0);
        const prevDailyBilling = prevWorkDays > 0 ? prevRegularBillings / prevWorkDays : 0;
        const prevAvgHoursPerDay = prevWorkDays > 0 ? prevBillingH / prevWorkDays : 0;
        const prevNonRetainerHours = prevBillingH - prevRetainerH;
        const prevNonRetainerRate = prevNonRetainerHours > 0 ? prevRegularBillings / prevNonRetainerHours : 0;

        // Helper function for percentage change with color
        const pctChange = (current, previous) => {
            if (!previous || previous === 0) return '';
            const change = ((current - previous) / previous * 100);
            const color = change >= 0 ? '#14b8a6' : '#ef4444';
            const arrow = change >= 0 ? 'â–²' : 'â–¼';
            return `<span style="color: ${color}; font-size: 12px; font-weight: 600;"> (${arrow}${Math.abs(change).toFixed(0)}%)</span>`;
        };

        const fmtNum = (n) => {
            if (!n || isNaN(n) || n === 0) return '-';
            return 'â‚ª' + Math.round(n).toLocaleString('he-IL');
        };

        // Create HTML template for the report
        const reportHTML = document.createElement('div');
        reportHTML.dir = 'rtl';
        reportHTML.style.cssText = `
            width: 794px;
            background: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            position: absolute;
            left: -9999px;
            top: 0;
        `;

        const today = new Date().toLocaleDateString('he-IL');
        const transfers = d.transfers || [];

        reportHTML.innerHTML = `
            <div style="padding: 40px;">
                <!-- Header with Turquoise/Black theme -->
                <div style="background: linear-gradient(135deg, #0d9488 0%, #134e4a 100%); padding: 25px; margin: -40px -40px 25px -40px; color: white; border-radius: 0;">
                    <h1 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">×“×•×— ×›×¡×¤×™ ×—×•×“×©×™</h1>
                    <div style="font-size: 14px; opacity: 0.95;">××©×¨×“ ×¢×•"×“ ×–×™×œ×•× ×™-×§×œ×™× ××Ÿ ×œ×•×œ×¦'×™ | ${monthLabel} ${selYear}</div>
                    <div style="font-size: 12px; opacity: 0.85; margin-top: 6px;">× ×•×¦×¨: ${today}</div>
                </div>

                <!-- Section 1: ×—×™×•×‘×™× (×œ×œ× ××¢"×) -->
                <div style="margin-bottom: 25px;">
                    <div style="background: #f0fdfa; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #14b8a6;">
                        <h2 style="margin: 0 0 3px 0; font-size: 14px; color: #134e4a; font-weight: 700;">×—×™×•×‘×™× (×œ×œ× ××¢"×)</h2>
                        <p style="margin: 0; font-size: 10px; color: #0d9488; font-style: italic;">×”×©×•×•××” ×œ×—×•×“×© ×§×•×“×</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×—×™×•×‘×™× ×¨×’×™×œ×™× (×œ×œ× ×¨×™×˜×™×™× ×¨)</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${fmtNum(regularBillings)}${pctChange(regularBillings, prevRegularBillings)}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×“××™ ×¨×™×˜×™×™× ×¨</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${fmtNum(retainerF)}</td>
                        </tr>
                        <tr style="background: #f0fdfa; border-bottom: 2px solid #14b8a6;">
                            <td style="padding: 8px 5px; color: #0d9488; font-weight: 600; font-size: 14px;">×¡×”"×› ×—×™×•×‘×™×</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; color: #0d9488; font-size: 14px;">${fmtNum(totalB)}${pctChange(totalB, prevTotalB)}</td>
                        </tr>
                    </table>
                </div>

                <!-- Section 2: ×”×›× ×¡×•×ª ×•×”×•×¦××•×ª -->
                <div style="margin-bottom: 25px;">
                    <div style="background: #f0fdfa; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #14b8a6;">
                        <h2 style="margin: 0 0 3px 0; font-size: 14px; color: #134e4a; font-weight: 700;">×”×›× ×¡×•×ª ×•×”×•×¦××•×ª</h2>
                        <p style="margin: 0; font-size: 10px; color: #0d9488; font-style: italic;">×”×©×•×•××” ×œ×—×•×“×© ×§×•×“×</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×¡×”"×› ×”×›× ×¡×•×ª (×œ×œ× ××¢"×)</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${fmtNum(income0)}${pctChange(income0, prevIncome0)}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×¡×”"×› ×”×•×¦××•×ª (×œ×œ× ××¢"×)</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${fmtNum(expenses0)}${pctChange(expenses0, prevExpenses0)}</td>
                        </tr>
                        <tr style="background: #f0fdfa; border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #0d9488; font-weight: 600; font-size: 14px;">×¨×•×•×— × ×§×™</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; color: #0d9488; font-size: 14px;">${fmtNum(netProfit)}${pctChange(netProfit, prevNetProfit)}</td>
                        </tr>
                        <tr style="border-bottom: 2px solid #14b8a6;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×¨×•×•×— ×œ×©×•×ª×¤×”</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${fmtNum(perPartner)}${pctChange(perPartner, prevNetProfit/2)}</td>
                        </tr>
                    </table>
                </div>

                ${transfers.length > 0 ? `
                <!-- Section 3: ×”×¢×‘×¨×•×ª ×œ×©×•×ª×¤×•×ª -->
                <div style="margin-bottom: 25px;">
                    <div style="background: #f0fdfa; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #14b8a6;">
                        <h2 style="margin: 0 0 3px 0; font-size: 14px; color: #134e4a; font-weight: 700;">×”×¢×‘×¨×•×ª ×œ×©×•×ª×¤×•×ª</h2>
                        <p style="margin: 0; font-size: 10px; color: #0d9488; font-style: italic;">×¡×”"×› ×”×©× ×”: ×”×©×•×•××” ×œ×××•×¦×¢ ×¨×‘-×©× ×ª×™</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse;">
                        ${transfers.map(t => {
                            const partnerName = t.partner === 'sharon' ? '×©×¨×•×Ÿ' : '××•×¨×™×ª';
                            const totalT = (parseFloat(t.profitAmount||0) + parseFloat(t.expensesAmount||0));
                            return `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">${partnerName} - ×”×¢×‘×¨×”</td>
                                    <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${fmtNum(totalT)}</td>
                                </tr>
                                ${t.transferDate ? `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">${partnerName} - ×ª××¨×™×š</td>
                                    <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${t.transferDate}</td>
                                </tr>` : ''}
                                ${t.referenceNumber ? `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">${partnerName} - ××¡××›×ª×</td>
                                    <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${t.referenceNumber}</td>
                                </tr>` : ''}
                            `;
                        }).join('')}
                        ${ytdTransfers.sharon > 0 || ytdTransfers.orit > 0 ? `
                        <tr style="border-top: 2px solid #14b8a6; background: #f0fdfa;">
                            <td colspan="2" style="padding: 12px 5px; color: #0d9488; font-weight: 700; font-size: 14px; text-align: center;">×¡×”"×› ×”×¢×‘×¨×•×ª ×”×©× ×” ×¢×“ ×›×” (${selYear})</td>
                        </tr>
                        ${ytdTransfers.sharon > 0 ? `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×©×¨×•×Ÿ - ×¡×”"×› ×”×©× ×”</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${fmtNum(ytdTransfers.sharon)}${pctChange(ytdTransfers.sharon, multiYearAvgYTD.sharon)}</td>
                        </tr>` : ''}
                        ${ytdTransfers.orit > 0 ? `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">××•×¨×™×ª - ×¡×”"×› ×”×©× ×”</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${fmtNum(ytdTransfers.orit)}${pctChange(ytdTransfers.orit, multiYearAvgYTD.orit)}</td>
                        </tr>` : ''}
                        ` : ''}
                    </table>
                </div>` : ''}

                <!-- Section 4: ××“×“×™ ×¤×¢×™×œ×•×ª -->
                <div style="margin-bottom: 25px; page-break-before: always; break-before: page; page-break-inside: avoid; break-inside: avoid; padding-top: 40px;">
                    <div style="background: #f0fdfa; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #14b8a6;">
                        <h2 style="margin: 0 0 3px 0; font-size: 14px; color: #134e4a; font-weight: 700;">××“×“×™ ×¤×¢×™×œ×•×ª</h2>
                        <p style="margin: 0; font-size: 10px; color: #0d9488; font-style: italic;">×”×©×•×•××” ×œ×—×•×“×© ×§×•×“× | ×œ×§×•×—×•×ª ×¤×¢×™×œ×™×: ×”×©×•×•××” ×œ×—×•×“×© ×§×•×“×</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×¡×”"×› ×©×¢×•×ª ×—×™×•×‘</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${billingH > 0 ? billingH.toFixed(1) + ' ×©×¢×•×ª' : '-'}${billingH > 0 ? pctChange(billingH, prevBillingH) : ''}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×©×¢×•×ª ×¨×™×˜×™×™× ×¨</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${retainerH > 0 ? retainerH.toFixed(1) + ' ×©×¢×•×ª' : '-'}${retainerH > 0 ? pctChange(retainerH, prevRetainerH) : ''}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×××•×¦×¢ ×©×¢×•×ª ×—×™×•×‘ ×™×•××™</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${avgHoursPerDay > 0 ? avgHoursPerDay.toFixed(1) + ' ×©×¢×•×ª' : '-'}${avgHoursPerDay > 0 ? pctChange(avgHoursPerDay, prevAvgHoursPerDay) : ''}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×—×™×•×‘ ×™×•××™ ×××•×¦×¢ (×œ×œ× ××¢"×)</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${dailyBilling > 0 ? fmtNum(dailyBilling) : '-'}${dailyBilling > 0 ? pctChange(dailyBilling, prevDailyBilling) : ''}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×ª×¢×¨×™×£ ×©×¢×” (×©××™× ×” ×¨×™×˜×™×™× ×¨) ×××•×¦×¢</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${nonRetainerRate > 0 ? fmtNum(nonRetainerRate) : '-'}${nonRetainerRate > 0 ? pctChange(nonRetainerRate, prevNonRetainerRate) : ''}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×—×©×‘×•× ×•×ª ×¢×¡×§×” ×¤×ª×•×—×™×</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${fmtNum(openInv)}${pctChange(openInv, prevOpenInv)}</td>
                        </tr>
                        ${activeClients > 0 ? `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 5px; color: #6b7280; font-size: 14px;">×›××•×ª ×œ×§×•×—×•×ª ×¤×¢×™×œ×™×</td>
                            <td style="padding: 8px 5px; text-align: left; font-weight: 700; font-size: 14px;">${activeClients} ×œ×§×•×—×•×ª${pctChange(activeClients, prevMonthActiveClients)}</td>
                        </tr>` : ''}
                    </table>
                </div>

                ${d.notes ? `
                <!-- Section: ×”×¢×¨×•×ª -->
                <div style="margin-bottom: 25px;">
                    <div style="background: #f0fdfa; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #14b8a6;">
                        <h2 style="margin: 0; font-size: 14px; color: #134e4a; font-weight: 700;">×”×¢×¨×•×ª</h2>
                    </div>
                    <div style="padding: 8px 5px; color: #4b5563; font-size: 13px; line-height: 1.6;">
                        ${d.notes}
                    </div>
                </div>` : ''}

                <!-- Footer -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #14b8a6; color: #6b7280; font-size: 12px; display: flex; justify-content: space-between;">
                    <div style="color: #134e4a; font-weight: 600;">×—×¡×•×™ â€” ×“×•×— ×›×¡×¤×™ ××©×¨×“ ×¢×•"×“ ×–×™×œ×•× ×™-×§×œ×™× ××Ÿ ×œ×•×œ×¦'×™</div>
                    <div>${monthLabel} ${selYear}</div>
                </div>
            </div>
        `;

        document.body.appendChild(reportHTML);

        try {
            // Convert HTML to canvas
            const canvas = await html2canvas(reportHTML, {
                scale: 2,
                useCORS: true,
                allowTaint: false,
                backgroundColor: '#ffffff',
                logging: false
            });

            // Convert canvas to image data URL once
            const imgData = canvas.toDataURL('image/png');

            // Create PDF from canvas
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            // Add first page
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            // Add additional pages if content is longer than one page
            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            // Save PDF and open Outlook
            const fileName = `×“×•×—-×—×•×“×©×™-${monthLabel}-${selYear}.pdf`;
            
            // Save the PDF file
            pdf.save(fileName);
            
            // Open Outlook with new email
            const recipients = 'orit@zkl-law.co.il;sharon@zkl-law.co.il;office@zkl-law.co.il';
            const subject = encodeURIComponent(`×“×•×— ×—×•×“×©×™ - ${monthLabel} ${selYear}`);
            const body = encodeURIComponent(
                `×©×œ×•×,\n\n` +
                `××¦×•×¨×£ ×“×•×— ×›×¡×¤×™ ×—×•×“×©×™ ×¢×‘×•×¨ ${monthLabel} ${selYear}.\n\n` +
                `×‘×‘×¨×›×”,\n` +
                `××¢×¨×›×ª × ×™×”×•×œ ×›×¡×¤×™×`
            );
            
            // Create mailto link and click it
            const mailtoLink = `mailto:${recipients}?subject=${subject}&body=${body}`;
            const a = document.createElement('a');
            a.href = mailtoLink;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert('âœ… ×”×“×•×— × ×•×¦×¨ ×‘×”×¦×œ×—×”!\n\n' +
                  'â€¢ ×”×§×•×‘×¥ ×”×•×¨×“ ×œ××—×©×‘\n' +
                  'â€¢ × ×¤×ª×— ×—×œ×•×Ÿ Outlook ×¢× ×”× ××¢× ×™×\n' +
                  'â€¢ ×™×© ×œ×¦×¨×£ ××ª ×”×§×•×‘×¥ ×œ××™×™×œ\n\n' +
                  '× ××¢× ×™×:\n' +
                  'â€¢ orit@zkl-law.co.il\n' +
                  'â€¢ sharon@zkl-law.co.il\n' +
                  'â€¢ office@zkl-law.co.il');

        } catch (error) {
            console.error('PDF Error:', error);
            alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”-PDF: ' + error.message);
        } finally {
            document.body.removeChild(reportHTML);
        }
    };

    const workdaysInMonth = (year, month) => {
        const days = new Date(year, month, 0).getDate();
        let count = 0;
        for (let d = 1; d <= days; d++) {
            const dow = new Date(year, month - 1, d).getDay();
            if (dow >= 0 && dow <= 4) count++;
        }
        return count;
    };

    // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ â€” ×—×™×œ×•×¥ ×ª××¨×™×š ×-Excel
    const parseXlDate = (raw) => {
        if (!raw) return null;
        try {
            const d = typeof raw === 'number'
                ? new Date(Math.round((raw - 25569) * 86400 * 1000))
                : new Date(raw);
            if (isNaN(d.getTime())) return null;
            return d;
        } catch { return null; }
    };

    // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ â€” ×‘×“×™×§×ª ×”×ª×××ª ×ª××¨×™×š ×œ×—×•×“×© ×”× ×‘×—×¨
    const checkDateMatch = (dates, fileLabel) => {
        if (!selMonth || !dates.length) return [];
        const warnings = [];
        const expectedMonth = parseInt(selMonth); // 1-12
        const mismatch = dates.filter(d => d !== null && (d.getMonth()+1) !== expectedMonth);
        if (mismatch.length === dates.length) {
            const sample = mismatch[0];
            warnings.push(`âš ï¸ ×›×œ ×”×ª××¨×™×›×™× ×‘${fileLabel} ×”× ××—×•×“×© ${String(sample.getMonth()+1).padStart(2,'0')}/${sample.getFullYear()} â€” ×œ× ×ª×•×× ×œ×—×•×“×© ×”× ×‘×—×¨ (${MONTHS.find(m=>m.v===selMonth)?.l} ${selYear})`);
        } else if (mismatch.length > 0) {
            warnings.push(`âš ï¸ ${mismatch.length} ×©×•×¨×•×ª ×‘${fileLabel} ×”×Ÿ ××—×•×“×© ×©×•× ×” ××”×—×•×“×© ×”× ×‘×—×¨`);
        }
        return warnings;
    };

    const handleExcelImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const wb = XLSX.read(ev.target.result, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});

                // ×‘×“×™×§×ª ×¢××•×“×•×ª ×—×•×‘×”
                const headers = rows[0] || [];
                if (!headers[8] || !headers[9] || !headers[11]) {
                    setImportMsg({type:'err', text:'âŒ ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ: ×—×¡×¨×•×ª ×¢××•×“×•×ª ×—×™×•× ×™×•×ª (I, J, L). ×•×“× ×©×–×”×• ×§×•×‘×¥ ×—×™×•×‘×™× ×ª×§×™×Ÿ.'});
                    e.target.value = ''; return;
                }

                let totalHours = 0;
                let totalBilling = 0;
                let retainerHours = 0;
                let retainerIncome = 0;
                let dataRows = 0;
                const expenses = [];
                const allDates = [];

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row[0] == null) continue;
                    dataRows++;
                    const itemType     = row[8];
                    const qty          = parseFloat(row[9]  || 0);
                    const amount       = parseFloat(row[11] || 0);
                    const colO         = parseFloat(row[14] || 0);
                    const isRetainer   = row[29];
                    const registeredBy = (row[2] || '').toString().trim();
                    const client       = row[3];
                    const description  = row[6];
                    const dateRaw      = row[1];

                    const d = parseXlDate(dateRaw);
                    if (d) allDates.push(d);

                    if (itemType === '×©×¢×•×ª ×¢×‘×•×“×”') totalHours += qty;
                    if (!isNaN(amount)) totalBilling += amount;

                    // ×¨×™×˜×™×™× ×¨ â€” ×¢××•×“×” AD = '×›×Ÿ'
                    if (isRetainer === '×›×Ÿ') {
                        if (itemType === '×©×¢×•×ª ×¢×‘×•×“×”' && !isNaN(qty)) retainerHours += qty;
                        if (!isNaN(colO) && colO > 0)                  retainerIncome += colO;
                    }

                    // ×¤×™×¦×•×œ ×—×™×•×‘×™× ×œ×¤×™ ×©×•×ª×¤×” - ××’×™×¢ ××™×™×‘×•× ODCANIT ×‘×œ×‘×“

                    if (itemType && itemType !== '×©×¢×•×ª ×¢×‘×•×“×”' && amount > 0) {
                        const dateStr = d
                            ? `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`
                            : '';
                        expenses.push({ id:i, date:dateStr, registeredBy:registeredBy||'', client:client||'', description:description||'', item:itemType, amount, checkedSharon:false, checkedOrit:false });
                    }
                }

                // â”€â”€ ×•×œ×™×“×¦×™×•×ª â”€â”€
                const errors = [];
                const warnings = [...checkDateMatch(allDates, '×§×•×‘×¥ ×”×—×™×•×‘×™×')];

                if (dataRows === 0)      errors.push('×”×§×•×‘×¥ ×¨×™×§ â€” ×œ× × ××¦××• ×©×•×¨×•×ª × ×ª×•× ×™×');
                if (totalHours === 0)    errors.push('×œ× × ××¦××• ×©×¢×•×ª ×¢×‘×•×“×” (×¢××•×“×” J ×‘×©×•×¨×•×ª "×©×¢×•×ª ×¢×‘×•×“×”" = 0)');
                if (totalBilling === 0)  errors.push('×¡×”"×› ×—×™×•×‘×™× ×”×•× 0 â€” ×™×™×ª×›×Ÿ ×©×”×§×•×‘×¥ ×©×’×•×™');
                if (totalHours > 500)    warnings.push(`××¡×¤×¨ ×”×©×¢×•×ª (${totalHours}) ×’×‘×•×” ×××•×“ â€” ×‘×“×•×§ × ×ª×•× ×™×`);
                if (totalBilling > 5000000) warnings.push(`×¡×”"×› ×—×™×•×‘×™× (â‚ª${Math.round(totalBilling).toLocaleString()}) ×’×‘×•×” ×××•×“ â€” ×‘×“×•×§ × ×ª×•× ×™×`);

                if (errors.length) {
                    setImportMsg({type:'err', text:`âŒ ×§×•×‘×¥ ×œ× ×—×•×§×™: ${errors.join(' | ')}`});
                    e.target.value = ''; return;
                }

                const wd = selMonth
                    ? workdaysInMonth(selYear, parseInt(selMonth))
                    : workdaysInMonth(new Date().getFullYear(), new Date().getMonth()+1);

                setCur(p => ({
                    ...p,
                    billingHours:  String(Math.round(totalHours * 100) / 100),
                    totalBillings: String(Math.round(totalBilling * 100) / 100),
                    workDays:      String(wd),
                    retainerHours: retainerHours > 0 ? String(Math.round(retainerHours * 100) / 100) : p.retainerHours,
                    retainerFee:   retainerIncome > 0 ? String(Math.round(retainerIncome * 100) / 100) : p.retainerFee,
                    // sharonBilling/oritBilling ××’×™×¢×™× ××™×™×‘×•× ODCANIT ×‘×œ×‘×“ - ×œ× ××§×•×‘×¥ Excel
                }));

                setImportedExpenses(expenses);
                if (expenses.length > 0) setShowExpenses(true);

                const retainerLine = retainerHours > 0
                    ? ` | ×©×¢×•×ª ×¨×™×˜×™×™× ×¨: ${Math.round(retainerHours*100)/100}`
                    : '';
                const noRetainerFeeWarning = retainerHours > 0 && retainerIncome === 0
                    ? ` | âš ï¸ ×¡×›×•× ×“××™ ×”×¨×™×˜×™×™× ×¨ ××™× ×• ××•×¤×™×¢ ×‘×§×•×‘×¥ ×”×—×™×•×‘×™× â€” ×™×© ×œ×”×–×™×Ÿ ××•×ª×• ×™×“× ×™×ª ×‘×©×“×” "×“××™ ×¨×™×˜×™×™× ×¨"`
                    : '';
                const warnText = warnings.length ? ` | ${warnings.join(' | ')}` : '';
                const hasWarnings = warnings.length > 0 || noRetainerFeeWarning;
                setImportMsg({type: hasWarnings ? 'warn' : 'ok',
                    text:`âœ… ×™×•×‘× â€” ${Math.round(totalHours*100)/100} ×©×¢×•×ª | â‚ª${Math.round(totalBilling).toLocaleString()} ×—×™×•×‘×™× | ${wd} ×™××™ ×¢×‘×•×“×” | ${expenses.length} ×”×•×¦××•×ª${retainerLine}${noRetainerFeeWarning}${warnText}`});
            } catch(err) {
                setImportMsg({type:'err', text:`âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: ${err.message}`});
            }
            e.target.value = '';
        };
        reader.readAsArrayBuffer(file);
    };

    // ×¡×”"×› ×”×•×¦××•×ª ××¡×•×× ×•×ª ×œ×›×œ ×©×•×ª×¤×”
    // ×§×•×“× ×‘×•×“×§×™× ×× ×™×© ×¢×¨×›×™× ×©××•×¨×™× ××”××•×“×œ ×”×—×“×©
    const sharonExpensesTotal = cur.sharonExpenses || importedExpenses.filter(e=>e.checkedSharon).reduce((s,e)=>s+e.amount,0);
    const oritExpensesTotal   = cur.oritExpenses || importedExpenses.filter(e=>e.checkedOrit).reduce((s,e)=>s+e.amount,0);

    // ×™×™×‘×•× ×§×•×‘×¥ ×—×©×‘×•× ×™×•×ª â€” ×¢××•×“×•×ª N (××¢"×) ×•-O (×¡×”"×›)
    const handleInvoicesImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const wb = XLSX.read(ev.target.result, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});

                // ×‘×“×™×§×ª ×¢××•×“×•×ª ×—×•×‘×”
                const headers = rows[0] || [];
                if (headers[13] == null || headers[14] == null) {
                    setImportMsg({type:'err', text:'âŒ ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ: ×—×¡×¨×•×ª ×¢××•×“×•×ª N ××• O. ×•×“× ×©×–×”×• ×§×•×‘×¥ ×—×©×‘×•× ×™×•×ª ×ª×§×™×Ÿ.'});
                    e.target.value = ''; return;
                }

                let totalVAT = 0;
                let totalWithVAT = 0;
                let dataRows = 0;
                const allDates = [];

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row[0] == null) continue;
                    dataRows++;
                    const vat   = parseFloat(row[13] || 0);
                    const total = parseFloat(row[14] || 0);
                    const d     = parseXlDate(row[2]);  // C â€” ×ª××¨×™×š
                    if (d) allDates.push(d);
                    if (!isNaN(vat))   totalVAT     += vat;
                    if (!isNaN(total)) totalWithVAT += total;
                }

                // â”€â”€ ×•×œ×™×“×¦×™×•×ª â”€â”€
                const errors = [];
                const warnings = [...checkDateMatch(allDates, '×§×•×‘×¥ ×”×—×©×‘×•× ×™×•×ª')];

                if (dataRows === 0)       errors.push('×”×§×•×‘×¥ ×¨×™×§ â€” ×œ× × ××¦××• ×©×•×¨×•×ª × ×ª×•× ×™×');
                if (totalWithVAT === 0)   errors.push('×¡×”"×› ×”×›× ×¡×•×ª (×¢××•×“×” O) ×”×•× 0 â€” ×™×™×ª×›×Ÿ ×©×”×§×•×‘×¥ ×©×’×•×™');
                if (totalVAT === 0)       errors.push('×¡×”"×› ××¢"× (×¢××•×“×” N) ×”×•× 0 â€” ×™×™×ª×›×Ÿ ×©×”×§×•×‘×¥ ×©×’×•×™');
                if (totalVAT > totalWithVAT) errors.push('×”××¢"× ×’×‘×•×” ××¡×”"×› ×”×”×›× ×¡×•×ª â€” × ×ª×•× ×™× ×œ× ×”×’×™×•× ×™×™×');
                if (totalWithVAT > 10000000) warnings.push(`×¡×”"×› ×”×›× ×¡×•×ª (â‚ª${Math.round(totalWithVAT).toLocaleString()}) ×’×‘×•×” ×××•×“ â€” ×‘×“×•×§ × ×ª×•× ×™×`);
                const vatRate = totalWithVAT > 0 ? totalVAT / totalWithVAT : 0;
                if (vatRate > 0 && (vatRate < 0.10 || vatRate > 0.25)) warnings.push(`×©×™×¢×•×¨ ×”××¢"× (${(vatRate*100).toFixed(1)}%) ×—×¨×™×’ â€” ×¦×¤×•×™ ~18%`);

                if (errors.length) {
                    setImportMsg({type:'err', text:`âŒ ×§×•×‘×¥ ×œ× ×—×•×§×™: ${errors.join(' | ')}`});
                    e.target.value = ''; return;
                }

                setCur(p => ({
                    ...p,
                    incomeWithVAT: String(Math.round(totalWithVAT * 100) / 100),
                    vatToPay:      String(Math.round(totalVAT * 100) / 100),
                }));

                const warnText = warnings.length ? ` | ${warnings.join(' | ')}` : '';
                setImportMsg({type: warnings.length ? 'warn' : 'ok',
                    text:`âœ… ×—×©×‘×•× ×™×•×ª ×™×•×‘××• â€” ×”×›× ×¡×•×ª: â‚ª${Math.round(totalWithVAT).toLocaleString()} | ××¢"×: â‚ª${Math.round(totalVAT).toLocaleString()} (${(vatRate*100).toFixed(1)}%)${warnText}`});
            } catch(err) {
                setImportMsg({type:'err', text:`âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: ${err.message}`});
            }
            e.target.value = '';
        };
        reader.readAsArrayBuffer(file);
    };

    useEffect(()=>{
        // × ×¡×” ×œ×˜×¢×•×Ÿ ××”××¤×ª×— ×”×—×“×©
        let saved = localStorage.getItem('lawFin_v2');
        // ×‘× ×” ×‘×¡×™×¡ ××”× ×ª×•× ×™× ×”×”×™×¡×˜×•×¨×™×™×
        const init = {};
        for (const [k,v] of Object.entries(HISTORICAL)) {
            init[k] = {...EMPTY, profitDistribution: v, transfers:[]};
        }
        if (saved) {
            // ××™×–×•×’: × ×ª×•× ×™× ×©××•×¨×™× ×× ×¦×—×™×, ××‘×œ ×”×”×™×¡×˜×•×¨×™×” ×ª××™×“ ×©×
            const parsed = JSON.parse(saved);
            for (const [k,v] of Object.entries(parsed)) {
                init[k] = {...(init[k]||{...EMPTY,transfers:[]}), ...v};
            }
        }
        setData(init);
        localStorage.setItem('lawFin_v2', JSON.stringify(init));
        const c = localStorage.getItem('avgVAT_v2');
        if (c) setAvgVAT(parseFloat(c));
        const ab = localStorage.getItem('autoBackupEnabled');
        if (ab) setAutoBackupEnabled(ab === 'true');
        
        // Load GitHub settings
        const token = localStorage.getItem('githubToken');
        const syncEnabled = localStorage.getItem('githubSyncEnabled');
        if (token) setGithubToken(token);
        if (syncEnabled) setGithubSyncEnabled(syncEnabled === 'true');
        
        // Load from GitHub if sync is enabled
        if (token && syncEnabled === 'true') {
            loadFromGitHub(token);
        }
    },[]);

    useEffect(()=>{
        if (!Object.keys(data).length) return;
        localStorage.setItem('lawFin_v2', JSON.stringify(data));
        // ×”×•×¡×¨ ×—×™×©×•×‘ ××•×˜×•××˜×™ ×©×œ ×××•×¦×¢ ×–×™×›×•×™ ××¢"× - × ×©××¨ ×¢×¨×š ×§×‘×•×¢ ×©×œ 2500
    },[data]);

    useEffect(()=>{
        if (!selMonth) return;
        const key = `${selYear}-${selMonth}`;
        setCur(data[key] ? {...EMPTY, ...data[key]} : {...EMPTY});
    },[selMonth, selYear, data]);

    const set = (k,v) => setCur(p=>({...p,[k]:v}));

    // GitHub Sync Functions
    const GITHUB_CONFIG = {
        owner: 'eylonrosner-collab',
        repo: 'law-office-finance',
        path: 'data.json',
        branch: 'main'
    };

    const saveToGitHub = async (dataToSave) => {
        if (!githubToken || !githubSyncEnabled) return;
        
        setSyncStatus('syncing');
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            
            // Get current file SHA
            const getResponse = await fetch(url, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            let sha = '';
            if (getResponse.ok) {
                const fileData = await getResponse.json();
                sha = fileData.sha;
            }
            
            // Prepare data
            const content = {
                data: dataToSave,
                avgVAT: avgVAT,
                lastUpdate: new Date().toISOString()
            };
            
            // Update file
            const updateResponse = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    message: `Update data - ${new Date().toLocaleString('he-IL')}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
                    sha: sha,
                    branch: GITHUB_CONFIG.branch
                })
            });
            
            if (updateResponse.ok) {
                setSyncStatus('synced');
                setTimeout(() => setSyncStatus(''), 2000);
            } else {
                setSyncStatus('error');
                console.error('GitHub sync error:', await updateResponse.text());
            }
        } catch (error) {
            setSyncStatus('error');
            console.error('GitHub sync error:', error);
        }
    };

    const loadFromGitHub = async (token) => {
        if (!token) token = githubToken;
        if (!token) return;
        
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                const fileData = await response.json();
                const content = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
                
                if (content.data) {
                    setData(content.data);
                    localStorage.setItem('lawFin_v2', JSON.stringify(content.data));
                }
                if (content.avgVAT) {
                    setAvgVAT(content.avgVAT);
                    localStorage.setItem('avgVAT_v2', content.avgVAT.toString());
                }
                
                console.log('âœ… Data loaded from GitHub');
            }
        } catch (error) {
            console.error('Error loading from GitHub:', error);
        }
    };

    // Auto-sync when data changes
    useEffect(() => {
        if (githubSyncEnabled && Object.keys(data).length > 0) {
            const timeoutId = setTimeout(() => {
                saveToGitHub(data);
            }, 2000); // Wait 2 seconds after last change
            
            return () => clearTimeout(timeoutId);
        }
    }, [data, githubSyncEnabled]);

    const saveMonth = () => {
        if (!selMonth) { alert('×× × ×‘×—×¨ ×—×•×“×©'); return; }
        const key = `${selYear}-${selMonth}`;
        const now = new Date();
        const savedAt = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        setData(p=>{
            const newData = {...p, [key]: {...(p[key]||{}), ...cur, savedAt}};
            if (autoBackupEnabled) {
                setTimeout(() => {
                    const backup = { data: newData, avgVAT, exportedAt: new Date().toLocaleString('he-IL') };
                    const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `×’×™×‘×•×™-××•×˜×•××˜×™-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                }, 100);
            }
            return newData;
        });
        alert('× ×©××¨!');
    };

    const saveTransfer = (t) => {
        const key = `${selYear}-${selMonth}`;
        setData(p=>{
            const ex = p[key]||{};
            const ts = ex.transfers ? [...ex.transfers] : [];
            const idx = ts.findIndex(x=>x.partner===t.partner);
            if (idx>=0) ts[idx]=t; else ts.push(t);
            return {...p, [key]: {...ex, transfers:ts}};
        });
        setShowTransfer(false);
        alert('×”×¢×‘×¨×” × ×©××¨×”!');
    };

    const handleUpdateExpenses = ({ expenseRefunds, sharonExpenses, oritExpenses }) => {
        const key = `${selYear}-${selMonth}`;
        setData(p => {
            const ex = p[key] || {};
            const newData = {
                ...p,
                [key]: {
                    ...ex,
                    expenseRefunds,
                    sharonExpenses,
                    oritExpenses
                }
            };
            // ×©××™×¨×” ××•×˜×•××˜×™×ª
            saveData(newData);
            return newData;
        });
        
        // ×¢×“×›×•×Ÿ cur ×™×©×™×¨×•×ª
        setCur(prev => ({
            ...prev,
            expenseRefunds,
            sharonExpenses,
            oritExpenses
        }));
        
        // ×¢×“×›×•×Ÿ importedExpenses ×¢× ×”×¡×™××•× ×™×
        setImportedExpenses(prev => prev.map(exp => ({
            ...exp,
            checkedSharon: expenseRefunds[exp.id]?.refund && expenseRefunds[exp.id]?.partner === 'sharon',
            checkedOrit: expenseRefunds[exp.id]?.refund && expenseRefunds[exp.id]?.partner === 'orit'
        })));
    };

    const editTransferFromAll = (transfer) => {
        // ××¢×‘×¨ ×œ×—×•×“×© ×”×¨×œ×•×•× ×˜×™ ×•×¤×ª×™×—×ª ××•×“×œ ×”×¢×‘×¨×” ×œ×¢×¨×™×›×”
        const [year, month] = transfer.key.split('-');
        setSelYear(parseInt(year));
        setSelMonth(month);
        setShowAllTransfers(false);
        
        // × ×•×ª×Ÿ ×–××Ÿ ×œ-useEffect ×œ×”×ª×¢×“×›×Ÿ
        setTimeout(() => {
            setShowTransfer(true);
        }, 100);
    };

    const deleteTransferFromAll = (monthKey, transferIndex) => {
        setData(p => {
            const ex = p[monthKey] || {};
            const ts = ex.transfers ? [...ex.transfers] : [];
            ts.splice(transferIndex, 1);
            const ret = {...p, [monthKey]: {...ex, transfers: ts}};
            saveData(ret);
            return ret;
        });
    };

    const importFromOdcanit = async () => {
        if (!selMonth || !selYear) {
            alert('× × ×œ×‘×—×•×¨ ×—×•×“×© ×•×©× ×” ×œ×¤× ×™ ×”×™×™×‘×•×');
            return;
        }

        const monthName = MONTHS.find(m=>m.v===selMonth)?.l||'';
        const confirmed = window.confirm(
            `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×™×™×‘× × ×ª×•× ×™× ××¢×•×“×›× ×™×ª ×¢×‘×•×¨ ${monthName} ${selYear}?\n\n` +
            `âš ï¸ ×¤×¢×•×œ×” ×–×• ×ª×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™× ×‘×—×•×“×© ×–×”!\n\n` +
            `×”× ×ª×•× ×™× ×©×™×•×‘××•:\n` +
            `â€¢ ×¡×›×•× ×—×™×•×‘×™× ×•×©×¢×•×ª\n` +
            `â€¢ ×¨×™×˜×™×™× ×¨ (×× ×§×™×™×)\n` +
            `â€¢ ×”×›× ×¡×•×ª ×›×•×œ×œ ××¢"×\n` +
            `â€¢ ××¢"× ×œ×ª×©×œ×•×\n` +
            `â€¢ ×”×•×¦××•×ª ×›×•×œ×œ ××¢"×`
        );

        if (!confirmed) return;

        setOdcanitImporting(true);
        try {
            const year = selYear;
            const month = parseInt(selMonth);
            
            // ×’×™×©×” 1: × ×™×¡×™×•×Ÿ ×œ×”×ª×—×‘×¨ ×œ-API Server (×× ×§×™×™×)
            let result = null;
            try {
                const queries = {
                    billing: `
                        SELECT 
                            -- ×©×¢×•×ª ×—×™×•×‘×™ ×—×•×“×©×™ = ×›×œ ×©×¢×•×ª ×”×—×™×•×‘ ×›×•×œ×œ ×¨×™×˜×™×™× ×¨ (×œ× ×”×•×¦××•×ª ×œ×§×•×—)
                            SUM(CASE 
                                WHEN Category IN (0, 1, 3, 4)
                                THEN hoursCount 
                                ELSE 0 
                            END) as billingHours,

                            -- ×©×¢×•×ª ×¨×™×˜×™×™× ×¨ = ×©×¢×•×ª ×©×œ ×œ×§×•×— ×“×Ÿ ×ª×—×‘×•×¨×” ×‘×œ×‘×“
                            SUM(CASE 
                                WHEN SideCounter = 12 AND Category IN (0, 1, 3, 4)
                                THEN hoursCount 
                                ELSE 0 
                            END) as retainerHours,

                            -- ×¨×™×˜×™×™× ×¨ ×œ×œ× ××¢"× ×•×œ×œ× ×”×•×¦××•×ª = ×¡×›×•× ×¨×™×˜×™×™× ×¨ × ×˜×• ×‘×œ×‘×“
                            SUM(CASE 
                                WHEN SideCounter = 12 AND Category IN (0, 1, 3, 4)
                                THEN AmountInNIS
                                ELSE 0 
                            END) as retainerFee,

                            -- ×¡×”"×› ×—×™×•×‘×™ ×©×¢×•×ª (×›×•×œ×œ ×”× ×—×•×ª, ×œ×œ× ×”×•×¦××•×ª ×œ×§×•×—)
                            SUM(CASE 
                                WHEN Category IN (0, 1, 3, 4)
                                THEN AmountInNIS ELSE 0
                            END) as totalBillings,

                            -- ×”×•×¦××•×ª ×œ×§×•×— (Category = 2, ×œ×œ× ××¢"×)
                            SUM(CASE 
                                WHEN Category = 2
                                THEN AmountInNIS ELSE 0
                            END) as billingExpenses,

                            -- ×©×¢×•×ª ×©×¨×•×Ÿ ×¢×œ ×¨×™×˜×™×™× ×¨ (×“×Ÿ ×ª×—×‘×•×¨×”)
                            SUM(CASE 
                                WHEN SideCounter = 12 AND Category IN (0, 1, 3, 4) AND u.FullName LIKE '%×©×¨×•×Ÿ%'
                                THEN hoursCount ELSE 0 
                            END) as sharonRetainerHours,

                            -- ×©×¢×•×ª ××•×¨×™×ª ×¢×œ ×¨×™×˜×™×™× ×¨ (×“×Ÿ ×ª×—×‘×•×¨×”)
                            SUM(CASE 
                                WHEN SideCounter = 12 AND Category IN (0, 1, 3, 4) AND u.FullName LIKE '%××•×¨×™×ª%'
                                THEN hoursCount ELSE 0 
                            END) as oritRetainerHours,

                            -- ×—×™×•×‘×™ ×©×¨×•×Ÿ - ×©×¢×•×ª ×¢×‘×•×“×” + × ×¡×™×¢×•×ª (×–×× ×™ - ×¢×“ ×©× ×ª×§×Ÿ)
                            SUM(CASE 
                                WHEN SideCounter != 12 AND Category IN (0, 1) AND u.FullName LIKE '%×©×¨×•×Ÿ%'
                                THEN AmountInNIS ELSE 0 
                            END) as sharonRegularBilling,

                            -- ×—×™×•×‘×™ ××•×¨×™×ª - ×©×¢×•×ª ×¢×‘×•×“×” + × ×¡×™×¢×•×ª (×–×× ×™ - ×¢×“ ×©× ×ª×§×Ÿ)
                            SUM(CASE 
                                WHEN SideCounter != 12 AND Category IN (0, 1) AND u.FullName LIKE '%××•×¨×™×ª%'
                                THEN AmountInNIS ELSE 0 
                            END) as oritRegularBilling

                        FROM vwExportToOuterSystems_Billing b
                        LEFT JOIN vwExportToOuterSystems_LoginUsers u ON u.UserID = b.UserID
                        WHERE YEAR(Dated) = ${year} AND MONTH(Dated) = ${month}
                    `,
                    openInvoices: `
                        SELECT 
                            ISNULL(SUM(Balance), 0) as openInvoicesTotal,
                            ISNULL(AVG(DaysNotPaid), 0) as avgDaysOverdue
                        FROM vwExportToOuterSystems_InvoiceByCategoryAndVat
                        WHERE InvStatusDesc = N'×¤×ª×•×—'
                    `,
                    allBillingsForExport: `
                        SELECT 
                            CONVERT(varchar, Dated, 23) as date,
                            Category,
                            ACTID,
                            AmountInNIS as amount,
                            hoursCount,
                            SideCounter,
                            u.FullName as registeredBy,
                            u.UserID as userId
                        FROM vwExportToOuterSystems_Billing b
                        LEFT JOIN vwExportToOuterSystems_LoginUsers u ON u.UserID = b.UserID
                        WHERE YEAR(Dated) = ${year} AND MONTH(Dated) = ${month}
                        ORDER BY Dated, Category, ACTID
                    `,
                    rawBillings: `
                        SELECT 
                            CONVERT(varchar, Dated, 23) as date,
                            Category,
                            ACTID,
                            AmountInNIS as amount,
                            hoursCount,
                            SideCounter,
                            u.FullName as userName
                        FROM vwExportToOuterSystems_Billing b
                        LEFT JOIN vwExportToOuterSystems_LoginUsers u ON u.UserID = b.UserID
                        WHERE YEAR(Dated) = ${year} AND MONTH(Dated) = ${month}
                        ORDER BY Dated, Category, ACTID
                    `,
                    income: `
                        SELECT 
                            SUM(incomeVal) as incomeWithVAT,
                            SUM(TotalTax)  as vatToPay
                        FROM (
                            SELECT 
                                DocNumber,
                                SUM(CASE WHEN DocType = 2 THEN IncomeAmount
                                         WHEN DocType = 4 THEN TotalAll
                                         ELSE 0 END) as incomeVal,
                                MAX(TotalTax) as TotalTax
                            FROM vwExportToOuterSystems_ReceiptAndIncome
                            WHERE YEAR(DocDate) = ${year} AND MONTH(DocDate) = ${month}
                            AND DocType IN (2, 4)
                            GROUP BY DocNumber
                        ) as deduped
                    `,
                    expenses: `
                        SELECT 
                            CONVERT(varchar, Dated, 23) as date,
                            CASE 
                                WHEN ACTID = 10001 THEN '×”×•×¦××•×ª ×›×œ×œ×™×•×ª'
                                WHEN ACTID = 7 THEN '× ×¡×™×¢×” ×œ×¤×™ ×§"×'
                                ELSE CAST(ACTID as varchar)
                            END as description,
                            ACTDESC as billingDescription,
                            AmountWithVatInNIS as amount,
                            Category,
                            ACTID,
                            u.FullName as registeredBy
                        FROM vwExportToOuterSystems_Billing b
                        LEFT JOIN vwExportToOuterSystems_LoginUsers u ON u.UserID = b.UserID
                        WHERE YEAR(Dated) = ${year} 
                            AND MONTH(Dated) = ${month}
                            AND ACTID IN (7, 10001)
                        ORDER BY Dated
                    `,
                    expensesTotal: `
                        SELECT 
                            SUM(AmountWithVatInNIS) as expensesWithVAT
                        FROM vwExportToOuterSystems_Billing
                        WHERE YEAR(Dated) = ${year} 
                            AND MONTH(Dated) = ${month}
                            AND ACTID IN (7, 10001)
                    `,
                    allBillingsDebug: `
                        SELECT TOP 20
                            CONVERT(varchar, Dated, 23) as date,
                            Category,
                            ACTID,
                            AmountInNIS as amount,
                            hoursCount
                        FROM vwExportToOuterSystems_Billing
                        WHERE YEAR(Dated) = ${year} 
                            AND MONTH(Dated) = ${month}
                        ORDER BY Category, ACTID, Dated
                    `,
                    actidSummary: `
                        SELECT 
                            Category,
                            ACTID,
                            COUNT(*) as count,
                            SUM(AmountInNIS) as totalAmount,
                            SUM(hoursCount) as totalHours,
                            MIN(CONVERT(varchar, Dated, 23)) as firstDate,
                            MAX(CONVERT(varchar, Dated, 23)) as lastDate
                        FROM vwExportToOuterSystems_Billing
                        WHERE YEAR(Dated) = ${year} 
                            AND MONTH(Dated) = ${month}
                        GROUP BY Category, ACTID
                        ORDER BY Category, totalAmount DESC
                    `,
                    allBillingsFull: `
                        SELECT 
                            CONVERT(varchar, Dated, 23) as date,
                            Category,
                            ACTID,
                            AmountInNIS as amount,
                            hoursCount
                        FROM vwExportToOuterSystems_Billing
                        WHERE YEAR(Dated) = ${year} 
                            AND MONTH(Dated) = ${month}
                        ORDER BY Dated, ACTID
                    `
                };

                // ×—×™×©×•×‘ ×™××™ ×¢×‘×•×“×” ×‘× ×™×›×•×™ ×©×‘×ª×•×ª ×•×—×’×™ ×™×©×¨××œ
                const calcWorkDays = (y, m) => {
                    // ×—×’×™ ×™×©×¨××œ ×§×‘×•×¢×™× (×—×’/×-×“) - ×ª××¨×™×›×™× ×œ×•×¢×–×™×™× ××©×ª× ×™×, ××œ×• ×”× ×××•×¦×¢×™×
                    const HOLIDAYS = {
                        // ×¨××© ×”×©× ×” - ×¡×¤×˜××‘×¨/××•×§×˜×•×‘×¨ (×›2 ×™××™×)
                        // ×™×•× ×›×™×¤×•×¨ - ×¡×¤×˜××‘×¨/××•×§×˜×•×‘×¨ (1 ×™×•×)
                        // ×¡×•×›×•×ª+×©×"×¢ - ×¡×¤×˜××‘×¨/××•×§×˜×•×‘×¨/× ×•×‘××‘×¨ (×›2 ×™××™×)
                        // ×¤×¡×— - ××¨×¥/××¤×¨×™×œ (×›2 ×™××™×)
                        // ×©×‘×•×¢×•×ª - ×××™/×™×•× ×™ (1 ×™×•×)
                        // ×™×•× ×”×¢×¦×××•×ª - ××¤×¨×™×œ/×××™ (1 ×™×•×)
                    };

                    // ×—×’×™× ×œ×¤×™ ×©× ×” ×•××¡×¤×¨ (×‘×•×“×§×™× ×ª××¨×™×š ×¢×‘×¨×™-×œ×•×¢×–×™)
                    const israeliHolidays = {
                        2021: ['09-07','09-08','09-15','09-16','09-28','04-01','04-08','05-17'],
                        2022: ['09-26','09-27','10-04','10-17','04-21','04-28','06-05'],
                        2023: ['09-16','09-17','09-24','09-29','09-30','04-05','04-12','04-13','05-26'],
                        2024: ['10-03','10-04','10-11','10-16','10-17','04-22','04-23','04-29','06-12'],
                        2025: ['09-22','09-23','09-30','10-13','10-14','04-13','04-14','04-20','06-02','05-01'],
                        2026: ['09-11','09-12','09-19','10-02','10-03','03-30','04-06','05-21'],
                    };

                    const holidays = new Set(
                        (israeliHolidays[y] || [])
                            .filter(d => parseInt(d.split('-')[0]) === m)
                            .map(d => `${y}-${d}`)
                    );

                    let workDays = 0;
                    const daysInMonth = new Date(y, m, 0).getDate();
                    for (let d = 1; d <= daysInMonth; d++) {
                        const date = new Date(y, m - 1, d);
                        const dayOfWeek = date.getDay();
                        const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        // ×œ× ×©×™×©×™ (5), ×©×‘×ª (6), ×•×œ× ×—×’
                        if (dayOfWeek !== 5 && dayOfWeek !== 6 && !holidays.has(dateStr)) {
                            workDays++;
                        }
                    }
                    return workDays;
                };

                const calculatedWorkDays = calcWorkDays(parseInt(year), parseInt(month));

                const response = await fetch('http://localhost:5000/api/odcanit-import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        server: '172.16.19.2\\ODCANIT',
                        database: 'odlight',
                        username: 'OdcanitAPI',
                        password: '392913',
                        queries: queries
                    })
                });

                if (response.ok) {
                    const apiResult = await response.json();
                    if (apiResult.success) {
                        result = apiResult.data;
                        result.workDays = calculatedWorkDays;
                    }
                }
            } catch (apiError) {
                console.log('API Server ×œ× ×–××™×Ÿ, ×× ×¡×” ×’×™×©×” ××œ×˜×¨× ×˜×™×‘×™×ª...');
            }

            // ×’×™×©×” 2: ×× API Server ×œ× ×–××™×Ÿ, ××¤×©×¨ ×œ×˜×¢×•×Ÿ ××§×•×‘×¥ JSON ×¡×˜×˜×™
            if (!result) {
                const useStaticFile = window.confirm(
                    '×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª ×”-API.\n\n' +
                    '×”×× ×‘×¨×¦×•× ×š ×œ×˜×¢×•×Ÿ × ×ª×•× ×™× ××§×•×‘×¥ JSON ××™×•×¦×?\n\n' +
                    '(×œ×™×™×¦× × ×ª×•× ×™× ×-ODCANIT, ×”×¨×¥ ××ª ×”×¡×§×¨×™×¤×˜ odcanit_export.py)'
                );
                
                if (useStaticFile) {
                    // ×‘×§×©×ª ×§×•×‘×¥ JSON
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json';
                    fileInput.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const text = await file.text();
                            const jsonData = JSON.parse(text);
                            const monthKey = `${year}-${selMonth}`;
                            result = jsonData[monthKey];
                            
                            if (result) {
                                applyImportedData(result, monthName);
                            } else {
                                alert(`×œ× × ××¦××• × ×ª×•× ×™× ×¢×‘×•×¨ ${monthName} ${year} ×‘×§×•×‘×¥`);
                            }
                        }
                        setOdcanitImporting(false);
                    };
                    fileInput.click();
                    return; // ×××ª×™×Ÿ ×œ×˜×¢×™× ×ª ×”×§×•×‘×¥
                } else {
                    throw new Error('×™×™×‘×•× ×‘×•×˜×œ');
                }
            }

            // ×”×—×œ×ª ×”× ×ª×•× ×™× ×©×™×•×‘××•
            applyImportedData(result, monthName);

        } catch (error) {
            console.error('Error importing from ODCANIT:', error);
            const errorMsg = error.message || String(error);
            const isSQLError = errorMsg.includes('Invalid column name') || errorMsg.includes('42S22');
            
            if (isSQLError) {
                alert(
                    `âŒ ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™× ×¢×•×“×›× ×™×ª\n\n` +
                    `×”×‘×¢×™×”: ××‘× ×” ×”×˜×‘×œ××•×ª ×‘××¡×“ ×”× ×ª×•× ×™× ×”×©×ª× ×” ××• ×©××™×Ÿ ×’×™×©×” ×œ×©×“×•×ª ×”× ×“×¨×©×™×.\n\n` +
                    `ğŸ’¡ ×¤×ª×¨×•×Ÿ ×–×× ×™:\n` +
                    `×”×©×ª××© ×‘×™×™×‘×•× ×—×™×•×‘×™× ×××§×¡×œ ×“×¨×š âš™ï¸ ×”×’×“×¨×•×ª â†’ ×™×™×‘×•× ×—×™×•×‘×™× ×××§×¡×œ\n` +
                    `×–×” ×™××¤×©×¨ ×œ×š ×œ×”××©×™×š ×œ×¢×‘×•×“ ×•×œ×¡××Ÿ ×”×•×¦××•×ª ×œ×”×—×–×¨.\n\n` +
                    `ğŸ“§ ×œ×¤×ª×¨×•×Ÿ ×§×‘×•×¢: ×¦×•×¨ ×§×©×¨ ×¢× ×ª××™×›×” ×˜×›× ×™×ª`
                );
            } else {
                alert(
                    `âŒ ×©×’×™××” ×‘×™×™×‘×•× ××¢×•×“×›× ×™×ª:\n\n${errorMsg}\n\n` +
                    `×¤×ª×¨×•× ×•×ª ××¤×©×¨×™×™×:\n` +
                    `1. ×”×¨×¥ ××ª ×”×©×¨×ª: python odcanit_api_server.py\n` +
                    `2. ×™×™×¦× × ×ª×•× ×™× ×œ-JSON: python odcanit_export.py\n` +
                    `3. ×‘×“×•×§ ×—×™×‘×•×¨ ×œ×¨×©×ª ×•×œ××¡×“ ×”× ×ª×•× ×™×\n\n` +
                    `ğŸ’¡ ×‘×™× ×ª×™×™×: ×”×©×ª××© ×‘×™×™×‘×•× ×××§×¡×œ ×“×¨×š ×”×”×’×“×¨×•×ª`
                );
            }
        } finally {
            setOdcanitImporting(false);
        }
    };

    const applyImportedData = (result, monthName) => {
        console.log('[DEBUG] Full result:', result);
        console.log('[DEBUG] result.expenses:', result.expenses);
        console.log('[DEBUG] result.expensesTotal:', result.expensesTotal);
        console.log('[DEBUG] result.openInvoices:', result.openInvoices);
        console.log('[DEBUG] result.openInvoices?.openInvoicesTotal:', result.openInvoices?.openInvoicesTotal);
        console.log('[DEBUG] result.openInvoices?.avgDaysOverdue:', result.openInvoices?.avgDaysOverdue);
        console.log('[DEBUG] result.allBillingsForExport:', result.allBillingsForExport);
        console.log('[DEBUG] result.allBillingsForExport type:', typeof result.allBillingsForExport);
        
        // ×™×¦×•× × ×ª×•× ×™× ×œ×§×•×‘×¥ DEBUG
        
        // ×ª×™×§×•×Ÿ: ×”×©×¨×ª ××—×–×™×¨ ××•×‘×™×™×§×˜ ××—×“ ×‘××§×•× ××¢×¨×š ×›×©×™×© ×©×•×¨×” ××—×ª
        const normalizeToArray = (data) => {
            if (!data) return [];
            if (Array.isArray(data)) return data;
            if (typeof data === 'object' && Object.keys(data).length > 0) return [data];
            return [];
        };
        
        const allBillingsArray = normalizeToArray(result.allBillingsForExport);
        
        console.log('[DEBUG] allBillingsArray:', allBillingsArray);
        console.log('[DEBUG] allBillingsArray.length:', allBillingsArray.length);
        
        // ×× ××™×Ÿ × ×ª×•× ×™× ××”×©×¨×ª, × ×™×¦×•×¨ ×¡×™×›×•× ××”× ×ª×•× ×™× ×”×§×™×™××™×
        const expensesArray = normalizeToArray(result.expenses);
        
        const debugData = {
            timestamp: new Date().toISOString(),
            monthName,
            year: selYear,
            month: selMonth,
            
            // â­ ×¡×™×›×•× ××”×©××™×œ×ª×•×ª ×©×¢×•×‘×“×•×ª â­
            BILLING_SUMMARY: result.billing,
            
            // â­ ×”×•×¦××•×ª ×©×—×–×¨×• ××”×©×¨×ª â­
            EXPENSES_FROM_SERVER: expensesArray,
            EXPENSES_COUNT: expensesArray.length,
            
            // â­ ×›×œ ×”×—×™×•×‘×™× (×× ×”×©×¨×ª ×”×—×–×™×¨) â­
            ALL_BILLINGS: allBillingsArray,
            ALL_BILLINGS_COUNT: allBillingsArray.length,
            
            // × ×™×ª×•×—
            ANALYSIS: {
                totalBillings: result.billing?.totalBillings || 0,
                billingHours: result.billing?.billingHours || 0,
                billingExpenses: result.billing?.billingExpenses || 0,
                
                sharon: {
                    regularBilling: result.billing?.sharonRegularBilling || 0,
                    retainerHours: result.billing?.sharonRetainerHours || 0
                },
                orit: {
                    regularBilling: result.billing?.oritRegularBilling || 0,
                    retainerHours: result.billing?.oritRetainerHours || 0
                },
                
                retainer: {
                    hours: result.billing?.retainerHours || 0,
                    fee: result.billing?.retainerFee || 0
                }
            },
            
            // ×”×¡×‘×¨×™×
            EXPLANATION: {
                message: "âš ï¸ ×”×©×¨×ª ×œ× ××—×–×™×¨ ××ª allBillingsForExport - ×”×©××™×œ×ª×” ×œ× ×¢×•×‘×“×ª",
                problem: "×”×©×¨×ª Python/API ×œ× ××›×™×¨ ×‘×©××™×œ×ª×•×ª ×—×“×©×•×ª ×©××•×¡×™×¤×™× ×‘-HTML",
                solution: "×¦×¨×™×š ×œ×ª×§×Ÿ ××ª ×”×©×¨×ª ××• ×œ×”×©×ª××© ×‘×©××™×œ×ª×•×ª ×©×›×‘×¨ ×§×™×™××•×ª",
                
                what_we_have: {
                    billing_summary: "×¡×™×›×•××™× - ×¢×•×‘×“ âœ…",
                    expenses: `${expensesArray.length} ×”×•×¦××•×ª - ${expensesArray.length > 0 ? '×¢×•×‘×“ âœ…' : '×¨×™×§ âŒ'}`,
                    allBillings: `${allBillingsArray.length} ×—×™×•×‘×™× - ${allBillingsArray.length > 0 ? '×¢×•×‘×“ âœ…' : '×œ× ×¢×•×‘×“ âŒ'}`
                },
                
                category_meanings: {
                    "0": "×©×¢×•×ª ×¢×‘×•×“×” ×¨×’×™×œ×•×ª",
                    "1": "× ×¡×™×¢×•×ª (×”×•×¦××”)",
                    "2": "×”×•×¦××•×ª ×œ×§×•×—",
                    "3": "×”× ×—×•×ª",
                    "4": "×¨×™×˜×™×™× ×¨"
                },
                
                current_state: {
                    sharon_orit_billing_now_zero: "×©×™× ×™× ×• ×œ-Category=0 ×‘×œ×‘×“, ××– ×¢×›×©×™×• 0",
                    billingExpenses_still_works: result.billing?.billingExpenses + " â‚ª",
                    expenses_query_filter: "Category IN (1, 2) - × ×¡×™×¢×•×ª ×•×”×•×¦××•×ª"
                }
            }
        };
        
        // ×—×™×©×•×‘ ×—×™×•×‘×™ ×©×¨×•×Ÿ/××•×¨×™×ª:
        // ×¨×™×˜×™×™× ×¨ â†’ ×œ×¤×™ ×™×—×¡ ×©×¢×•×ª ×©×›×œ ×©×•×ª×¤×” ×‘×™×¦×¢×” ×¢×‘×•×¨ ×“×Ÿ ×ª×—×‘×•×¨×”
        // ×—×™×•×‘×™× ×¨×’×™×œ×™× â†’ ×œ×¤×™ ×©×¢×•×ª ×¢×‘×•×“×” ×‘×œ×‘×“ (×œ×œ× ×”×•×¦××•×ª)
        const sharonRetH = parseFloat(result.billing?.sharonRetainerHours || 0);
        const oritRetH   = parseFloat(result.billing?.oritRetainerHours   || 0);
        const totalRetH  = sharonRetH + oritRetH;
        const retainerFeeVal = result.billing?.retainerFee 
            ? Math.round(parseFloat(result.billing.retainerFee)) : 0;

        const sharonRetainerShare = totalRetH > 0
            ? Math.round(retainerFeeVal * (sharonRetH / totalRetH))
            : Math.round(retainerFeeVal / 2);

        const oritRetainerShare = totalRetH > 0
            ? Math.round(retainerFeeVal * (oritRetH / totalRetH))
            : Math.round(retainerFeeVal / 2);

        const sharonRegular = Math.round(parseFloat(result.billing?.sharonRegularBilling || 0));
        const oritRegular   = Math.round(parseFloat(result.billing?.oritRegularBilling   || 0));

        console.log(`[×™×™×‘×•× ODCANIT] sharonRetainerHours=${sharonRetH}, oritRetainerHours=${oritRetH}, totalRetH=${totalRetH}`);
        console.log(`[×™×™×‘×•× ODCANIT] retainerFee=${retainerFeeVal}, sharonRetainerShare=${sharonRetainerShare}, oritRetainerShare=${oritRetainerShare}`);
        console.log(`[×™×™×‘×•× ODCANIT] sharonRegular=${sharonRegular}, oritRegular=${oritRegular}`);

        const importedData = {
            billingHours: result.billing?.billingHours 
                ? Math.round(parseFloat(result.billing.billingHours) * 100) / 100 
                : '',
            retainerHours: result.billing?.retainerHours 
                ? Math.round(parseFloat(result.billing.retainerHours) * 100) / 100 
                : '',
            totalBillings: result.billing?.totalBillings 
                ? Math.round(parseFloat(result.billing.totalBillings)) 
                : '',
            billingExpenses: result.billing?.billingExpenses
                ? Math.round(parseFloat(result.billing.billingExpenses))
                : '',
            retainerFee: retainerFeeVal,
            sharonBilling: sharonRegular + sharonRetainerShare,
            oritBilling:   oritRegular   + oritRetainerShare,
            incomeWithVAT: result.income?.incomeWithVAT 
                ? Math.round(parseFloat(result.income.incomeWithVAT)) 
                : '',
            vatToPay: result.income?.vatToPay 
                ? Math.round(parseFloat(result.income.vatToPay)) 
                : '',
            expensesWithVAT: cur.expensesWithVAT || 0,
            expenses: (() => {
                // × ×™×¡×™×•×Ÿ ×œ×”×©×ª××© ×‘×ª×•×¦××•×ª ×”×©××™×œ×ª×”
                const expensesFromQuery = Array.isArray(result.expenses) 
                    ? result.expenses 
                    : (result.expenses && Object.keys(result.expenses).length > 0 ? [result.expenses] : []);
                
                // ×‘×“×™×§×”: ×”×× ×™×© ×”×•×¦××•×ª ××”×©××™×œ×ª×”?
                if (expensesFromQuery.length > 0) {
                    return expensesFromQuery;
                }
                
                // ×× ××™×Ÿ - × ×™×¦×•×¨ ×”×•×¦××” ×¡×™× ×ª×˜×™×ª ××ª×•×š billingExpenses
                const billingExpensesTotal = result.billing?.billingExpenses || 0;
                if (billingExpensesTotal > 0) {
                    return [{
                        date: `${year}-${String(month).padStart(2, '0')}-01`,
                        description: '×”×•×¦××•×ª ×œ×§×•×— (Category = 2)',
                        amount: billingExpensesTotal,
                        Category: 2,
                        ACTID: 0,
                        _synthetic: true
                    }];
                }
                
                return [];
            })(),
            workDays: result.workDays || cur.workDays || '',
            actualVATPaid: cur.actualVATPaid || '',
            openInvoices: (() => {
                console.log('[DEBUG] Processing openInvoices, raw data:', result.openInvoices);
                // Handle if server returns array with single object
                let openInvData = result.openInvoices;
                if (Array.isArray(openInvData) && openInvData.length > 0) {
                    openInvData = openInvData[0];
                }
                console.log('[DEBUG] openInvData after array check:', openInvData);
                
                if (openInvData && typeof openInvData.openInvoicesTotal === 'number') {
                    const value = Math.round(parseFloat(openInvData.openInvoicesTotal));
                    console.log('[DEBUG] Returning openInvoices value:', value);
                    return value;
                }
                console.log('[DEBUG] Using existing cur.openInvoices:', cur.openInvoices);
                return cur.openInvoices || '';
            })(),
            avgDaysOverdue: (() => {
                console.log('[DEBUG] Processing avgDaysOverdue, raw data:', result.openInvoices);
                // Handle if server returns array with single object
                let openInvData = result.openInvoices;
                if (Array.isArray(openInvData) && openInvData.length > 0) {
                    openInvData = openInvData[0];
                }
                console.log('[DEBUG] openInvData after array check:', openInvData);
                
                if (openInvData && typeof openInvData.avgDaysOverdue === 'number') {
                    const value = Math.round(parseFloat(openInvData.avgDaysOverdue) * 10) / 10;
                    console.log('[DEBUG] Returning avgDaysOverdue value:', value);
                    return value;
                }
                console.log('[DEBUG] Using existing cur.avgDaysOverdue:', cur.avgDaysOverdue);
                return cur.avgDaysOverdue || '';
            })(),
            activeClients: (() => {
                // Count unique clients (SideCounter) from billing data
                const allBillings = Array.isArray(result.allBillingsForExport) 
                    ? result.allBillingsForExport 
                    : (result.allBillingsForExport ? [result.allBillingsForExport] : []);
                
                if (allBillings.length > 0) {
                    // Filter out billings without client (SideCounter) and retainer client (12)
                    const uniqueClients = new Set(
                        allBillings
                            .filter(b => b.SideCounter && b.SideCounter !== 12)
                            .map(b => b.SideCounter)
                    );
                    console.log('[DEBUG] Active clients count:', uniqueClients.size);
                    return uniqueClients.size;
                }
                return cur.activeClients || 0;
            })(),
            profitDistribution: cur.profitDistribution || '',
            notes: cur.notes || '',
            transfers: cur.transfers || []
        };

        console.log('[DEBUG] ===== FINAL VALUES BEING SET =====');
        console.log('[DEBUG] importedData.openInvoices:', importedData.openInvoices);
        console.log('[DEBUG] importedData.avgDaysOverdue:', importedData.avgDaysOverdue);
        console.log('[DEBUG] ===================================');

        setCur(importedData);
        
        console.log('[DEBUG] importedData.expenses:', importedData.expenses);
        console.log('[DEBUG] importedData.expenses.length:', importedData.expenses ? importedData.expenses.length : 'undefined');
        
        if (importedData.expenses && importedData.expenses.length > 0) {
            console.log('[DEBUG] First expense:', importedData.expenses[0]);
            console.log('[DEBUG] All expenses:', JSON.stringify(importedData.expenses, null, 2));
        }
        
        // ×©××™×¨×” ××•×˜×•××˜×™×ª ××—×¨×™ ×™×™×‘×•×
        const key = `${selYear}-${selMonth}`;
        const now = new Date();
        const savedAt = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        
        console.log('[DEBUG] ===== SAVING TO DATA =====');
        console.log('[DEBUG] key:', key);
        console.log('[DEBUG] importedData.openInvoices:', importedData.openInvoices);
        console.log('[DEBUG] importedData.avgDaysOverdue:', importedData.avgDaysOverdue);
        
        setData(p => {
            const newData = {...p, [key]: {...(p[key]||{}), ...importedData, savedAt}};
            console.log('[DEBUG] newData[key].openInvoices:', newData[key].openInvoices);
            console.log('[DEBUG] newData[key].avgDaysOverdue:', newData[key].avgDaysOverdue);
            console.log('[DEBUG] ========================');
            saveData(newData);
            return newData;
        });

        const sharonRetPct = totalRetH > 0 ? Math.round(sharonRetH/totalRetH*100) : 50;
        const oritRetPct   = 100 - sharonRetPct;
        
        alert(
            `âœ… ×”×™×™×‘×•× ×”×•×©×œ× ×•× ×©××¨ ×‘×”×¦×œ×—×”!\n\n` +
            `× ×ª×•× ×™× ×©×™×•×‘××• ×¢×‘×•×¨ ${monthName} ${selYear}:\n` +
            `â€¢ ×©×¢×•×ª ×—×™×•×‘×™ ×—×•×“×©×™ (×›×•×œ×œ ×¨×™×˜×™×™× ×¨): ${importedData.billingHours}\n` +
            `â€¢ ×©×¢×•×ª ×¨×™×˜×™×™× ×¨ (×“×Ÿ ×ª×—×‘×•×¨×”): ${importedData.retainerHours}\n` +
            `  - ×©×¨×•×Ÿ: ${sharonRetH} ×©×¢×•×ª (${sharonRetPct}%) â†’ â‚ª${sharonRetainerShare.toLocaleString()}\n` +
            `  - ××•×¨×™×ª: ${oritRetH} ×©×¢×•×ª (${oritRetPct}%) â†’ â‚ª${oritRetainerShare.toLocaleString()}\n` +
            `â€¢ ×¨×™×˜×™×™× ×¨ ×œ×œ× ××¢"×: â‚ª${retainerFeeVal.toLocaleString()}\n` +
            `â€¢ ×¡×”"×› ×—×™×•×‘×™ ×©×¢×•×ª (×œ×œ× ××¢"×): â‚ª${(importedData.totalBillings||0).toLocaleString()}\n` +
            `â€¢ ×”×•×¦××•×ª ×œ×§×•×— (×œ×œ× ××¢"×): â‚ª${(importedData.billingExpenses||0).toLocaleString()}\n` +
            `â€¢ ×—×™×•×‘×™ ×©×¨×•×Ÿ (×¨×’×™×œ+×¨×™×˜×™×™× ×¨): â‚ª${importedData.sharonBilling.toLocaleString()}\n` +
            `â€¢ ×—×™×•×‘×™ ××•×¨×™×ª (×¨×’×™×œ+×¨×™×˜×™×™× ×¨): â‚ª${importedData.oritBilling.toLocaleString()}\n` +
            `â€¢ ×”×›× ×¡×•×ª ×›×•×œ×œ ××¢"×: â‚ª${(importedData.incomeWithVAT||0).toLocaleString()}\n` +
            `â€¢ ××¢"× ×œ×ª×©×œ×•×: â‚ª${(importedData.vatToPay||0).toLocaleString()}\n` +
            `â€¢ ×”×•×¦××•×ª ×›×•×œ×œ ××¢"×: â‚ª${(importedData.expensesWithVAT||0).toLocaleString()}\n` +
            `â€¢ ×™××™ ×¢×‘×•×“×”: ${importedData.workDays}`
        );
    };

    // ×—×™×©×•×‘×™×
    const income0   = parseFloat(cur.incomeWithVAT||0) - parseFloat(cur.vatToPay||0); // ×”×›× ×¡×•×ª ×œ×œ× ××¢"× = ×”×›× ×¡×•×ª ×›×•×œ×œ ××¢"× - ××¢"× ×œ×ª×©×œ×•×
    const expenses0 = parseFloat(cur.expensesWithVAT||0)/1.18; // ×”×•×¦××•×ª ×ª×¤×¢×•×œ×™×•×ª ×œ×œ× ××¢"×
    const vatToPay  = parseFloat(cur.vatToPay||0);
    const vatNet    = vatToPay - avgVAT;
    const vatActual = parseFloat(cur.actualVATPaid||0);
    const vatCredit = vatActual > 0 ? vatToPay - vatActual : null;
    const netProfit = income0 - expenses0; // ×”×›× ×¡×•×ª ×œ×œ× ××¢"× - ×”×•×¦××•×ª ×ª×¤×¢×•×œ×™×•×ª ×œ×œ× ××¢"×
    const perPartner = netProfit/2;
    const billingH  = parseFloat(cur.billingHours||0);
    const retainerH = parseFloat(cur.retainerHours||0);
    const payingH   = billingH - retainerH;
    const totalB    = parseFloat(cur.totalBillings||0);
    const retainerF = parseFloat(cur.retainerFee||0);
    const nonRet    = totalB - retainerF;
    const workDays  = parseFloat(cur.workDays||0);
    const avgRate        = billingH>0   ? totalB / billingH       : 0;
    const nonRetRate     = payingH>0    ? (totalB - retainerF) / payingH  : 0;
    const dailyRate      = workDays>0   ? (totalB - retainerF) / workDays : 0;

    const curKey   = `${selYear}-${selMonth}`;
    const curLabel = `${MONTHS.find(m=>m.v===selMonth)?.l||''} ${selYear}`;
    const curTransfers = data[curKey]?.transfers || [];

    // Debug: Check if export function exists
    console.log('[APP DEBUG] exportInvoicesToExcel defined?', typeof exportInvoicesToExcel);
    
    // Make function available globally for testing
    if (typeof window !== 'undefined') {
        window.testExportInvoices = exportInvoicesToExcel;
        console.log('[APP DEBUG] Function attached to window.testExportInvoices');
    }

    return (
        <div style={{maxWidth:1200,margin:'0 auto',padding:'16px'}}>

            {/* â”€â”€ ×›×•×ª×¨×ª â”€â”€*/}
            <div className="card">
                <div style={{display:'flex',justifyContent:'flex-start',alignItems:'center',marginBottom:18}}>
                    <img src="logo.png" alt="×–×™×œ×•× ×™-×§×œ×™×™× ××Ÿ ×œ×•×œ×¦'×™" style={{height:60,objectFit:'contain'}} />
                </div>
                <div style={{display:'grid',gridTemplateColumns:'auto auto 1fr auto auto auto auto auto auto auto',gap:12,alignItems:'end'}}>
                    <div>
                        <label style={{display:'block',fontWeight:600,fontSize:'0.82rem',color:'#374151',marginBottom:5}}>×—×•×“×©</label>
                        <select className="input-field" style={{width:130}} value={selMonth} onChange={e=>setSelMonth(e.target.value)}>
                            {MONTHS.map(m=><option key={m.v} value={m.v}>{m.l}</option>)}
                        </select>
                    </div>
                    <div>
                        <label style={{display:'block',fontWeight:600,fontSize:'0.82rem',color:'#374151',marginBottom:5}}>×©× ×”</label>
                        <select className="input-field" style={{width:90}} value={selYear} onChange={e=>setSelYear(parseInt(e.target.value))}>
                            {YEARS.map(y=><option key={y} value={y}>{y}</option>)}
                        </select>
                    </div>
                    <div/>
                    <button
                        onClick={importFromOdcanit}
                        disabled={odcanitImporting || !selMonth}
                        style={{
                            padding:'10px 18px',
                            borderRadius:6,
                            border:'1px solid #bfdbfe',
                            background: odcanitImporting ? '#d1d5db' : 'linear-gradient(135deg,#dbeafe,#bfdbfe)',
                            color: odcanitImporting ? '#6b7280' : '#1e40af',
                            fontWeight:600,
                            cursor: odcanitImporting || !selMonth ? 'not-allowed' : 'pointer',
                            whiteSpace:'nowrap',
                            opacity: odcanitImporting || !selMonth ? 0.6 : 1
                        }}
                        title="×™×™×‘×•× ××¢×•×“×›× ×™×ª ×–××™×Ÿ ×¨×§ ×›××©×¨ ×”×©×¨×ª ×¨×¥"
                        >
                        {odcanitImporting ? 'â³ ××™×™×‘×...' : 'ğŸ”„ ×™×™×‘×•× ××¢×•×“×›× ×™×ª'}
                    </button>
                    <button style={{padding:'10px 20px',borderRadius:6,border:'none',background:'#3b82f6',color:'white',fontWeight:600,cursor:'pointer'}} onClick={saveMonth}>ğŸ’¾ ×©××•×¨ ×—×•×“×©</button>
                    <button onClick={()=>setShowReports(true)}
                        style={{padding:'10px 18px',borderRadius:6,border:'1px solid #fde68a',background:'linear-gradient(135deg,#fffbeb,#fef3c7)',color:'#92400e',fontWeight:600,cursor:'pointer',whiteSpace:'nowrap'}}>
                        ğŸ“Š ×“×•×—×•×ª
                    </button>
                    <button onClick={handleMonthlyReport}
                        style={{padding:'10px 18px',borderRadius:6,border:'1px solid #bfdbfe',background:'linear-gradient(135deg,#eff6ff,#dbeafe)',color:'#1e40af',fontWeight:600,cursor:'pointer',whiteSpace:'nowrap',title:'×™×¦×™×¨×ª ×“×•×— PDF ×•×”×•×¨×“×”'}}>
                        ğŸ“„ ×“×•×— PDF
                    </button>
                    
                    <button onClick={()=>setShowSettings(true)}
                        style={{padding:'10px 14px',borderRadius:6,border:'1px solid #e9d5ff',background:'linear-gradient(135deg,#faf5ff,#f3e8ff)',color:'#6b21a8',fontWeight:600,cursor:'pointer',whiteSpace:'nowrap',title:'×”×’×“×¨×•×ª'}}>
                        âš™ï¸ ×”×’×“×¨×•×ª
                    </button>
                </div>
                {importMsg && (
                    <div style={{
                        marginTop:12, padding:'10px 16px', borderRadius:8, fontSize:'0.85rem', fontWeight:500,
                        background: importMsg.type==='ok' ? '#f0fdf4' : importMsg.type==='warn' ? '#fffbeb' : '#fef2f2',
                        color:       importMsg.type==='ok' ? '#166534' : importMsg.type==='warn' ? '#92400e'  : '#991b1b',
                        border:     `1px solid ${importMsg.type==='ok' ? '#bbf7d0' : importMsg.type==='warn' ? '#fde68a' : '#fecaca'}`,
                        display:'flex', justifyContent:'space-between', alignItems:'flex-start', gap:8
                    }}>
                        <span style={{lineHeight:1.5}}>{importMsg.text}</span>
                        <button onClick={()=>setImportMsg(null)} style={{background:'none',border:'none',cursor:'pointer',color:'inherit',fontWeight:700,fontSize:'1rem',padding:'0 4px',flexShrink:0}}>âœ•</button>
                    </div>
                )}
            </div>

            {/* â”€â”€ ×¡×™×›×•× ×©× ×ª×™ ×¢×“ ×›×” â”€â”€ */}
            {(()=>{
                // ××¦×™××ª ×”×—×•×“×© ×”××—×¨×•×Ÿ ×¢× × ×ª×•× ×™× ×‘×©× ×” ×”× ×•×›×—×™×ª
                const lastMonthWithData = MONTHS.slice().reverse().find(m=>parseFloat(data[`${selYear}-${m.v}`]?.totalBillings||0)>0);
                const lastMonthNum = lastMonthWithData ? lastMonthWithData.v : '12';
                
                // ×—×™×©×•×‘ YTD ×¢×“ ×”×—×•×“×© ×”××—×¨×•×Ÿ ×¢× × ×ª×•× ×™×
                const monthsUpToLast = MONTHS.filter(m=>parseInt(m.v)<=parseInt(lastMonthNum));
                
                const ytdBilling  = monthsUpToLast.reduce((s,m)=>s+parseFloat(data[`${selYear}-${m.v}`]?.totalBillings||0),0);
                const ytdIncome   = monthsUpToLast.reduce((s,m)=>{
                    const d = data[`${selYear}-${m.v}`];
                    return s + (parseFloat(d?.incomeWithVAT||0) - parseFloat(d?.vatToPay||0));
                },0);
                const ytdExpenses = monthsUpToLast.reduce((s,m)=>s+parseFloat(data[`${selYear}-${m.v}`]?.expensesWithVAT||0)/1.18,0);
                const ytdProfit   = ytdIncome - ytdExpenses; // ×”×›× ×¡×•×ª ×œ×œ× ××¢"× - ×”×•×¦××•×ª ×œ×œ× ××¢"×
                const ytdMonths   = monthsUpToLast.filter(m=>parseFloat(data[`${selYear}-${m.v}`]?.totalBillings||0)>0).length;

                // ×—×™×©×•×‘ ××•×ª×• ×˜×•×•×— ×‘×©× ×” ×”×§×•×“××ª (YTD ×¢×“ ××•×ª×• ×—×•×“×©)
                const prevYear    = selYear - 1;
                const prevBilling = monthsUpToLast.reduce((s,m)=>s+parseFloat(data[`${prevYear}-${m.v}`]?.totalBillings||0),0);
                const prevIncome  = monthsUpToLast.reduce((s,m)=>{
                    const d = data[`${prevYear}-${m.v}`];
                    return s + (parseFloat(d?.incomeWithVAT||0) - parseFloat(d?.vatToPay||0));
                },0);
                const prevExpenses= monthsUpToLast.reduce((s,m)=>s+parseFloat(data[`${prevYear}-${m.v}`]?.expensesWithVAT||0)/1.18,0);
                const prevVATCredit = monthsUpToLast.reduce((s,m)=>s+avgVAT,0);
                const prevProfit  = prevIncome - prevExpenses + prevVATCredit;

                const pctChange = (cur,prev) => prev > 0 ? ((cur-prev)/prev*100) : null;
                const billingChg = pctChange(ytdBilling, prevBilling);
                const profitChg  = pctChange(ytdProfit,  prevProfit);

                const yearSummaries = YEARS.map(y=>({
                    year: y,
                    billing: MONTHS.reduce((s,m)=>s+parseFloat(data[`${y}-${m.v}`]?.totalBillings||0),0),
                    profit:  MONTHS.reduce((s,m)=>{
                        const d=data[`${y}-${m.v}`]; if(!d) return s;
                        const income = parseFloat(d.incomeWithVAT||0) - parseFloat(d.vatToPay||0);
                        const expenses = parseFloat(d.expensesWithVAT||0)/1.18;
                        return s + income - expenses + avgVAT;
                    },0),
                    // YTD (year-to-date) ×¢×“ ×”×—×•×“×© ×”× ×‘×—×¨
                    billingYTD: MONTHS.filter(m=>parseInt(m.v)<=parseInt(selMonth)).reduce((s,m)=>s+parseFloat(data[`${y}-${m.v}`]?.totalBillings||0),0),
                    profitYTD:  MONTHS.filter(m=>parseInt(m.v)<=parseInt(selMonth)).reduce((s,m)=>{
                        const d=data[`${y}-${m.v}`]; if(!d) return s;
                        const income = parseFloat(d.incomeWithVAT||0) - parseFloat(d.vatToPay||0);
                        const expenses = parseFloat(d.expensesWithVAT||0)/1.18;
                        return s + income - expenses + avgVAT;
                    },0),
                })).filter(y=>y.billing>0||y.profit>0);

                const YCLRS=['#6366f1','#22c55e','#f59e0b','#ef4444','#8b5cf6','#06b6d4'];
                const maxVal = Math.max(...yearSummaries.flatMap(y=>[y.billing,Math.max(0,y.profit),y.billingYTD,Math.max(0,y.profitYTD)]),1);

                const ChgBadge = ({val,label}) => {
                    if(val===null) return null;
                    const pos = val>=0;
                    return <span style={{display:'inline-flex',alignItems:'center',gap:3,fontSize:'0.75rem',fontWeight:700,
                        color:pos?'#166534':'#dc2626',background:pos?'#dcfce7':'#fee2e2',
                        padding:'2px 7px',borderRadius:12,marginTop:4}}>
                        {pos?'â–²':'â–¼'} {Math.abs(val).toFixed(1)}% ×-{label}
                    </span>;
                };

                return (
                    <div className="card" style={{marginBottom:20,background:'linear-gradient(135deg,#f8faff 0%,#f0f4ff 100%)',border:'1px solid #e0e7ff'}}>
                        {/* ×›×•×ª×¨×ª */}
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:18}}>
                            <div>
                                <h2 style={{fontSize:'1.1rem',fontWeight:700,color:'#1e3a5f',margin:0}}>ğŸ“… ×¡×™×›×•× ×©× ×ª×™ â€” {selYear}</h2>
                                <p style={{color:'#9ca3af',fontSize:'0.78rem',margin:'4px 0 0'}}>
                                    {ytdMonths > 0 ? `${ytdMonths} ×—×•×“×©×™× ×¢× × ×ª×•× ×™× (×¢×“ ${lastMonthWithData?.l})` : '××™×Ÿ × ×ª×•× ×™× ×œ×©× ×” ×–×•'}
                                    {prevBilling > 0 && <span style={{marginRight:8,color:'#a5b4fc'}}>| ×”×©×•×•××” ××•×œ {prevYear} (×¢×“ {lastMonthWithData?.l})</span>}
                                </p>
                            </div>
                        </div>

                        {/* KPI + ×©×™× ×•×™ YoY */}
                        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:20}}>
                            {[
                                {l:'×¡×”"×› ×—×™×•×‘×™×',    v:ytdBilling,  prev:prevBilling, chg:billingChg, bg:'linear-gradient(135deg,#667eea,#764ba2)'},
                                {l:'×”×›× ×¡×•×ª ×œ×œ× ××¢"×',     v:ytdIncome,   prev:prevIncome,  chg:pctChange(ytdIncome,prevIncome),  bg:'linear-gradient(135deg,#11998e,#38ef7d)'},
                                {l:'×¨×•×•×— × ×§×™',       v:ytdProfit,   prev:prevProfit,  chg:profitChg,  bg:'linear-gradient(135deg,#f093fb,#f5576c)'},
                                {l:'×—×œ×§ ×œ×©×•×ª×¤×”',     v:ytdProfit/2, prev:prevProfit/2,chg:profitChg,  bg:'linear-gradient(135deg,#4facfe,#00f2fe)'},
                            ].map(c=>(
                                <div key={c.l} style={{background:c.bg,color:'white',padding:'14px 16px',borderRadius:10,position:'relative',overflow:'hidden'}}>
                                    <div style={{fontSize:'0.72rem',opacity:0.85,marginBottom:3}}>{c.l}</div>
                                    <div style={{fontSize:'1.2rem',fontWeight:700}}>{c.v>0?'â‚ª'+Math.round(c.v).toLocaleString('he-IL'):c.v<0?'-â‚ª'+Math.round(Math.abs(c.v)).toLocaleString('he-IL'):'-'}</div>
                                    {c.chg!==null && <div style={{marginTop:4,fontSize:'0.7rem',opacity:0.9,display:'flex',alignItems:'center',gap:4}}>
                                        <span style={{background:'rgba(255,255,255,0.25)',borderRadius:8,padding:'1px 6px'}}>
                                            {c.chg>=0?'â–²':'â–¼'} {Math.abs(c.chg).toFixed(1)}% ×-{prevYear}
                                        </span>
                                    </div>}
                                </div>
                            ))}
                        </div>

                        {/* ×’×¨×£ ×”×©×•×•××ª×™ SVG */}
                        <div style={{fontSize:'0.82rem',fontWeight:600,color:'#374151',marginBottom:10,display:'flex',gap:16,alignItems:'center'}}>
                            <span>×”×©×•×•××” ×©× ×ª×™×ª â€” ×—×™×•×‘×™× ×•×¨×•×•×— × ×§×™</span>
                            <span style={{display:'flex',alignItems:'center',gap:5,fontSize:'0.75rem',color:'#6b7280',fontWeight:400}}>
                                <span style={{display:'inline-block',width:12,height:10,background:'#6366f1',borderRadius:2,opacity:0.9}}/>×—×™×•×‘×™× ×©× ×ª×™
                                <span style={{display:'inline-block',width:12,height:10,background:'#6366f1',borderRadius:2,opacity:0.4,marginRight:4}}/>×¨×•×•×— ×©× ×ª×™
                                <span style={{display:'inline-block',width:12,height:3,background:'#ef4444',borderRadius:1,marginRight:4}}/>×¢×“ {MONTHS.find(m=>m.v===selMonth)?.l}
                            </span>
                        </div>
                        <div style={{overflowX:'auto'}}>
                            <svg width="100%" viewBox={`0 0 ${Math.max(yearSummaries.length*110+60,400)} 200`} style={{display:'block',minWidth:360}}>
                                {(()=>{
                                    const W = Math.max(yearSummaries.length*110+60,400);
                                    const chartH=150, padTop=14, padLeft=54, padBottom=36;
                                    const availH=chartH-padTop, availW=W-padLeft-20;
                                    const barGroupW = availW/Math.max(yearSummaries.length,1);
                                    const barW = Math.min(barGroupW*0.32, 28);
                                    const elems=[];

                                    // grid lines + Y labels
                                    [0,0.25,0.5,0.75,1].forEach((frac,i)=>{
                                        const y=padTop+availH*(1-frac);
                                        elems.push(
                                            <line key={`g${i}`} x1={padLeft} y1={y} x2={W-20} y2={y} stroke="#e5e7eb" strokeWidth="1"/>,
                                            <text key={`gl${i}`} x={padLeft-4} y={y+4} fontSize="9" fill="#9ca3af" textAnchor="end">
                                                â‚ª{frac===0?'0':Math.round(maxVal*frac/1000)+'K'}
                                            </text>
                                        );
                                    });

                                    yearSummaries.forEach((ys,yi)=>{
                                        const isCur = ys.year===selYear;
                                        const color = YCLRS[YEARS.indexOf(ys.year)] || '#6366f1';
                                        const cx    = padLeft + yi*barGroupW + barGroupW/2;
                                        const bH    = Math.max(1,(ys.billing/maxVal)*availH);
                                        const pH    = Math.max(0,(ys.profit/maxVal)*availH);
                                        const bx    = cx - barW - 2;
                                        const px    = cx + 2;

                                        // highlight ring for current year
                                        if(isCur) elems.push(
                                            <rect key={`hl${yi}`} x={bx-4} y={padTop-4} width={barW*2+12} height={availH+8}
                                                fill="none" stroke={color} strokeWidth="1.5" strokeDasharray="4,3" rx="4" opacity="0.5"/>
                                        );

                                        elems.push(
                                            <rect key={`b${yi}`} x={bx} y={padTop+availH-bH} width={barW} height={bH}
                                                fill={color} opacity={isCur?0.95:0.5} rx="3"/>,
                                            <rect key={`p${yi}`} x={px} y={padTop+availH-pH} width={barW} height={pH}
                                                fill={color} opacity={isCur?0.55:0.25} rx="3"/>
                                        );

                                        // YTD indicator lines (×¢×“ ×”×—×•×“×© ×”× ×‘×—×¨)
                                        const ytdBH = Math.max(1,(ys.billingYTD/maxVal)*availH);
                                        const ytdPH = Math.max(0,(ys.profitYTD/maxVal)*availH);
                                        
                                        if(ys.billingYTD > 0) elems.push(
                                            <line key={`ytdb${yi}`} x1={bx-3} y1={padTop+availH-ytdBH} x2={bx+barW+3} y2={padTop+availH-ytdBH}
                                                stroke="#ef4444" strokeWidth="2.5" opacity="0.85"/>
                                        );
                                        if(ys.profitYTD > 0) elems.push(
                                            <line key={`ytdp${yi}`} x1={px-3} y1={padTop+availH-ytdPH} x2={px+barW+3} y2={padTop+availH-ytdPH}
                                                stroke="#ef4444" strokeWidth="2.5" opacity="0.6"/>
                                        );

                                        // value labels
                                        if(ys.billing>0) elems.push(
                                            <text key={`bv${yi}`} x={bx+barW/2} y={padTop+availH-bH-4} textAnchor="middle"
                                                fontSize={isCur?9:8} fontWeight={isCur?"700":"400"} fill={color} opacity={isCur?1:0.7}>
                                                â‚ª{Math.round(ys.billing/1000)}K
                                            </text>
                                        );
                                        if(ys.profit>0) elems.push(
                                            <text key={`pv${yi}`} x={px+barW/2} y={padTop+availH-pH-4} textAnchor="middle"
                                                fontSize={isCur?9:8} fontWeight={isCur?"700":"400"} fill={color} opacity={isCur?0.85:0.55}>
                                                â‚ª{Math.round(ys.profit/1000)}K
                                            </text>
                                        );

                                        // year label
                                        elems.push(
                                            <text key={`yl${yi}`} x={cx} y={chartH+padBottom-16} textAnchor="middle"
                                                fontSize={isCur?10:9} fontWeight={isCur?700:400} fill={isCur?color:'#9ca3af'}>
                                                {ys.year}
                                            </text>
                                        );

                                        // YoY arrow between current and previous
                                        if(isCur && yi>0){
                                            const prevYS = yearSummaries[yi-1];
                                            // ×”×©×•×•×” YTD ×‘××§×•× ×©× ×” ××œ××”
                                            const chgB = prevYS.billingYTD>0?(ys.billingYTD-prevYS.billingYTD)/prevYS.billingYTD*100:null;
                                            if(chgB!==null) elems.push(
                                                <text key={`chg${yi}`} x={cx} y={chartH+padBottom-4} textAnchor="middle"
                                                    fontSize="8" fontWeight="700" fill={chgB>=0?'#16a34a':'#dc2626'}>
                                                    {chgB>=0?'â–²':'â–¼'}{Math.abs(chgB).toFixed(0)}%
                                                </text>
                                            );
                                        }
                                    });

                                    return elems;
                                })()}
                            </svg>
                        </div>
                    </div>
                );
            })()}

            {selMonth && (<>

            {/* â”€â”€ ×›×¨×˜×™×¡×™ ×¡×™×›×•× â”€â”€ */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14,marginBottom:20}}>
                {[
                    {l:'×¡×”"×› ×—×™×•×‘×™×',v:fmt(cur.totalBillings),bg:'linear-gradient(135deg,#667eea,#764ba2)'},
                    {l:'×¡×”"×› ×”×›× ×¡×•×ª (×œ×œ× ××¢"×)',v:fmt(income0),bg:'linear-gradient(135deg,#f093fb,#f5576c)'},
                    {l:'×¨×•×•×— × ×§×™',v:fmt(netProfit),bg:'linear-gradient(135deg,#11998e,#38ef7d)'},
                    {l:'×—×œ×§ ×›×œ ×©×•×ª×¤×”',v:fmt(perPartner),bg:'linear-gradient(135deg,#4facfe,#00f2fe)'},
                ].map(c=>(
                    <div key={c.l} style={{background:c.bg,color:'white',padding:'18px',borderRadius:10}}>
                        <div style={{fontSize:'0.78rem',opacity:0.9,marginBottom:4}}>{c.l}</div>
                        <div style={{fontSize:'1.35rem',fontWeight:700}}>{c.v}</div>
                    </div>
                ))}
            </div>

            {/* â”€â”€ ×—×™×•×‘×™× â”€â”€ */}
            <div className="card">
                <h2 style={{fontSize:'1.05rem',fontWeight:700,color:'#1e3a5f',marginBottom:14}}>ğŸ“Š ×—×™×•×‘×™× ×•×©×¢×•×ª</h2>
                <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12}}>
                    {[['×©×¢×•×ª ×—×™×•×‘ ×—×•×“×©×™','billingHours'],['×¡×”"×› ×—×™×•×‘×™× (×©×¢×•×ª, ×œ×œ× ××¢"×)','totalBillings'],['×¨×™×˜×™×™× ×¨ (×œ×œ× ××¢"×)','retainerFee'],
                      ['×©×¢×•×ª ×¨×™×˜×™×™× ×¨','retainerHours'],['×™××™ ×¢×‘×•×“×” ×‘×—×•×“×©','workDays'],['×”×•×¦××•×ª ×œ×§×•×— (×œ×œ× ××¢"×)','billingExpenses']].map(([lbl,k])=>(
                        <div key={k}>
                            <label style={{display:'block',fontWeight:600,fontSize:'0.8rem',color: k==='billingExpenses' ? '#92400e' : '#374151',marginBottom:4}}>{lbl}</label>
                            <input type="number" className="input-field" style={k==='billingExpenses'?{background:'#fffbeb'}:{}} value={cur[k]} onChange={e=>set(k,e.target.value)} placeholder="0"/>
                        </div>
                    ))}
                </div>
                <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginTop:14,paddingTop:14,borderTop:'1px solid #e5e7eb'}}>
                    {[
                        {l:'×©×¢×•×ª ××©×œ××•×ª',v:payingH.toFixed(1),bg:'#eff6ff',c:'#1d4ed8'},
                        {l:'×—×™×•×‘ ×©×¢×” ×××•×¦×¢',v:fmt(avgRate),bg:'#f0fdf4',c:'#166534'},
                        {l:'×—×™×•×‘ ×©×¢×” (×œ×œ× ×¨×™×˜×™×™× ×¨)',v:fmt(nonRetRate),bg:'#faf5ff',c:'#6d28d9'},
                        {l:'×—×™×•×‘ ×™×•××™',v:fmt(dailyRate),bg:'#fff7ed',c:'#c2410c'},
                    ].map(s=>(
                        <div key={s.l} style={{background:s.bg,borderRadius:8,padding:'10px 12px'}}>
                            <div style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:3}}>{s.l}</div>
                            <div style={{fontSize:'1.1rem',fontWeight:700,color:s.c}}>{s.v}</div>
                        </div>
                    ))}
                </div>
            </div>

            {/* â”€â”€ ×”×›× ×¡×•×ª / ×”×•×¦××•×ª / ××¢"× â”€â”€ */}
            <div className="card">
                <h2 style={{fontSize:'1.05rem',fontWeight:700,color:'#1e3a5f',marginBottom:14}}>ğŸ’° ×”×›× ×¡×•×ª, ×”×•×¦××•×ª ×•××¢"×</h2>
                <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:14}}>
                    {[['×”×›× ×¡×•×ª (×›×•×œ×œ ××¢"×)','incomeWithVAT',''],
                      ['×”×•×¦××•×ª ×ª×¤×¢×•×œ×™×•×ª (×›×•×œ×œ ××¢"×)','expensesWithVAT',''],
                      ['××¢"× ×œ×ª×©×œ×•× (×¨××©×•× ×™)','vatToPay',''],
                      ['××¢"× ×©×©×•×œ× ×‘×¤×•×¢×œ','actualVATPaid','#fefce8']].map(([lbl,k,bg])=>(
                        <div key={k}>
                            <label style={{display:'block',fontWeight:600,fontSize:'0.8rem',color:'#374151',marginBottom:4}}>{lbl}</label>
                            <input type="number" className="input-field" style={bg?{background:bg}:{}} value={cur[k]} onChange={e=>set(k,e.target.value)} placeholder="0"/>
                        </div>
                    ))}
                </div>
                <table style={{width:'100%',borderCollapse:'collapse',fontSize:'0.88rem'}}>
                    <tbody>
                        <tr><td className="tc">×”×›× ×¡×•×ª ×œ×œ× ××¢"×</td><td className="tc" style={{textAlign:'left'}}>{fmt(income0)}</td></tr>
                        <tr><td className="tc">×”×•×¦××•×ª ×ª×¤×¢×•×œ×™×•×ª ×œ×œ× ××¢"×</td><td className="tc" style={{textAlign:'left'}}>{fmt(expenses0)}</td></tr>
                        <tr style={{background:'#eff6ff'}}><td className="tc">××¢"× ×¨××©×•× ×™</td><td className="tc" style={{textAlign:'left',fontWeight:600}}>{fmt(vatToPay)}</td></tr>
                        <tr style={{background:'#eff6ff'}}><td className="tc">×–×™×›×•×™ ××¢"×</td><td className="tc" style={{textAlign:'left',fontWeight:600}}>{fmt(avgVAT)}</td></tr>
                        <tr style={{background:'#fff7ed'}}><td className="tc" style={{fontWeight:700}}>××¢"× ×œ×ª×©×œ×•× × ×˜×•</td><td className="tc" style={{textAlign:'left',fontWeight:700,color:'#c2410c'}}>{fmt(vatNet)}</td></tr>
                        {vatCredit!==null&&<>
                            <tr style={{background:'#fefce8'}}><td className="tc">××¢"× ×©×©×•×œ× ×‘×¤×•×¢×œ</td><td className="tc" style={{textAlign:'left',fontWeight:600}}>{fmt(vatActual)}</td></tr>
                        </>}
                        <tr style={{background:'#f0fdf4'}}><td className="tc" style={{fontWeight:700}}>×¨×•×•×— × ×§×™</td><td className="tc" style={{textAlign:'left',fontWeight:700,color:'#166534'}}>{fmt(netProfit)}</td></tr>
                        <tr style={{background:'#faf5ff'}}><td className="tc" style={{fontWeight:700}}>×—×œ×§ ×›×œ ×©×•×ª×¤×” (50%)</td><td className="tc" style={{textAlign:'left',fontWeight:700,color:'#6d28d9'}}>{fmt(perPartner)}</td></tr>
                    </tbody>
                </table>
            </div>

            {/* â”€â”€ × ×ª×•× ×™× × ×•×¡×¤×™× â”€â”€ */}
            <div className="card">
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
                    <h2 style={{fontSize:'1.05rem',fontWeight:700,color:'#1e3a5f',margin:0}}>ğŸ“ × ×ª×•× ×™× × ×•×¡×¤×™×</h2>
                    {data[curKey]?.savedAt && (
                        <span style={{fontSize:'0.78rem',color:'#9ca3af',background:'#f9fafb',border:'1px solid #e5e7eb',borderRadius:6,padding:'3px 10px'}}>
                            ğŸ• × ×©××¨: {data[curKey].savedAt}
                        </span>
                    )}
                </div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:12,marginBottom:12}}>
                    <div>
                        <label style={{display:'block',fontWeight:600,fontSize:'0.8rem',color:'#374151',marginBottom:4}}>×—×©×‘×•× ×•×ª ×¤×ª×•×—×™× (×œ×œ× ××¢"×)</label>
                        <input type="number" className="input-field" value={cur.openInvoices} onChange={e=>set('openInvoices',e.target.value)} placeholder="0"/>
                    </div>
                    <div>
                        <label style={{display:'block',fontWeight:600,fontSize:'0.8rem',color:'#374151',marginBottom:4}}>×××•×¦×¢ ×™××™ ××™×—×•×¨</label>
                        <input type="number" step="0.1" className="input-field" style={{background:'#fef3c7'}} value={cur.avgDaysOverdue} onChange={e=>set('avgDaysOverdue',e.target.value)} placeholder="0"/>
                    </div>
                    <div>
                        <label style={{display:'block',fontWeight:600,fontSize:'0.8rem',color:'#374151',marginBottom:4}}>×—×œ×•×§×ª ×¨×•×•×—×™× ×—×•×“×©×™×ª ×œ×›×œ ×©×•×ª×¤×” (â‚ª)</label>
                        <input type="number" className="input-field" style={{background:'#f0fdf4'}} value={cur.profitDistribution} onChange={e=>set('profitDistribution',e.target.value)} placeholder="0"/>
                    </div>
                </div>
                <div style={{marginBottom:14}}>
                    <label style={{display:'block',fontWeight:600,fontSize:'0.8rem',color:'#374151',marginBottom:4}}>×”×¢×¨×•×ª</label>
                    <textarea className="input-field" rows="2" value={cur.notes} onChange={e=>set('notes',e.target.value)} placeholder="×”×¢×¨×•×ª..." style={{resize:'vertical'}}/>
                </div>
                <div style={{display:'flex',gap:10}}>
                    <button onClick={()=>setShowTransfer(true)}
                        style={{padding:'11px 22px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#667eea,#764ba2)',color:'white',cursor:'pointer',fontWeight:700,fontSize:'0.9rem'}}>
                        ğŸ“‹ ×ª×™×¢×•×“ ×”×¢×‘×¨×” ×‘× ×§××™×ª
                        {curTransfers.length>0 && <span style={{background:'rgba(255,255,255,0.25)',borderRadius:12,padding:'2px 8px',marginRight:8,fontSize:'0.78rem'}}>âœ“ {curTransfers.length} ××ª×•×¢×“×•×ª</span>}
                    </button>
                    <button onClick={()=>setShowAllTransfers(true)}
                        style={{padding:'11px 18px',borderRadius:8,border:'1px solid #c4b5fd',background:'#f5f3ff',cursor:'pointer',fontWeight:600,fontSize:'0.9rem',color:'#5b21b6'}}>
                        ğŸ“‚ ×›×œ ×”×”×¢×‘×¨×•×ª
                    </button>
                    <button onClick={()=>setShowExpensesModal(true)}
                        style={{padding:'11px 18px',borderRadius:8,border:'1px solid #fcd34d',background:'#fef3c7',cursor:'pointer',fontWeight:600,fontSize:'0.9rem',color:'#78350f'}}>
                        ğŸ’° ×”×•×¦××•×ª
                    </button>
                    <button onClick={exportInvoicesToExcel}
                        style={{padding:'11px 18px',borderRadius:8,border:'1px solid #a7f3d0',background:'#d1fae5',cursor:'pointer',fontWeight:600,fontSize:'0.9rem',color:'#065f46'}}>
                        ğŸ“Š ×™×™×¦× ×—×©×‘×•× ×™×•×ª ×œ××§×¡×œ
                    </button>
                </div>
            </div>

            {/* â”€â”€ ×¤×× ×œ ×”×•×¦××•×ª ××™×•×‘××•×ª â”€â”€ */}
            {showExpenses && importedExpenses.length > 0 && (
                <div className="card">
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
                        <h2 style={{fontSize:'1.05rem',fontWeight:700,color:'#1e3a5f',margin:0}}>ğŸ§¾ ×”×•×¦××•×ª ××™×•×‘××•×ª â€” ×¡×™×•×•×’ ×œ×”×—×–×¨</h2>
                        <button onClick={()=>setShowExpenses(false)} style={{background:'none',border:'none',cursor:'pointer',color:'#9ca3af',fontSize:'1.1rem'}}>âœ•</button>
                    </div>
                    <p style={{fontSize:'0.82rem',color:'#6b7280',marginBottom:12}}>×¡××Ÿ ×œ××™×–×• ×©×•×ª×¤×” ××’×™×¢ ×”×—×–×¨ ×¢×‘×•×¨ ×›×œ ×”×•×¦××”. ×”×¡×›×•× ×™×ª××œ× ××•×˜×•××˜×™×ª ×‘×˜×•×¤×¡ ×”×”×¢×‘×¨×”.</p>

                    {/* ×¡×™×›×•× */}
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:14}}>
                        {[['×©×¨×•×Ÿ ğŸ‘©â€âš–ï¸', sharonExpensesTotal,'#ede9fe','#5b21b6'],['××•×¨×™×ª ğŸ‘©â€âš–ï¸', oritExpensesTotal,'#dbeafe','#1d4ed8']].map(([name,total,bg,color])=>(
                            <div key={name} style={{background:bg,borderRadius:8,padding:'10px 14px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                <span style={{fontWeight:600,fontSize:'0.9rem',color}}>{name}</span>
                                <span style={{fontWeight:700,fontSize:'1rem',color}}>â‚ª{Math.round(total).toLocaleString()}</span>
                            </div>
                        ))}
                    </div>

                    <div style={{overflowX:'auto'}}>
                        <table style={{width:'100%',borderCollapse:'collapse',fontSize:'0.82rem'}}>
                            <thead>
                                <tr style={{background:'#f3f4f6',borderBottom:'2px solid #e5e7eb'}}>
                                    {['×ª××¨×™×š','× ×¨×©× ×¢"×™','×œ×§×•×—','×ª×™××•×¨','×¤×¨×™×˜','×¡×›×•×','×©×¨×•×Ÿ','××•×¨×™×ª'].map(h=>(
                                        <th key={h} style={{padding:'8px 10px',textAlign:'right',fontWeight:600,whiteSpace:'nowrap'}}>{h}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {importedExpenses.map((exp,i)=>(
                                    <tr key={exp.id} style={{background:i%2===0?'white':'#f9fafb',borderBottom:'1px solid #e5e7eb'}}>
                                        <td style={{padding:'7px 10px',whiteSpace:'nowrap'}}>{exp.date}</td>
                                        <td style={{padding:'7px 10px',whiteSpace:'nowrap',fontWeight:500,color:'#4b5563'}}>{exp.registeredBy}</td>
                                        <td style={{padding:'7px 10px',maxWidth:160,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{exp.client}</td>
                                        <td style={{padding:'7px 10px',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',color:'#6b7280'}}>{exp.description}</td>
                                        <td style={{padding:'7px 10px',whiteSpace:'nowrap'}}>{exp.item}</td>
                                        <td style={{padding:'7px 10px',fontWeight:600,color:'#166534',whiteSpace:'nowrap'}}>â‚ª{exp.amount.toLocaleString()}</td>
                                        <td style={{padding:'7px 10px',textAlign:'center'}}>
                                            <input type="checkbox" checked={exp.checkedSharon}
                                                onChange={e=>setImportedExpenses(prev=>prev.map((x,j)=>j===i?{...x,checkedSharon:e.target.checked,checkedOrit:e.target.checked?false:x.checkedOrit}:x))}
                                                style={{width:18,height:18,accentColor:'#667eea',cursor:'pointer'}}/>
                                        </td>
                                        <td style={{padding:'7px 10px',textAlign:'center'}}>
                                            <input type="checkbox" checked={exp.checkedOrit}
                                                onChange={e=>setImportedExpenses(prev=>prev.map((x,j)=>j===i?{...x,checkedOrit:e.target.checked,checkedSharon:e.target.checked?false:x.checkedSharon}:x))}
                                                style={{width:18,height:18,accentColor:'#3b82f6',cursor:'pointer'}}/>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            </>)}

            {!selMonth && (
                <div className="card" style={{textAlign:'center',padding:'40px 24px'}}>
                    <div style={{fontSize:'3rem',marginBottom:12}}>ğŸ“Š</div>
                    <h3 style={{fontSize:'1.1rem',fontWeight:600,color:'#374151',marginBottom:8}}>×‘×—×¨ ×—×•×“×© ×œ×”×–× ×ª × ×ª×•× ×™×</h3>
                    <p style={{color:'#9ca3af'}}>×”×˜×‘×œ×” ×”×¨×‘-×©× ×ª×™×ª ××•×¦×’×ª ×œ××˜×”</p>
                </div>
            )}

            {/* â”€â”€ ×˜×‘×œ×ª ×—×œ×•×§×ª ×¨×•×•×—×™× ×¨×‘-×©× ×ª×™×ª â€” ×ª××™×“ ××•×¦×’×ª â”€â”€ */}
            <div className="card">
                <h2 style={{fontSize:'1.05rem',fontWeight:700,color:'#1e3a5f',marginBottom:4}}>ğŸ“Š ×—×œ×•×§×ª ×¨×•×•×—×™× â€” ×”×©×•×•××” ×¨×‘-×©× ×ª×™×ª</h2>
                <p style={{color:'#6b7280',fontSize:'0.8rem',marginBottom:14}}>×¨×•×•×— ×—×•×“×©×™ ×œ×›×œ ×©×•×ª×¤×” (â‚ª)</p>
                <div style={{overflowX:'auto'}}>
                    <table style={{borderCollapse:'collapse',fontSize:'0.83rem',minWidth:700}}>
                        <thead>
                            <tr style={{background:'#f3f4f6',borderBottom:'2px solid #e5e7eb'}}>
                                <th style={{padding:'8px 12px',textAlign:'right',fontWeight:700,position:'sticky',right:0,background:'#f3f4f6',whiteSpace:'nowrap'}}>×—×•×“×©</th>
                                {YEARS.map(y=><th key={y} style={{padding:'8px 16px',textAlign:'center',fontWeight:700,minWidth:95}}>{y}</th>)}
                            </tr>
                        </thead>
                        <tbody>
                            {MONTHS.map((m,mi)=>{
                                const isCur = m.v===selMonth;
                                const bg = isCur?'#fefce8':mi%2===0?'white':'#f9fafb';
                                return (
                                    <tr key={m.v} style={{background:bg}}>
                                        <td style={{padding:'7px 12px',fontWeight:isCur?700:500,position:'sticky',right:0,background:bg,borderBottom:'1px solid #e5e7eb',whiteSpace:'nowrap'}}>
                                            {m.l}{isCur?' â—€':''}
                                        </td>
                                        {YEARS.map(y=>{
                                            const d=data[`${y}-${m.v}`];
                                            const val=parseFloat(d?.profitDistribution||0);
                                            return (
                                                <td key={y} style={{padding:'7px 16px',textAlign:'center',borderBottom:'1px solid #e5e7eb',
                                                    color:val>0?'#1e3a5f':'#d1d5db',fontWeight:val>0?500:400}}>
                                                    {val>0?`â‚ª${val.toLocaleString()}`:'-'}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                );
                            })}
                        </tbody>
                        <tfoot>
                            <tr style={{background:'#ede9fe',borderTop:'2px solid #c4b5fd'}}>
                                <td style={{padding:'8px 12px',fontWeight:700,color:'#5b21b6',position:'sticky',right:0,background:'#ede9fe'}}>×¡×”"×› ×©× ×ª×™</td>
                                {YEARS.map(y=>{
                                    const tot=MONTHS.reduce((s,m)=>s+parseFloat(data[`${y}-${m.v}`]?.profitDistribution||0),0);
                                    return <td key={y} style={{padding:'8px 16px',textAlign:'center',fontWeight:700,color:'#5b21b6'}}>{tot>0?`â‚ª${tot.toLocaleString()}`:'-'}</td>;
                                })}
                            </tr>
                            <tr style={{background:'#dbeafe',borderTop:'1px solid #bfdbfe'}}>
                                <td style={{padding:'8px 12px',fontWeight:700,color:'#1d4ed8',position:'sticky',right:0,background:'#dbeafe'}}>×××•×¦×¢ ×—×•×“×©×™</td>
                                {YEARS.map(y=>{
                                    const vals=MONTHS.map(m=>parseFloat(data[`${y}-${m.v}`]?.profitDistribution||0)).filter(v=>v>0);
                                    const avg=vals.length?vals.reduce((s,v)=>s+v,0)/vals.length:0;
                                    return <td key={y} style={{padding:'8px 16px',textAlign:'center',fontWeight:700,color:'#1d4ed8'}}>{avg>0?`â‚ª${Math.round(avg).toLocaleString()}`:'-'}</td>;
                                })}
                            </tr>
                            <tr style={{background:'#dcfce7',borderTop:'1px solid #bbf7d0'}}>
                                <td style={{padding:'8px 12px',fontWeight:700,color:'#166534',position:'sticky',right:0,background:'#dcfce7'}}>×©×™× ×•×™ ××©× ×” ×§×•×“××ª</td>
                                {YEARS.map((y,i)=>{
                                    if(!i) return <td key={y} style={{padding:'8px 16px',textAlign:'center',color:'#9ca3af'}}>â€”</td>;
                                    const prev=YEARS[i-1];
                                    const cv=MONTHS.map(m=>parseFloat(data[`${y}-${m.v}`]?.profitDistribution||0)).filter(v=>v>0);
                                    const pv=MONTHS.map(m=>parseFloat(data[`${prev}-${m.v}`]?.profitDistribution||0)).filter(v=>v>0);
                                    const ca=cv.length?cv.reduce((s,v)=>s+v,0)/cv.length:0;
                                    const pa=pv.length?pv.reduce((s,v)=>s+v,0)/pv.length:0;
                                    if(!ca||!pa) return <td key={y} style={{padding:'8px 16px',textAlign:'center',color:'#9ca3af'}}>â€”</td>;
                                    const ch=((ca-pa)/pa)*100;
                                    return <td key={y} style={{padding:'8px 16px',textAlign:'center',fontWeight:700,color:ch>=0?'#166534':'#dc2626'}}>{ch>=0?'â–²':'â–¼'}{Math.abs(ch).toFixed(1)}%</td>;
                                })}
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            {showTransfer && (
                <>
                {console.log('=== Opening TransferModal ===')}
                {console.log('sharonExpensesTotal:', sharonExpensesTotal)}
                {console.log('oritExpensesTotal:', oritExpensesTotal)}
                {console.log('cur.sharonExpenses:', cur.sharonExpenses)}
                {console.log('cur.oritExpenses:', cur.oritExpenses)}
                <TransferModal
                    monthLabel={curLabel}
                    profitDistribution={cur.profitDistribution}
                    existingTransfer={curTransfers[0]||null}
                    sharonExpenses={sharonExpensesTotal}
                    oritExpenses={oritExpensesTotal}
                    onSave={saveTransfer}
                    onClose={()=>setShowTransfer(false)}
                />
                </>
            )}
            {showAllTransfers && (
                <AllTransfersModal 
                    monthlyData={data} 
                    selectedYear={selYear}
                    onClose={()=>setShowAllTransfers(false)}
                    onEdit={editTransferFromAll}
                    onDelete={deleteTransferFromAll}
                />
            )}
            {showExpensesModal && (
                <>
                {console.log('=== Opening ExpensesModal ===')}
                {console.log('cur:', cur)}
                {console.log('cur.expenses:', cur.expenses)}
                {console.log('cur.expenses type:', typeof cur.expenses)}
                {console.log('cur.expenses isArray:', Array.isArray(cur.expenses))}
                {console.log('cur.expenses length:', cur.expenses ? cur.expenses.length : 'N/A')}
                {console.log('importedExpenses:', importedExpenses)}
                <ExpensesModal
                    importedExpenses={importedExpenses}
                    odcanitExpenses={cur.expenses || []}
                    savedExpenseRefunds={cur.expenseRefunds || {}}
                    onClose={()=>setShowExpensesModal(false)}
                    onUpdateExpenses={handleUpdateExpenses}
                />
                </>
            )}
            {showReports && (
                <ReportsModal data={data} avgVAT={avgVAT} onClose={()=>setShowReports(false)}/>
            )}
            {showSettings && (
                <Modal title="âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª" onClose={()=>setShowSettings(false)}>
                    <div style={{marginBottom:24,textAlign:'center',padding:'12px',background:'linear-gradient(135deg,#667eea,#764ba2)',borderRadius:8}}>
                        <div style={{color:'white',fontSize:'0.85rem',fontWeight:600}}>
                            ×’×¨×¡×” {APP_VERSION}
                        </div>
                    </div>

                    <div style={{marginBottom:24}}>
                        <h3 style={{fontSize:'0.95rem',fontWeight:700,color:'#374151',marginBottom:12}}>×’×™×‘×•×™ ××•×˜×•××˜×™</h3>
                        <div style={{background:'#f9fafb',padding:'16px',borderRadius:8,border:'1px solid #e5e7eb'}}>
                            <label style={{display:'flex',alignItems:'center',gap:12,cursor:'pointer'}}>
                                <input 
                                    type="checkbox" 
                                    checked={autoBackupEnabled}
                                    onChange={(e) => {
                                        const newValue = e.target.checked;
                                        setAutoBackupEnabled(newValue);
                                        localStorage.setItem('autoBackupEnabled', newValue.toString());
                                    }}
                                    style={{width:18,height:18,cursor:'pointer'}}
                                />
                                <div>
                                    <div style={{fontWeight:600,fontSize:'0.9rem',color:'#1f2937'}}>×”×¤×¢×œ ×’×™×‘×•×™ ××•×˜×•××˜×™</div>
                                    <div style={{fontSize:'0.78rem',color:'#6b7280',marginTop:2}}>×›××©×¨ ××•×¤×¢×œ, ×§×•×‘×¥ ×’×™×‘×•×™ ×™×•×¨×“ ××•×˜×•××˜×™×ª ×‘×›×œ ×©××™×¨×ª ×—×•×“×©</div>
                                </div>
                            </label>
                            {autoBackupEnabled && (
                                <div style={{marginTop:12,padding:12,background:'#fef3c7',borderRadius:6,fontSize:'0.8rem',color:'#92400e'}}>
                                    âœ… ×’×™×‘×•×™ ××•×˜×•××˜×™ ×¤×¢×™×œ - ×§×•×‘×¥ JSON ×™×•×¨×“ ××•×˜×•××˜×™×ª ×œ×ª×™×§×™×™×ª ×”×”×•×¨×“×•×ª ×©×œ×š ×‘×›×œ ×©××™×¨×”
                                </div>
                            )}
                        </div>
                    </div>

                    <div style={{marginBottom:24}}>
                        <h3 style={{fontSize:'0.95rem',fontWeight:700,color:'#374151',marginBottom:12}}>
                            â˜ï¸ ×¡× ×›×¨×•×Ÿ ×¢× GitHub
                            {syncStatus === 'syncing' && <span style={{marginRight:8,fontSize:'0.8rem',color:'#3b82f6'}}>ğŸ”„ ××¡× ×›×¨×Ÿ...</span>}
                            {syncStatus === 'synced' && <span style={{marginRight:8,fontSize:'0.8rem',color:'#10b981'}}>âœ… ×¡×•× ×›×¨×Ÿ</span>}
                            {syncStatus === 'error' && <span style={{marginRight:8,fontSize:'0.8rem',color:'#ef4444'}}>âŒ ×©×’×™××”</span>}
                        </h3>
                        <div style={{background:'#f9fafb',padding:'16px',borderRadius:8,border:'1px solid #e5e7eb'}}>
                            <div style={{marginBottom:12}}>
                                <label style={{display:'block',fontWeight:600,fontSize:'0.85rem',color:'#374151',marginBottom:6}}>
                                    GitHub Personal Access Token
                                </label>
                                <input 
                                    type="password"
                                    className="input-field"
                                    value={githubToken}
                                    onChange={(e) => {
                                        setGithubToken(e.target.value);
                                        localStorage.setItem('githubToken', e.target.value);
                                    }}
                                    placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                                    style={{fontSize:'0.85rem'}}
                                />
                                <div style={{fontSize:'0.75rem',color:'#6b7280',marginTop:4}}>
                                    ×”×˜×•×§×Ÿ × ×©××¨ ××§×•××™×ª ×•××©××© ×œ×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™ ×¢× GitHub
                                </div>
                            </div>
                            
                            <label style={{display:'flex',alignItems:'center',gap:12,cursor:'pointer',marginTop:12}}>
                                <input 
                                    type="checkbox" 
                                    checked={githubSyncEnabled}
                                    onChange={(e) => {
                                        const newValue = e.target.checked;
                                        setGithubSyncEnabled(newValue);
                                        localStorage.setItem('githubSyncEnabled', newValue.toString());
                                        if (newValue && githubToken) {
                                            loadFromGitHub(githubToken);
                                        }
                                    }}
                                    disabled={!githubToken}
                                    style={{width:18,height:18,cursor:'pointer'}}
                                />
                                <div>
                                    <div style={{fontWeight:600,fontSize:'0.9rem',color:'#1f2937'}}>×”×¤×¢×œ ×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™</div>
                                    <div style={{fontSize:'0.78rem',color:'#6b7280',marginTop:2}}>×©××™×¨×” ×•×˜×¢×™× ×” ××•×˜×•××˜×™×ª ×-GitHub</div>
                                </div>
                            </label>
                            
                            {githubSyncEnabled && githubToken && (
                                <div style={{marginTop:12,padding:12,background:'#dbeafe',borderRadius:6,fontSize:'0.8rem',color:'#1e40af'}}>
                                    âœ… ×¡× ×›×¨×•×Ÿ ×¤×¢×™×œ - ×”× ×ª×•× ×™× × ×©××¨×™× ×‘-GitHub ××•×˜×•××˜×™×ª<br/>
                                    ğŸ“ Repository: {GITHUB_CONFIG.owner}/{GITHUB_CONFIG.repo}
                                </div>
                            )}
                            
                            {!githubToken && (
                                <div style={{marginTop:12,padding:12,background:'#fef3c7',borderRadius:6,fontSize:'0.8rem',color:'#92400e'}}>
                                    âš ï¸ ×™×© ×œ×”×›× ×™×¡ GitHub Token ×›×“×™ ×œ×”×¤×¢×™×œ ×¡× ×›×¨×•×Ÿ
                                </div>
                            )}
                        </div>
                    </div>

                    <div style={{marginBottom:24}}>
                        <h3 style={{fontSize:'0.95rem',fontWeight:700,color:'#374151',marginBottom:12}}>×™×™×‘×•× × ×ª×•× ×™×</h3>
                        <div style={{display:'grid',gap:12}}>
                            <div>
                                <input ref={fileInputRef} type="file" accept=".xlsx,.xls" style={{display:'none'}} onChange={handleExcelImport}/>
                                <button onClick={()=>fileInputRef.current.click()}
                                    style={{width:'100%',padding:'12px 16px',borderRadius:8,border:'1px solid #d1fae5',background:'linear-gradient(135deg,#dcfce7,#bbf7d0)',color:'#065f46',fontWeight:600,cursor:'pointer',fontSize:'0.9rem',textAlign:'right',display:'flex',alignItems:'center',gap:10}}>
                                    <span style={{fontSize:'1.2rem'}}>ğŸ“Š</span>
                                    <div style={{flex:1,textAlign:'right'}}>
                                        <div style={{fontWeight:700}}>×™×™×‘×•× ×—×™×•×‘×™× ×××§×¡×œ</div>
                                        <div style={{fontSize:'0.75rem',opacity:0.8,marginTop:2}}>×§×•×‘×¥ ×—×™×•×‘×™× ×•×©×¢×•×ª ×¢×‘×•×“×”</div>
                                    </div>
                                </button>
                            </div>
                            <div>
                                <input ref={fileInputRef2} type="file" accept=".xlsx,.xls" style={{display:'none'}} onChange={handleInvoicesImport}/>
                                <button onClick={()=>fileInputRef2.current.click()}
                                    style={{width:'100%',padding:'12px 16px',borderRadius:8,border:'1px solid #fde68a',background:'linear-gradient(135deg,#fef3c7,#fde68a)',color:'#78350f',fontWeight:600,cursor:'pointer',fontSize:'0.9rem',textAlign:'right',display:'flex',alignItems:'center',gap:10}}>
                                    <span style={{fontSize:'1.2rem'}}>ğŸ“„</span>
                                    <div style={{flex:1,textAlign:'right'}}>
                                        <div style={{fontWeight:700}}>×™×™×‘×•× ×—×©×‘×•× ×™×•×ª ×××§×¡×œ</div>
                                        <div style={{fontSize:'0.75rem',opacity:0.8,marginTop:2}}>×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ××—×©×‘×•× ×™×ª</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div style={{marginBottom:24}}>
                        <h3 style={{fontSize:'0.95rem',fontWeight:700,color:'#374151',marginBottom:12}}>× ×™×”×•×œ × ×ª×•× ×™×</h3>
                        <div style={{display:'grid',gap:12}}>
                            <button onClick={()=>{loadHistoricalData(); setShowSettings(false);}}
                                style={{padding:'12px 16px',borderRadius:8,border:'1px solid #fef3c7',background:'linear-gradient(135deg,#fef3c7,#fde68a)',color:'#78350f',fontWeight:600,cursor:'pointer',fontSize:'0.9rem',textAlign:'right',display:'flex',alignItems:'center',gap:10}}>
                                <span style={{fontSize:'1.2rem'}}>ğŸ“¥</span>
                                <div style={{flex:1,textAlign:'right'}}>
                                    <div style={{fontWeight:700}}>×˜×¢×Ÿ × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</div>
                                    <div style={{fontSize:'0.75rem',opacity:0.8,marginTop:2}}>60 ×—×•×“×©×™× ×©×œ × ×ª×•× ×™× (2021-2026)</div>
                                </div>
                            </button>
                            <button onClick={()=>{handleBackup(); setShowSettings(false);}}
                                style={{padding:'12px 16px',borderRadius:8,border:'1px solid #d1fae5',background:'linear-gradient(135deg,#f0fdf4,#dcfce7)',color:'#065f46',fontWeight:600,cursor:'pointer',fontSize:'0.9rem',textAlign:'right',display:'flex',alignItems:'center',gap:10}}>
                                <span style={{fontSize:'1.2rem'}}>â¬‡ï¸</span>
                                <div style={{flex:1,textAlign:'right'}}>
                                    <div style={{fontWeight:700}}>×’×™×‘×•×™ ×™×“× ×™</div>
                                    <div style={{fontSize:'0.75rem',opacity:0.8,marginTop:2}}>×”×•×¨×“ ×§×•×‘×¥ ×’×™×‘×•×™ ×©×œ ×›×œ ×”× ×ª×•× ×™×</div>
                                </div>
                            </button>
                            <div>
                                <input ref={fileRestoreRef} type="file" accept=".json" style={{display:'none'}} onChange={handleRestore}/>
                                <button onClick={()=>fileRestoreRef.current.click()}
                                    style={{width:'100%',padding:'12px 16px',borderRadius:8,border:'1px solid #fecaca',background:'linear-gradient(135deg,#fef2f2,#fee2e2)',color:'#991b1b',fontWeight:600,cursor:'pointer',fontSize:'0.9rem',textAlign:'right',display:'flex',alignItems:'center',gap:10}}>
                                    <span style={{fontSize:'1.2rem'}}>â¬†ï¸</span>
                                    <div style={{flex:1,textAlign:'right'}}>
                                        <div style={{fontWeight:700}}>×©×—×–×•×¨ ××’×™×‘×•×™</div>
                                        <div style={{fontSize:'0.75rem',opacity:0.8,marginTop:2}}>×˜×¢×Ÿ ×§×•×‘×¥ ×’×™×‘×•×™ ×§×™×™×</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div style={{display:'flex',justifyContent:'flex-end',borderTop:'1px solid #e5e7eb',paddingTop:16}}>
                        <button onClick={()=>setShowSettings(false)} 
                            style={{padding:'10px 24px',borderRadius:8,border:'none',background:'#3b82f6',color:'white',cursor:'pointer',fontWeight:700}}>
                            ×¡×’×•×¨
                        </button>
                    </div>
                </Modal>
            )}
        </div>
    );
}

// Wait for all libraries to load, then render
if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined') {
    document.getElementById('loading').style.display = 'none';
    ReactDOM.render(<App/>, document.getElementById('root'));
} else {
    console.error('React or ReactDOM not loaded!');
    document.getElementById('loading').innerHTML = 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¢×¨×›×ª. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£ (F5)';
}
</script>
</body>
</html>
